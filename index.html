<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>íˆ¬ì–´ë¹„ìŠ¤ í•­ê³µ(êµ­ì œì„ ) Missing Call ì²˜ë¦¬ ì‹œìŠ¤í…œ</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- ì—°ê²° ìƒíƒœ í‘œì‹œ -->
    <div id="connectionStatus" class="connection-status">
        <span id="connectionText">ì—°ê²° í™•ì¸ ì¤‘...</span>
    </div>

    <!-- ë¡œë”© í™”ë©´ -->
    <div id="initialLoading" class="login-container">
        <div class="login-box text-center">
            <h2>ğŸš€ ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì¤‘...</h2>
            <div class="loading">
                ì„¤ì •ì„ í™•ì¸í•˜ê³  ìˆìŠµë‹ˆë‹¤<span class="spinner"></span>
            </div>
            <div id="initStatus" class="text-small mt-20">
                <!-- ì´ˆê¸°í™” ìƒíƒœ ë©”ì‹œì§€ -->
            </div>
        </div>
    </div>

    <!-- ë¡œê·¸ì¸ í™”ë©´ -->
    <div id="loginContainer" class="login-container hidden">
        <div class="login-box">
            <div class="login-header">
                <h1>íˆ¬ì–´ë¹„ìŠ¤</h1>
                <p>í•­ê³µ(êµ­ì œì„ ) Missing Call ì²˜ë¦¬ ì‹œìŠ¤í…œ</p>
            </div>
            
            <form id="loginForm">
                <div class="form-group">
                    <label for="loginUsername">ì‚¬ìš©ì ID</label>
                    <input type="text" id="loginUsername" required autocomplete="username" placeholder="ì‚¬ìš©ì IDë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                </div>
                
                <div class="form-group">
                    <label for="loginPassword">ë¹„ë°€ë²ˆí˜¸</label>
                    <div class="password-container">
                        <input type="password" id="loginPassword" required autocomplete="current-password" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                        <button type="button" class="password-toggle" onclick="togglePassword('loginPassword')">ğŸ‘ï¸</button>
                    </div>
                </div>
                
                <div class="checkbox-group">
                    <input type="checkbox" id="rememberMe">
                    <label for="rememberMe">ë¡œê·¸ì¸ ìƒíƒœ ìœ ì§€ (7ì¼)</label>
                </div>
                
                <button type="submit" class="btn btn-primary">
                    <span id="loginBtnText">ë¡œê·¸ì¸</span>
                </button>
                
                <button type="button" class="btn btn-secondary mt-10" onclick="openAccountRequestModal()" style="width: 100%;">
                    ğŸ“§ ê³„ì • ì‹ ì²­
                </button>
            </form>
            
            <div id="loginError" class="alert alert-error hidden"></div>
            
            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee; font-size: 0.85rem; color: #666; text-align: center;">
                Â© 2025 TideSquare. All rights reserved.<br>
                <span class="text-small">ê³„ì • ë¬¸ì˜: ê¹€ì˜í›ˆ ë‹´ë‹¹ì</span>
            </div>
        </div>
    </div>

    <!-- ë©”ì¸ ëŒ€ì‹œë³´ë“œ -->
    <div id="mainContainer" class="main-container">
        <div class="header">
            <h1>íˆ¬ì–´ë¹„ìŠ¤ Missing Call ê´€ë¦¬ ì‹œìŠ¤í…œ</h1>
            <div class="user-info">
                <span class="user-name" id="currentUserName">ì‚¬ìš©ì</span>
                <span class="user-role" id="currentUserRole">ê¶Œí•œ</span>
                <button class="btn btn-secondary btn-small" onclick="logout()" title="ì‹œìŠ¤í…œì—ì„œ ë¡œê·¸ì•„ì›ƒ">ğŸšª ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </div>

        <div class="nav-menu">
            <div class="nav-buttons">
                <button class="nav-btn active" onclick="showSection('dashboard')">ğŸ“Š ëŒ€ì‹œë³´ë“œ</button>
                <button class="nav-btn hidden" onclick="showSection('users')" id="usersMenuBtn">ğŸ‘¥ ì‚¬ìš©ì ê´€ë¦¬</button>
                <button class="nav-btn hidden" onclick="showSection('requests')" id="requestsMenuBtn">ğŸ“‹ ê³„ì • ì‹ ì²­ ê´€ë¦¬</button>
            </div>
        </div>

        <div class="content">
            <!-- ëŒ€ì‹œë³´ë“œ ì„¹ì…˜ -->
            <div id="dashboardSection" class="section active">
                <div class="section-header">
                    <h2>Missing Call ì²˜ë¦¬ í˜„í™©</h2>
                    <div>
                        <button class="btn btn-secondary btn-small" onclick="refreshConnection()">ğŸ”„ ì—°ê²° í™•ì¸</button>
                    </div>
                </div>
                
                <div class="search-section">
                    <div class="search-form">
                        <div class="form-group">
                            <label for="searchDate">ì¡°íšŒ ì¼ì</label>
                            <input type="date" id="searchDate">
                        </div>
                        <div class="form-group">
                            <label for="processFilter">ì²˜ë¦¬ ìƒíƒœ</label>
                            <select id="processFilter">
                                <option value="all">ì „ì²´</option>
                                <option value="processed">ì²˜ë¦¬ ì™„ë£Œ</option>
                                <option value="pending">ë¯¸ì²˜ë¦¬</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <button type="button" class="btn btn-primary" onclick="searchCalls()">
                                ğŸ“‹ ì¡°íšŒ
                            </button>
                        </div>
                    </div>
                </div>

                <div id="loadingMessage" class="loading hidden">
                    ë°ì´í„°ë¥¼ ì¡°íšŒí•˜ê³  ìˆìŠµë‹ˆë‹¤<span class="spinner"></span>
                </div>

                <div id="callsResults" class="hidden">
                    <div style="margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                        <h3 id="resultsCount" style="color: #333; margin: 0;">ì¡°íšŒ ê²°ê³¼</h3>
                        <div>
                            <button class="btn btn-secondary btn-small" onclick="searchCalls()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
                            <button class="btn btn-primary btn-small" onclick="exportToCSV()" style="margin-left: 10px;">ğŸ“¥ CSV ë‚´ë³´ë‚´ê¸°</button>
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <table id="callsTable">
                            <thead>
                                <tr>
                                    <th>ë°œìƒì¼</th>
                                    <th>ì¸ì…ì‹œê°„</th>
                                    <th>ëŒ€ê¸°ì‹œê°„(ë¶„)</th>
                                    <th>ì „í™”ë²ˆí˜¸</th>
                                    <th>ì¸ì…í</th>
                                    <th>ì¤‘ë³µíšŸìˆ˜</th>
                                    <th>ì²˜ë¦¬ìƒíƒœ</th>
                                    <th>ì²˜ë¦¬ë‹´ë‹¹ì</th>
                                    <th>ì•¡ì…˜</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <div id="noDataMessage" class="text-center hidden" style="padding: 40px; color: #666;">
                    <h3 id="noDataTitle">ğŸ“­ ì¡°íšŒëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</h3>
                    <p id="noDataSubtitle">ë‹¤ë¥¸ ë‚ ì§œë¥¼ ì„ íƒí•˜ê±°ë‚˜ í•„í„° ì¡°ê±´ì„ ë³€ê²½í•´ë³´ì„¸ìš”.</p>
                </div>
            </div>

            <!-- ì‚¬ìš©ì ê´€ë¦¬ ì„¹ì…˜ -->
            <div id="usersSection" class="section">
                <div class="section-header">
                    <h2>ì‚¬ìš©ì ê´€ë¦¬</h2>
                    <button class="btn btn-primary" onclick="openUserModal()">â• ìƒˆ ì‚¬ìš©ì ì¶”ê°€</button>
                </div>

                <div id="usersLoading" class="loading hidden">
                    ì‚¬ìš©ì ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ê³  ìˆìŠµë‹ˆë‹¤<span class="spinner"></span>
                </div>

                <div id="usersResults" class="table-container">
                    <table id="usersTable">
                        <thead>
                            <tr>
                                <th>ì‚¬ìš©ì ID</th>
                                <th>ì‹¤ëª…</th>
                                <th>ì´ë©”ì¼</th>
                                <th>ê¶Œí•œ</th>
                                <th>ìƒíƒœ</th>
                                <th>ë“±ë¡ì¼</th>
                                <th>ë§ˆì§€ë§‰ ë¡œê·¸ì¸</th>
                                <th>ì•¡ì…˜</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- ê³„ì • ì‹ ì²­ ê´€ë¦¬ ì„¹ì…˜ -->
            <div id="requestsSection" class="section">
                <div class="section-header">
                    <h2>ê³„ì • ì‹ ì²­ ê´€ë¦¬</h2>
                    <button class="btn btn-secondary" onclick="loadRequestsSection()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
                </div>

                <div id="requestsLoading" class="loading hidden">
                    ê³„ì • ì‹ ì²­ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ê³  ìˆìŠµë‹ˆë‹¤<span class="spinner"></span>
                </div>

                <div id="requestsResults" class="table-container">
                    <table id="requestsTable">
                        <thead>
                            <tr>
                                <th>ì‹ ì²­ì¼</th>
                                <th>ì‹ ì²­ì</th>
                                <th>ì´ë©”ì¼</th>
                                <th>ì—°ë½ì²˜</th>
                                <th>ë¶€ì„œ/íŒ€</th>
                                <th>ìš”ì²­ ê¶Œí•œ</th>
                                <th>í¬ë§ ID</th>
                                <th>ìƒíƒœ</th>
                                <th>ì•¡ì…˜</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <div id="noRequestsMessage" class="text-center hidden" style="padding: 40px; color: #666;">
                    <h3>ğŸ“­ ëŒ€ê¸° ì¤‘ì¸ ê³„ì • ì‹ ì²­ì´ ì—†ìŠµë‹ˆë‹¤</h3>
                    <p>ìƒˆë¡œìš´ ì‹ ì²­ì´ ì ‘ìˆ˜ë˜ë©´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ì‚¬ìš©ì ë“±ë¡/ìˆ˜ì • ëª¨ë‹¬ -->
    <div id="userModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="userModalTitle">ì‚¬ìš©ì ì¶”ê°€</h3>
            </div>
            
            <form id="userForm">
                <input type="hidden" id="userId">
                
                <div class="form-group">
                    <label for="userUsername">ì‚¬ìš©ì ID *</label>
                    <input type="text" id="userUsername" required placeholder="ì˜ë¬¸/ìˆ«ìë¡œ ì…ë ¥í•˜ì„¸ìš”" autocomplete="username">
                </div>
                
                <div class="form-group">
                    <label for="userPassword">ë¹„ë°€ë²ˆí˜¸ *</label>
                    <div class="password-container">
                        <input type="password" id="userPassword" placeholder="6ì ì´ìƒ ì…ë ¥í•˜ì„¸ìš”" autocomplete="new-password">
                        <button type="button" class="password-toggle" onclick="togglePassword('userPassword')">ğŸ‘ï¸</button>
                    </div>
                    <small class="text-small">ìˆ˜ì •ì‹œ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë³€ê²½í•˜ì§€ ì•Šìœ¼ë ¤ë©´ ë¹„ì›Œë‘ì„¸ìš”</small>
                </div>
                
                <div class="form-group">
                    <label for="userName">ì‹¤ëª… *</label>
                    <input type="text" id="userName" required placeholder="ì‹¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”" autocomplete="name">
                </div>
                
                <div class="form-group">
                    <label for="userEmail">ì´ë©”ì¼ *</label>
                    <input type="email" id="userEmail" required placeholder="email@example.com" autocomplete="email">
                </div>
                
                <div class="form-group">
                    <label for="userRole">ê¶Œí•œ *</label>
                    <select id="userRole" required>
                        <option value="">ê¶Œí•œì„ ì„ íƒí•˜ì„¸ìš”</option>
                        <option value="user">ì¼ë°˜ ì‚¬ìš©ì</option>
                        <option value="manager">ê´€ë¦¬ì</option>
                        <option value="admin">ì‹œìŠ¤í…œ ê´€ë¦¬ì</option>
                    </select>
                </div>
            </form>

            <div id="userModalError" class="alert alert-error hidden"></div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeUserModal()">ì·¨ì†Œ</button>
                <button type="button" class="btn btn-success" onclick="saveUser()">
                    <span id="userSaveBtnText">ğŸ’¾ ì €ì¥</span>
                </button>
            </div>
        </div>
    </div>

    <!-- ê³„ì • ì‹ ì²­ ìŠ¹ì¸ ëª¨ë‹¬ -->
    <div id="approvalModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>âœ… ê³„ì • ì‹ ì²­ ìŠ¹ì¸</h3>
                <p style="color: #666; margin: 5px 0 0 0;">
                    ì‹ ì²­ì: <span id="approvalRequestName" class="font-bold"></span><br>
                    <span id="approvalRequestInfo" style="font-size: 0.9rem;"></span>
                </p>
            </div>
            
            <form id="approvalForm">
                <input type="hidden" id="approvalRequestId">
                
                <div class="form-group">
                    <label for="approvalUsername">ì‚¬ìš©ì ID *</label>
                    <input type="text" id="approvalUsername" required placeholder="ì˜ë¬¸/ìˆ«ìë¡œ ì…ë ¥í•˜ì„¸ìš”">
                    <small class="text-small">ì‹ ì²­ìê°€ ìš”ì²­í•œ IDë¥¼ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</small>
                </div>
                
                <div class="form-group">
                    <label for="approvalPassword">ì„ì‹œ ë¹„ë°€ë²ˆí˜¸ *</label>
                    <div class="password-container">
                        <input type="password" id="approvalPassword" required placeholder="6ì ì´ìƒ ì…ë ¥í•˜ì„¸ìš”">
                        <button type="button" class="password-toggle" onclick="togglePassword('approvalPassword')">ğŸ‘ï¸</button>
                    </div>
                    <small class="text-small">ì‚¬ìš©ìê°€ ì²« ë¡œê·¸ì¸ í›„ ë³€ê²½í•˜ë„ë¡ ì•ˆë‚´í•˜ì„¸ìš”.</small>
                </div>
                
                <div class="form-group">
                    <label for="approvalNote">ìŠ¹ì¸ ë©”ëª¨ (ì„ íƒ)</label>
                    <textarea id="approvalNote" rows="2" placeholder="ìŠ¹ì¸ ì‹œ íŠ¹ì´ì‚¬í•­ì´ë‚˜ ì „ë‹¬ ë©”ì‹œì§€"></textarea>
                </div>
            </form>

            <div id="approvalModalError" class="alert alert-error hidden"></div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeApprovalModal()">ì·¨ì†Œ</button>
                <button type="button" class="btn btn-success" onclick="approveAccountRequest()">
                    <span id="approvalSaveBtnText">âœ… ìŠ¹ì¸ ë° ê³„ì • ìƒì„±</span>
                </button>
            </div>
        </div>
    </div>

    <!-- OBì½œ ì²˜ë¦¬ ëª¨ë‹¬ -->
    <div id="processModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ğŸ“ OBì½œ ì²˜ë¦¬</h3>
                <p style="color: #666; margin: 5px 0 0 0;">
                    ì „í™”ë²ˆí˜¸: <span id="modalPhoneNumber" class="phone-number"></span><br>
                    <span id="modalCallInfo" style="font-size: 0.9rem;"></span>
                </p>
            </div>
            
            <form id="processForm">
                <div class="form-group">
                    <label for="processStatus">ì²˜ë¦¬ ì—¬ë¶€ *</label>
                    <select id="processStatus" required>
                        <option value="">ì„ íƒí•´ì£¼ì„¸ìš”</option>
                        <option value="ì™„ë£Œ">âœ… ì™„ë£Œ</option>
                        <option value="ë¯¸ì™„ë£Œ">âŒ ë¯¸ì™„ë£Œ</option>
                        <option value="ë³´ë¥˜">â¸ï¸ ë³´ë¥˜</option>
                        <option value="ì¬ì‹œë„">ğŸ”„ ì¬ì‹œë„ í•„ìš”</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="processManager">ì²˜ë¦¬ë‹´ë‹¹ì *</label>
                    <input type="text" id="processManager" required placeholder="ë‹´ë‹¹ìëª…ì„ ì…ë ¥í•˜ì„¸ìš”" autocomplete="name">
                </div>

                <div class="form-group">
                    <label for="processNote">ì²˜ë¦¬ ë©”ëª¨ (ì„ íƒ)</label>
                    <textarea id="processNote" rows="3" placeholder="ì²˜ë¦¬ ë‚´ìš©ì´ë‚˜ íŠ¹ì´ì‚¬í•­ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                </div>
            </form>

            <div id="processModalError" class="alert alert-error hidden"></div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeProcessModal()">ì·¨ì†Œ</button>
                <button type="button" class="btn btn-success" onclick="saveProcess()">
                    <span id="processSaveBtnText">ğŸ’¾ ì²˜ë¦¬ ì™„ë£Œ</span>
                </button>
            </div>
        </div>
    </div>

    <!-- ê³„ì • ì‹ ì²­ ëª¨ë‹¬ -->
    <div id="accountRequestModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ğŸ“§ ê³„ì • ì‹ ì²­</h3>
                <p style="color: #666; margin: 5px 0 0 0; font-size: 0.9rem;">
                    ì‹ ì²­ì„œë¥¼ ì‘ì„±í•´ì£¼ì‹œë©´ ê´€ë¦¬ìê°€ ê²€í†  í›„ ê³„ì •ì„ ìƒì„±í•´ ë“œë¦½ë‹ˆë‹¤.
                </p>
            </div>
            
            <form id="accountRequestForm">
                <div class="form-group">
                    <label for="requestName">ì„±ëª… *</label>
                    <input type="text" id="requestName" required placeholder="ì‹¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”" autocomplete="name">
                </div>
                
                <div class="form-group">
                    <label for="requestEmail">ì´ë©”ì¼ *</label>
                    <input type="email" id="requestEmail" required placeholder="email@company.com" autocomplete="email">
                </div>
                
                <div class="form-group">
                    <label for="requestPhone">ì—°ë½ì²˜ *</label>
                    <input type="tel" id="requestPhone" required placeholder="010-0000-0000" autocomplete="tel">
                </div>
                
                <div class="form-group">
                    <label for="requestDepartment">ë¶€ì„œ/íŒ€ *</label>
                    <input type="text" id="requestDepartment" required placeholder="ì†Œì† ë¶€ì„œë‚˜ íŒ€ì„ ì…ë ¥í•˜ì„¸ìš”">
                </div>
                
                <div class="form-group">
                    <label for="requestPosition">ì§ê¸‰/ì§ì±…</label>
                    <input type="text" id="requestPosition" placeholder="ì§ê¸‰ì´ë‚˜ ì§ì±…ì„ ì…ë ¥í•˜ì„¸ìš”">
                </div>
                
                <div class="form-group">
                    <label for="requestRole">ìš”ì²­ ê¶Œí•œ *</label>
                    <select id="requestRole" required>
                        <option value="">ê¶Œí•œì„ ì„ íƒí•˜ì„¸ìš”</option>
                        <option value="user">ì¼ë°˜ ì‚¬ìš©ì (ì¡°íšŒ ë° ì²˜ë¦¬ë§Œ ê°€ëŠ¥)</option>
                        <option value="manager">ê´€ë¦¬ì (ì‚¬ìš©ì ê´€ë¦¬ í¬í•¨)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="requestReason">ì‹ ì²­ ì‚¬ìœ  *</label>
                    <textarea id="requestReason" rows="3" required placeholder="ê³„ì •ì´ í•„ìš”í•œ ì—…ë¬´ìƒ ì‚¬ìœ ë¥¼ ê°„ë‹¨íˆ ì„¤ëª…í•´ì£¼ì„¸ìš”"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="requestUserId">í¬ë§ ì‚¬ìš©ì ID</label>
                    <input type="text" id="requestUserId" placeholder="ì˜ë¬¸/ìˆ«ì ì¡°í•© (ë¹„ì›Œë‘ë©´ ìë™ ìƒì„±)">
                    <small class="text-small">ë¹„ì›Œë‘ì‹œë©´ ê´€ë¦¬ìê°€ ì ì ˆí•œ IDë¡œ ìƒì„±í•´ ë“œë¦½ë‹ˆë‹¤.</small>
                </div>
            </form>

            <div id="accountRequestError" class="alert alert-error hidden"></div>
            <div id="accountRequestSuccess" class="alert alert-success hidden"></div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeAccountRequestModal()">ì·¨ì†Œ</button>
                <button type="button" class="btn btn-primary" onclick="submitAccountRequest()">
                    <span id="accountRequestBtnText">ğŸ“§ ì‹ ì²­ì„œ ì œì¶œ</span>
                </button>
            </div>
        </div>
    </div>

    <!-- config.js íŒŒì¼ ë¡œë“œ -->
    <script src="config.js"></script>
    
    <script>
        // ì „ì—­ ë³€ìˆ˜
        let currentUser = null;
        let currentCallsData = [];
        let currentUsersData = [];
        let currentRequestsData = [];
        let currentProcessingCall = null;
        let connectionCheckInterval = null;

        // í˜ì´ì§€ ë¡œë“œì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        // ì•± ì´ˆê¸°í™”
        async function initializeApp() {
            Utils.debugLog('ì•± ì´ˆê¸°í™” ì‹œì‘');
            
            try {
                // ì´ˆê¸°í™” ìƒíƒœ í‘œì‹œ
                updateInitStatus('ì„¤ì • íŒŒì¼ ê²€ì¦ ì¤‘...');
                
                // ì„¤ì • ê²€ì¦
                if (!validateConfig()) {
                    showError('ì„¤ì • íŒŒì¼ì— ì˜¤ë¥˜ê°€ ìˆìŠµë‹ˆë‹¤. config.jsë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.');
                    return;
                }

                updateInitStatus('ì—°ê²° í…ŒìŠ¤íŠ¸ ì¤‘...');
                
                // Apps Script ì—°ê²° í…ŒìŠ¤íŠ¸
                if (CONFIG.API.API_TYPE === 'apps_script') {
                    try {
                        const result = await GoogleAppsScriptAPI.testConnection();
                        if (result.success) {
                            showConnectionStatus('connected', 'âœ… ì—°ê²°ë¨');
                            Utils.debugLog('âœ… Apps Script ì—°ê²° í…ŒìŠ¤íŠ¸ ì„±ê³µ');
                        } else {
                            showConnectionStatus('disconnected', 'âŒ ì—°ê²° ì‹¤íŒ¨');
                            Utils.debugLog('âš ï¸ Apps Script ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨:', result.message);
                        }
                    } catch (error) {
                        showConnectionStatus('disconnected', 'âŒ ì—°ê²° ì‹¤íŒ¨');
                        Utils.debugLog('âš ï¸ Apps Script ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨:', error.message);
                    }
                }

                updateInitStatus('ì„¸ì…˜ í™•ì¸ ì¤‘...');

                // ì„¸ì…˜ í™•ì¸
                const session = SessionManager.getSession();
                if (session) {
                    Utils.debugLog('ê¸°ì¡´ ì„¸ì…˜ ë°œê²¬:', session.username);
                    await loginSuccess(session);
                } else {
                    showLoginScreen();
                }

                // ì˜¤ëŠ˜ ë‚ ì§œë¡œ ì„¤ì •
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('searchDate').value = today;
                
                // ê¸°ë³¸ í•„í„° ì„¤ì •
                document.getElementById('processFilter').value = 'all';

                // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
                setupEventListeners();

                // ì£¼ê¸°ì  ì—°ê²° í™•ì¸ ì‹œì‘
                startConnectionMonitoring();

            } catch (error) {
                Utils.debugLog('ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
                showError('ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        // ì´ˆê¸°í™” ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateInitStatus(message) {
            const statusEl = document.getElementById('initStatus');
            if (statusEl) {
                statusEl.textContent = message;
            }
        }

        // ì—°ê²° ìƒíƒœ í‘œì‹œ
        function showConnectionStatus(status, text) {
            const statusEl = document.getElementById('connectionStatus');
            const textEl = document.getElementById('connectionText');
            
            statusEl.className = `connection-status ${status} show`;
            textEl.textContent = text;
            
            // 3ì´ˆ í›„ ìë™ ìˆ¨ê¹€ (ì—°ê²°ë¨ ìƒíƒœë§Œ)
            if (status === 'connected') {
                setTimeout(() => {
                    statusEl.classList.remove('show');
                }, 3000);
            }
        }

        // ì—°ê²° ëª¨ë‹ˆí„°ë§ ì‹œì‘
        function startConnectionMonitoring() {
            // 5ë¶„ë§ˆë‹¤ ì—°ê²° ìƒíƒœ í™•ì¸
            connectionCheckInterval = setInterval(async () => {
                try {
                    const result = await GoogleAppsScriptAPI.testConnection();
                    if (!result.success) {
                        showConnectionStatus('disconnected', 'âŒ ì—°ê²° ëŠê¹€');
                    }
                } catch (error) {
                    showConnectionStatus('disconnected', 'âŒ ì—°ê²° ëŠê¹€');
                }
            }, 5 * 60 * 1000); // 5ë¶„
        }

        // ì—°ê²° ìƒˆë¡œê³ ì¹¨
        async function refreshConnection() {
            showConnectionStatus('testing', 'ğŸ”„ ì—°ê²° í™•ì¸ ì¤‘...');
            
            try {
                const result = await GoogleAppsScriptAPI.testConnection();
                if (result.success) {
                    showConnectionStatus('connected', 'âœ… ì—°ê²° ë³µêµ¬ë¨');
                } else {
                    showConnectionStatus('disconnected', 'âŒ ì—°ê²° ì‹¤íŒ¨');
                    alert('âŒ ì—°ê²° í™•ì¸ ì‹¤íŒ¨: ' + result.message);
                }
            } catch (error) {
                showConnectionStatus('disconnected', 'âŒ ì—°ê²° ì‹¤íŒ¨');
                alert('âŒ ì—°ê²° í™•ì¸ ì‹¤íŒ¨: ' + error.message);
            }
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        function setupEventListeners() {
            // ë¡œê·¸ì¸ í¼
            document.getElementById('loginForm').addEventListener('submit', function(e) {
                e.preventDefault();
                handleLogin();
            });

            // ì‚¬ìš©ì í¼
            document.getElementById('userForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveUser();
            });

            // ì²˜ë¦¬ í¼
            document.getElementById('processForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveProcess();
            });

            // ê³„ì • ì‹ ì²­ í¼
            document.getElementById('accountRequestForm').addEventListener('submit', function(e) {
                e.preventDefault();
                submitAccountRequest();
            });

            // ìŠ¹ì¸ í¼
            document.getElementById('approvalForm').addEventListener('submit', function(e) {
                e.preventDefault();
                approveAccountRequest();
            });

            // Enter í‚¤ ì²˜ë¦¬
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    const activeModal = document.querySelector('.modal.show');
                    if (activeModal) {
                        const primaryButton = activeModal.querySelector('.btn-success, .btn-primary');
                        if (primaryButton && !primaryButton.disabled) {
                            primaryButton.click();
                        }
                    }
                }
                
                // ESC í‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸°
                if (e.key === 'Escape') {
                    const openModal = document.querySelector('.modal.show');
                    if (openModal) {
                        closeModal(openModal);
                    }
                }
            });

            // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ì‹œ ë‹«ê¸°
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('modal')) {
                    closeModal(e.target);
                }
            });

            // í˜ì´ì§€ ì–¸ë¡œë“œì‹œ ì •ë¦¬
            window.addEventListener('beforeunload', function() {
                if (connectionCheckInterval) {
                    clearInterval(connectionCheckInterval);
                }
            });
        }

        // ì˜¤ë¥˜ í‘œì‹œ
        function showError(message) {
            document.getElementById('initialLoading').innerHTML = `
                <div class="login-box text-center">
                    <h2 style="color: #dc2626;">âŒ ì˜¤ë¥˜ ë°œìƒ</h2>
                    <div class="alert alert-error">${message}</div>
                    <button class="btn btn-primary mt-20" onclick="location.reload()">ğŸ”„ ë‹¤ì‹œ ì‹œë„</button>
                </div>
            `;
        }

        // ë¡œê·¸ì¸ ì²˜ë¦¬
        async function handleLogin() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            const rememberMe = document.getElementById('rememberMe').checked;

            if (!username || !password) {
                showAlert('loginError', 'ì‚¬ìš©ì IDì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            try {
                Utils.debugLog('ë¡œê·¸ì¸ ì‹œë„:', username);
                
                // ë²„íŠ¼ ìƒíƒœ ë³€ê²½
                const loginBtn = document.querySelector('#loginForm .btn-primary');
                const btnText = document.getElementById('loginBtnText');
                loginBtn.disabled = true;
                btnText.textContent = 'ë¡œê·¸ì¸ ì¤‘...';
                
                // ì‚¬ìš©ì ì¸ì¦ (Apps Scriptì˜ authenticate ì•¡ì…˜ ì‚¬ìš©)
                const result = await GoogleAppsScriptAPI.request('authenticate', { username, password });
                
                if (result.success && result.user) {
                    // ì„¸ì…˜ ìƒì„±
                    SessionManager.setSession(result.user, rememberMe);
                    await loginSuccess(result.user);
                } else {
                    showAlert('loginError', result.error || 'ì‚¬ìš©ì ID ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'error');
                }
            } catch (error) {
                Utils.debugLog('ë¡œê·¸ì¸ ì˜¤ë¥˜:', error);
                showAlert('loginError', 'ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
            } finally {
                // ë²„íŠ¼ ë³µì›
                const loginBtn = document.querySelector('#loginForm .btn-primary');
                const btnText = document.getElementById('loginBtnText');
                loginBtn.disabled = false;
                btnText.textContent = 'ë¡œê·¸ì¸';
            }
        }

        // ë¡œê·¸ì¸ ì„±ê³µ ì²˜ë¦¬
        async function loginSuccess(user) {
            currentUser = user;
            
            // UI ì—…ë°ì´íŠ¸
            document.getElementById('currentUserName').textContent = user.name;
            document.getElementById('currentUserRole').textContent = getRoleDisplayName(user.role);
            
            // ê¶Œí•œì— ë”°ë¥¸ ë©”ë‰´ í‘œì‹œ
            const usersMenuBtn = document.getElementById('usersMenuBtn');
            const requestsMenuBtn = document.getElementById('requestsMenuBtn');
            
            if (SessionManager.hasRole('manager')) {
                usersMenuBtn.classList.remove('hidden');
                requestsMenuBtn.classList.remove('hidden');
            } else {
                usersMenuBtn.classList.add('hidden');
                requestsMenuBtn.classList.add('hidden');
            }

            // í™”ë©´ ì „í™˜
            document.getElementById('initialLoading').classList.add('hidden');
            document.getElementById('loginContainer').classList.add('hidden');
            document.getElementById('mainContainer').style.display = 'block';

            Utils.debugLog('ë¡œê·¸ì¸ ì„±ê³µ:', user.name);
        }

        // ë¡œê·¸ì•„ì›ƒ
        function logout() {
            if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                try {
                    // ì„¸ì…˜ ì´ˆê¸°í™”
                    SessionManager.clearSession();
                    currentUser = null;
                    
                    // ì—°ê²° ëª¨ë‹ˆí„°ë§ ì¤‘ì§€
                    if (connectionCheckInterval) {
                        clearInterval(connectionCheckInterval);
                        connectionCheckInterval = null;
                    }
                    
                    // ë°ì´í„° ì´ˆê¸°í™”
                    currentCallsData = [];
                    currentUsersData = [];
                    currentRequestsData = [];
                    currentProcessingCall = null;
                    
                    // ë¡œê·¸ì¸ í™”ë©´ìœ¼ë¡œ ì´ë™
                    showLoginScreen();
                    Utils.debugLog('ë¡œê·¸ì•„ì›ƒ ì™„ë£Œ');
                    
                } catch (error) {
                    Utils.debugLog('ë¡œê·¸ì•„ì›ƒ ì¤‘ ì˜¤ë¥˜:', error);
                    // ì˜¤ë¥˜ê°€ ë°œìƒí•´ë„ ê°•ì œë¡œ ë¡œê·¸ì¸ í™”ë©´ìœ¼ë¡œ ì´ë™
                    showLoginScreen();
                }
            }
        }

        // ë¡œê·¸ì¸ í™”ë©´ í‘œì‹œ
        function showLoginScreen() {
            document.getElementById('initialLoading').classList.add('hidden');
            document.getElementById('loginContainer').classList.remove('hidden');
            document.getElementById('mainContainer').style.display = 'none';
            
            // í¼ ì´ˆê¸°í™”
            document.getElementById('loginForm').reset();
            hideAlert('loginError');
        }

        // ì„¹ì…˜ í‘œì‹œ
        function showSection(sectionName) {
            // ëª¨ë“  ì„¹ì…˜ ìˆ¨ê¸°ê¸°
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            // ëª¨ë“  ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ ë¹„í™œì„±í™”
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // ì„ íƒëœ ì„¹ì…˜ í‘œì‹œ
            document.getElementById(sectionName + 'Section').classList.add('active');
            
            // ì„ íƒëœ ë²„íŠ¼ í™œì„±í™”
            event.target.classList.add('active');

            // ì„¹ì…˜ë³„ ì´ˆê¸° ë¡œë”©
            if (sectionName === 'users' && SessionManager.hasRole('manager')) {
                loadUsersSection();
            } else if (sectionName === 'requests' && SessionManager.hasRole('manager')) {
                loadRequestsSection();
            }
        }

        // ì‚¬ìš©ì ê´€ë¦¬ ì„¹ì…˜ ë¡œë”©
        async function loadUsersSection() {
            if (!SessionManager.hasRole('manager')) {
                alert('âŒ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            try {
                showLoading('usersLoading');
                
                // Apps Scriptì˜ getUsers ì•¡ì…˜ ì‚¬ìš©
                const result = await GoogleAppsScriptAPI.getUsers();
                
                if (result.success) {
                    // ìŠ¹ì¸ëœ ì‚¬ìš©ìë§Œ í‘œì‹œ
                    currentUsersData = result.users.filter(u => u.status === 'approved') || [];
                    displayUsersResults(currentUsersData);
                } else {
                    throw new Error(result.error || 'ì‚¬ìš©ì ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                }
                
                hideLoading('usersLoading');
                
            } catch (error) {
                Utils.debugLog('ì‚¬ìš©ì ì„¹ì…˜ ë¡œë”© ì˜¤ë¥˜:', error);
                hideLoading('usersLoading');
                alert('âŒ ì‚¬ìš©ì ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        // ê³„ì • ì‹ ì²­ ê´€ë¦¬ ì„¹ì…˜ ë¡œë”©
        async function loadRequestsSection() {
            if (!SessionManager.hasRole('manager')) {
                alert('âŒ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            try {
                showLoading('requestsLoading');
                
                const result = await GoogleAppsScriptAPI.getPendingRequests();
                
                if (result.success) {
                    currentRequestsData = result.requests || [];
                    displayRequestsResults(currentRequestsData);
                } else {
                    throw new Error(result.error || 'ì‹ ì²­ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                }
                
                hideLoading('requestsLoading');
                
            } catch (error) {
                Utils.debugLog('ì‹ ì²­ ì„¹ì…˜ ë¡œë”© ì˜¤ë¥˜:', error);
                hideLoading('requestsLoading');
                alert('âŒ ì‹ ì²­ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        // ê³„ì • ì‹ ì²­ ëª©ë¡ ê²°ê³¼ í‘œì‹œ
        function displayRequestsResults(requests) {
            const tbody = document.querySelector('#requestsTable tbody');
            const noRequestsMsg = document.getElementById('noRequestsMessage');
            
            tbody.innerHTML = '';

            if (requests.length === 0) {
                showElement('noRequestsMessage');
                return;
            }

            hideElement('noRequestsMessage');

            requests.forEach((request, index) => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td class="time-display">${request.requestDate}</td>
                    <td>${request.name}</td>
                    <td>${request.email}</td>
                    <td>${request.phone}</td>
                    <td>${request.department}</td>
                    <td><span class="status-badge status-${request.role}">${getRoleDisplayName(request.role)}</span></td>
                    <td class="phone-number">${request.requestedUsername || 'ìë™ ìƒì„±'}</td>
                    <td><span class="status-badge status-pending">â³ ëŒ€ê¸°ì¤‘</span></td>
                    <td style="white-space: nowrap;">
                        <button class="btn btn-success btn-small" onclick="openApprovalModal(${index})" style="margin-right: 5px;">
                            âœ… ìŠ¹ì¸
                        </button>
                        <button class="btn btn-danger btn-small" onclick="rejectRequest(${index})">
                            âŒ ê±°ë¶€
                        </button>
                    </td>
                `;
            });
        }

        // ê³„ì • ì‹ ì²­ ìŠ¹ì¸ ëª¨ë‹¬ ì—´ê¸°
        function openApprovalModal(index) {
            const request = currentRequestsData[index];
            
            document.getElementById('approvalRequestId').value = request.id;
            document.getElementById('approvalRequestName').textContent = request.name;
            document.getElementById('approvalRequestInfo').textContent = 
                `${request.email} | ${request.department} | ${getRoleDisplayName(request.role)}`;
            
            // í¬ë§ ì‚¬ìš©ì IDê°€ ìˆìœ¼ë©´ ë¯¸ë¦¬ ì±„ì›Œë„£ê¸°
            document.getElementById('approvalUsername').value = request.requestedUsername || '';
            document.getElementById('approvalPassword').value = '';
            document.getElementById('approvalNote').value = '';

            hideAlert('approvalModalError');
            document.getElementById('approvalModal').classList.add('show');
            
            setTimeout(() => {
                const usernameField = document.getElementById('approvalUsername');
                if (usernameField.value) {
                    document.getElementById('approvalPassword').focus();
                } else {
                    usernameField.focus();
                }
            }, 100);
        }

        // ìŠ¹ì¸ ëª¨ë‹¬ ë‹«ê¸°
        function closeApprovalModal() {
            closeModal('approvalModal');
            hideAlert('approvalModalError');
        }

        // ê³„ì • ì‹ ì²­ ìŠ¹ì¸ ì²˜ë¦¬
        async function approveAccountRequest() {
            const requestId = document.getElementById('approvalRequestId').value;
            const username = document.getElementById('approvalUsername').value.trim();
            const password = document.getElementById('approvalPassword').value;
            const note = document.getElementById('approvalNote').value.trim();

            if (!username || !password) {
                showAlert('approvalModalError', 'ì‚¬ìš©ì IDì™€ ì„ì‹œ ë¹„ë°€ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            const passwordValidation = Utils.isValidPassword(password);
            if (!passwordValidation.valid) {
                showAlert('approvalModalError', passwordValidation.message, 'error');
                return;
            }

            try {
                // ë²„íŠ¼ ìƒíƒœ ë³€ê²½
                const approveBtn = document.querySelector('#approvalModal .btn-success');
                const btnText = document.getElementById('approvalSaveBtnText');
                approveBtn.disabled = true;
                btnText.textContent = 'ìŠ¹ì¸ ì²˜ë¦¬ ì¤‘...';

                const approvalData = {
                    username: username,
                    password: password,
                    note: note
                };

                const result = await GoogleAppsScriptAPI.approveRequest(requestId, approvalData);

                if (result.success) {
                    closeApprovalModal();
                    await loadRequestsSection(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                    
                    alert(`âœ… ê³„ì •ì´ ìŠ¹ì¸ë˜ì–´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!\n\nğŸ‘¤ ì‚¬ìš©ì: ${result.user.name}\nğŸ†” ì‚¬ìš©ì ID: ${result.user.username}\nğŸ“§ ì´ë©”ì¼: ${result.user.email}\n\nğŸ’¡ ìƒì„±ëœ ì„ì‹œ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì‚¬ìš©ìì—ê²Œ ì „ë‹¬í•´ì£¼ì„¸ìš”.`);
                } else {
                    showAlert('approvalModalError', result.error || 'ìŠ¹ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                }

            } catch (error) {
                Utils.debugLog('ìŠ¹ì¸ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
                showAlert('approvalModalError', 'ìŠ¹ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
            } finally {
                // ë²„íŠ¼ ë³µì›
                const approveBtn = document.querySelector('#approvalModal .btn-success');
                const btnText = document.getElementById('approvalSaveBtnText');
                approveBtn.disabled = false;
                btnText.textContent = 'âœ… ìŠ¹ì¸ ë° ê³„ì • ìƒì„±';
            }
        }

        // ê³„ì • ì‹ ì²­ ê±°ë¶€
        async function rejectRequest(index) {
            const request = currentRequestsData[index];
            
            const reason = prompt(`âš ï¸ ê³„ì • ì‹ ì²­ì„ ê±°ë¶€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì‹ ì²­ì: ${request.name}\nì´ë©”ì¼: ${request.email}\n\nê±°ë¶€ ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš” (ì„ íƒì‚¬í•­):`);
            
            if (reason === null) return; // ì·¨ì†Œí•œ ê²½ìš°

            try {
                const result = await GoogleAppsScriptAPI.rejectRequest(request.id, reason);

                if (result.success) {
                    await loadRequestsSection(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                    alert(`âŒ ê³„ì • ì‹ ì²­ì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤.\n\nì‹ ì²­ì: ${request.name}\nì‚¬ìœ : ${reason || 'ì‚¬ìœ  ì—†ìŒ'}`);
                } else {
                    alert('âŒ ê±°ë¶€ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + result.error);
                }

            } catch (error) {
                Utils.debugLog('ê±°ë¶€ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
                alert('âŒ ê±°ë¶€ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        // ì‚¬ìš©ì ëª©ë¡ ê²°ê³¼ í‘œì‹œ
        function displayUsersResults(users) {
            const tbody = document.querySelector('#usersTable tbody');
            tbody.innerHTML = '';

            if (users.length === 0) {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td colspan="8" class="text-center" style="padding: 40px; color: #666;">
                        ğŸ‘¥ ë“±ë¡ëœ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.
                    </td>
                `;
                return;
            }

            users.forEach((user, index) => {
                const row = tbody.insertRow();
                const statusClass = user.status === 'approved' ? 'status-processed' : 'status-pending';
                const statusText = user.status === 'approved' ? 'âœ… í™œì„±' : 'â³ ëŒ€ê¸°ì¤‘';
                
                row.innerHTML = `
                    <td class="phone-number">${user.username}</td>
                    <td>${user.name}</td>
                    <td>${user.email}</td>
                    <td><span class="status-badge status-${user.role}">${getRoleDisplayName(user.role)}</span></td>
                    <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                    <td class="time-display">${user.createdAt || '-'}</td>
                    <td class="time-display">${user.lastLogin || '-'}</td>
                    <td style="white-space: nowrap;">
                        <button class="btn btn-primary btn-small" onclick="editUser(${index})" style="margin-right: 5px;">âœï¸ ìˆ˜ì •</button>
                        ${user.username !== currentUser.username ? 
                            `<button class="btn btn-danger btn-small" onclick="deleteUser(${index})">ğŸ—‘ï¸ ì‚­ì œ</button>` : 
                            '<span class="text-small">í˜„ì¬ ì‚¬ìš©ì</span>'
                        }
                    </td>
                `;
            });
        }

        // ê¶Œí•œ í‘œì‹œëª… ë°˜í™˜
        function getRoleDisplayName(role) {
            const roleNames = {
                'admin': 'ì‹œìŠ¤í…œ ê´€ë¦¬ì',
                'manager': 'ê´€ë¦¬ì', 
                'user': 'ì¼ë°˜ ì‚¬ìš©ì'
            };
            return roleNames[role] || role;
        }

        // ì‚¬ìš©ì ëª¨ë‹¬ ì—´ê¸°
        function openUserModal(user = null) {
            const isEdit = !!user;
            
            document.getElementById('userModalTitle').textContent = isEdit ? 'âœï¸ ì‚¬ìš©ì ìˆ˜ì •' : 'â• ì‚¬ìš©ì ì¶”ê°€';
            
            if (isEdit) {
                document.getElementById('userId').value = user.id;
                document.getElementById('userUsername').value = user.username;
                document.getElementById('userUsername').disabled = true;
                document.getElementById('userPassword').required = false;
                document.getElementById('userPassword').placeholder = 'ë³€ê²½í•˜ì§€ ì•Šìœ¼ë ¤ë©´ ë¹„ì›Œë‘ì„¸ìš”';
                document.getElementById('userName').value = user.name;
                document.getElementById('userEmail').value = user.email;
                document.getElementById('userRole').value = user.role;
            } else {
                document.getElementById('userForm').reset();
                document.getElementById('userUsername').disabled = false;
                document.getElementById('userPassword').required = true;
                document.getElementById('userPassword').placeholder = '6ì ì´ìƒ ì…ë ¥í•˜ì„¸ìš”';
            }

            hideAlert('userModalError');
            document.getElementById('userModal').classList.add('show');
            
            // ì²« ë²ˆì§¸ ì…ë ¥ í•„ë“œì— í¬ì»¤ìŠ¤
            setTimeout(() => {
                if (!isEdit) {
                    document.getElementById('userUsername').focus();
                } else {
                    document.getElementById('userName').focus();
                }
            }, 100);
        }

        // ì‚¬ìš©ì ëª¨ë‹¬ ë‹«ê¸°
        function closeUserModal() {
            closeModal('userModal');
        }

        // ì‚¬ìš©ì ìˆ˜ì •
        function editUser(index) {
            const user = currentUsersData[index];
            openUserModal(user);
        }

        // ì‚¬ìš©ì ì‚­ì œ
        async function deleteUser(index) {
            const user = currentUsersData[index];
            
            if (confirm(`âš ï¸ ì‚¬ìš©ì '${user.name}'ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) {
                try {
                    // Apps Scriptì˜ deleteUser ì•¡ì…˜ ì‚¬ìš©
                    const result = await GoogleAppsScriptAPI.deleteUser(user.id);

                    if (result.success) {
                        await loadUsersSection();
                        alert('âœ… ì‚¬ìš©ìê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    } else {
                        alert('âŒ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + result.error);
                    }
                } catch (error) {
                    Utils.debugLog('ì‚¬ìš©ì ì‚­ì œ ì˜¤ë¥˜:', error);
                    alert('âŒ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                }
            }
        }

        // ì‚¬ìš©ì ì €ì¥
        async function saveUser() {
            const userId = document.getElementById('userId').value;
            const username = document.getElementById('userUsername').value.trim();
            const password = document.getElementById('userPassword').value;
            const name = document.getElementById('userName').value.trim();
            const email = document.getElementById('userEmail').value.trim();
            const role = document.getElementById('userRole').value;

            // ìœ íš¨ì„± ê²€ì‚¬
            if (!username || !name || !email || !role) {
                showAlert('userModalError', 'í•„ìˆ˜ í•­ëª©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            if (!Utils.isValidEmail(email)) {
                showAlert('userModalError', 'ì˜¬ë°”ë¥¸ ì´ë©”ì¼ ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            if (!userId && !password) {
                showAlert('userModalError', 'ìƒˆ ì‚¬ìš©ìëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ í•„ìš”í•©ë‹ˆë‹¤.', 'error');
                return;
            }

            if (password) {
                const passwordValidation = Utils.isValidPassword(password);
                if (!passwordValidation.valid) {
                    showAlert('userModalError', passwordValidation.message, 'error');
                    return;
                }
            }

            try {
                const isEdit = !!userId;
                
                // ë²„íŠ¼ ìƒíƒœ ë³€ê²½
                const saveBtn = document.querySelector('#userModal .btn-success');
                const btnText = document.getElementById('userSaveBtnText');
                saveBtn.disabled = true;
                btnText.textContent = 'ì €ì¥ ì¤‘...';
                
                const userData = {
                    id: userId || Utils.generateUUID(),
                    username: username,
                    name: name,
                    email: email,
                    role: role,
                    status: 'approved', // ê´€ë¦¬ìê°€ ì§ì ‘ ìƒì„±í•˜ëŠ” ê²½ìš°ëŠ” ë°”ë¡œ ìŠ¹ì¸
                    createdAt: isEdit ? null : Utils.getCurrentDateTime(),
                    lastLogin: isEdit ? null : null
                };

                // ë¹„ë°€ë²ˆí˜¸ê°€ ìˆìœ¼ë©´ í•´ì‹œ ì²˜ë¦¬
                if (password) {
                    userData.passwordHash = Utils.simpleHash(password, username);
                }

                let result;
                if (isEdit) {
                    // Apps Scriptì˜ updateUser ì•¡ì…˜ ì‚¬ìš©
                    result = await GoogleAppsScriptAPI.updateUser(userId, userData);
                } else {
                    // Apps Scriptì˜ addUser ì•¡ì…˜ ì‚¬ìš©
                    result = await GoogleAppsScriptAPI.addUser(userData);
                }

                if (result.success) {
                    await loadUsersSection();
                    closeUserModal();
                    
                    alert(`âœ… ${isEdit ? 'ì‚¬ìš©ìê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ì‚¬ìš©ìê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.'}`);
                } else {
                    showAlert('userModalError', result.error || 'ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                }

            } catch (error) {
                Utils.debugLog('ì‚¬ìš©ì ì €ì¥ ì˜¤ë¥˜:', error);
                showAlert('userModalError', 'ì‚¬ìš©ì ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
            } finally {
                // ë²„íŠ¼ ë³µì›
                const saveBtn = document.querySelector('#userModal .btn-success');
                const btnText = document.getElementById('userSaveBtnText');
                saveBtn.disabled = false;
                btnText.textContent = 'ğŸ’¾ ì €ì¥';
            }
        }

        // Missing Call ì¡°íšŒ
        async function searchCalls() {
            const searchDate = document.getElementById('searchDate').value;
            const processFilter = document.getElementById('processFilter').value;
            
            if (!searchDate || searchDate.trim() === '') {
                alert('ğŸ“… ì¡°íšŒí•  ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            try {
                showLoading('loadingMessage');
                hideElement('callsResults');
                hideElement('noDataMessage');
                
                // Apps Scriptì˜ getCalls ì•¡ì…˜ ì‚¬ìš©
                const result = await GoogleAppsScriptAPI.getCalls({ date: searchDate });
                
                let data = [];
                if (result.success) {
                    data = processCallData(result.calls || []);
                    
                    // ì²˜ë¦¬ ìƒíƒœ í•„í„° ì ìš©
                    if (processFilter !== 'all') {
                        data = data.filter(call => {
                            if (processFilter === 'processed') {
                                return call.processStatus && call.processStatus.trim() !== '';
                            } else if (processFilter === 'pending') {
                                return !call.processStatus || call.processStatus.trim() === '';
                            }
                            return true;
                        });
                    }
                } else {
                    throw new Error(result.error || 'ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                }
                
                currentCallsData = data;
                
                if (data.length > 0) {
                    displayCallsResults(data);
                    showElement('callsResults');
                } else {
                    // í•„í„°ì— ë”°ë¥¸ ë©”ì‹œì§€ ë³€ê²½
                    const noDataTitle = document.getElementById('noDataTitle');
                    const noDataSubtitle = document.getElementById('noDataSubtitle');
                    
                    if (processFilter === 'processed') {
                        noDataTitle.textContent = 'ğŸ“­ ì²˜ë¦¬ ì™„ë£Œëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤';
                        noDataSubtitle.textContent = 'í•´ë‹¹ ë‚ ì§œì— ì²˜ë¦¬ ì™„ë£Œëœ Missing Callì´ ì—†ìŠµë‹ˆë‹¤.';
                    } else if (processFilter === 'pending') {
                        noDataTitle.textContent = 'ğŸ“­ ë¯¸ì²˜ë¦¬ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤';
                        noDataSubtitle.textContent = 'í•´ë‹¹ ë‚ ì§œì— ë¯¸ì²˜ë¦¬ Missing Callì´ ì—†ìŠµë‹ˆë‹¤.';
                    } else {
                        noDataTitle.textContent = 'ğŸ“­ ì¡°íšŒëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤';
                        noDataSubtitle.textContent = 'ë‹¤ë¥¸ ë‚ ì§œë¥¼ ì„ íƒí•´ì„œ ì¡°íšŒí•´ë³´ì„¸ìš”.';
                    }
                    
                    showElement('noDataMessage');
                }
                
                hideLoading('loadingMessage');
                
            } catch (error) {
                Utils.debugLog('ì¡°íšŒ ì˜¤ë¥˜:', error);
                hideLoading('loadingMessage');
                alert('âŒ ë°ì´í„° ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        // ì½œ ë°ì´í„° ì²˜ë¦¬ (ì¤‘ë³µ ê·¸ë£¹í™”)
        function processCallData(rawCalls) {
            const groups = {};
            
            // ì „í™”ë²ˆí˜¸ë³„ë¡œ ê·¸ë£¹í•‘
            rawCalls.forEach((call, index) => {
                const phoneNumber = call.phoneNumber;
                if (!groups[phoneNumber]) {
                    groups[phoneNumber] = [];
                }
                groups[phoneNumber].push({...call, originalIndex: index});
            });

            const processedData = [];

            Object.keys(groups).forEach(phoneNumber => {
                const calls = groups[phoneNumber];
                
                // ì‹œê°„ìˆœìœ¼ë¡œ ì •ë ¬
                calls.sort((a, b) => {
                    const timeA = new Date(`${a.date} ${a.startTime}`);
                    const timeB = new Date(`${b.date} ${b.startTime}`);
                    return timeA - timeB;
                });

                // OBì½œ ì²˜ë¦¬ê°€ ëœ ì½œë“¤ì„ ê¸°ì¤€ìœ¼ë¡œ ê·¸ë£¹ ë¶„ë¦¬
                let currentGroup = [];
                
                for (let i = 0; i < calls.length; i++) {
                    const call = calls[i];
                    currentGroup.push(call);
                    
                    // ë‹¤ìŒ ì½œì´ ìˆê³ , í˜„ì¬ ì½œì´ ì²˜ë¦¬ë˜ì—ˆìœ¼ë©°, ë‹¤ìŒ ì½œì´ ì²˜ë¦¬ë˜ì§€ ì•Šì•˜ë‹¤ë©´ ê·¸ë£¹ ì¢…ë£Œ
                    if (i < calls.length - 1) {
                        const nextCall = calls[i + 1];
                        if (call.processStatus && !nextCall.processStatus) {
                            // í˜„ì¬ ê·¸ë£¹ ì²˜ë¦¬
                            if (currentGroup.length > 0) {
                                const latestCall = currentGroup[currentGroup.length - 1];
                                processedData.push({
                                    ...latestCall,
                                    callCount: currentGroup.length,
                                    groupCalls: [...currentGroup]
                                });
                            }
                            currentGroup = [];
                        }
                    }
                }
                
                // ë§ˆì§€ë§‰ ê·¸ë£¹ ì²˜ë¦¬
                if (currentGroup.length > 0) {
                    const latestCall = currentGroup[currentGroup.length - 1];
                    processedData.push({
                        ...latestCall,
                        callCount: currentGroup.length,
                        groupCalls: [...currentGroup]
                    });
                }
            });

            return processedData;
        }

        // ì½œ ë°ì´í„° ê²°ê³¼ í‘œì‹œ
        function displayCallsResults(data) {
            const countDiv = document.getElementById('resultsCount');
            const tbody = document.querySelector('#callsTable tbody');
            const processFilter = document.getElementById('processFilter').value;
            
            // í•„í„° ìƒíƒœì— ë”°ë¥¸ ì œëª© ë³€ê²½
            let filterText = '';
            if (processFilter === 'processed') {
                filterText = ' (ì²˜ë¦¬ ì™„ë£Œë§Œ)';
            } else if (processFilter === 'pending') {
                filterText = ' (ë¯¸ì²˜ë¦¬ë§Œ)';
            }

            countDiv.textContent = `ğŸ“Š ì¡°íšŒ ê²°ê³¼: ${data.length}ê±´${filterText}`;
            tbody.innerHTML = '';

            data.forEach((call, index) => {
                const row = tbody.insertRow();
                const waitMinutes = Math.round(call.duration / 60);
                
                row.innerHTML = `
                    <td>${call.date}</td>
                    <td class="time-display">${call.startTime}</td>
                    <td class="time-display">${waitMinutes}ë¶„</td>
                    <td class="phone-number">${call.phoneNumber}</td>
                    <td>${call.queue}</td>
                    <td><span class="call-count">${call.callCount}ë²ˆ</span></td>
                    <td>
                        <span class="status-badge ${call.processStatus ? 'status-processed' : 'status-pending'}">
                            ${call.processStatus ? 'âœ… ì²˜ë¦¬ì™„ë£Œ' : 'â³ ë¯¸ì²˜ë¦¬'}
                        </span>
                    </td>
                    <td>${call.processManager || '-'}</td>
                    <td>
                        <button class="btn btn-primary btn-small" onclick="openProcessModal(${index})">
                            ${call.processStatus ? 'âœï¸ ìˆ˜ì •' : 'ğŸ“ ì²˜ë¦¬'}
                        </button>
                    </td>
                `;
            });
        }

        // CSV ë‚´ë³´ë‚´ê¸°
        function exportToCSV() {
            if (currentCallsData.length === 0) {
                alert('ğŸ“­ ë‚´ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const headers = ['ë°œìƒì¼', 'ì¸ì…ì‹œê°„', 'ëŒ€ê¸°ì‹œê°„(ë¶„)', 'ì „í™”ë²ˆí˜¸', 'ì¸ì…í', 'ì¤‘ë³µíšŸìˆ˜', 'ì²˜ë¦¬ìƒíƒœ', 'ì²˜ë¦¬ë‹´ë‹¹ì'];
            const csvContent = [
                headers.join(','),
                ...currentCallsData.map(call => [
                    call.date,
                    call.startTime,
                    Math.round(call.duration / 60),
                    call.phoneNumber,
                    `"${call.queue}"`,
                    call.callCount,
                    call.processStatus || 'ë¯¸ì²˜ë¦¬',
                    call.processManager || ''
                ].join(','))
            ].join('\n');

            const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `missing_calls_${document.getElementById('searchDate').value}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // OBì½œ ì²˜ë¦¬ ëª¨ë‹¬ ì—´ê¸°
        function openProcessModal(index) {
            const call = currentCallsData[index];
            currentProcessingCall = { ...call, index };

            Utils.debugLog('ì„ íƒëœ ì½œ ë°ì´í„°:', call);
            Utils.debugLog('ì„¤ì •ëœ currentProcessingCall:', currentProcessingCall);

            document.getElementById('modalPhoneNumber').textContent = call.phoneNumber;
            document.getElementById('modalCallInfo').textContent = 
                `${call.callCount > 1 ? call.callCount + 'ë²ˆ ì¤‘ë³µ | ' : ''}${call.queue} | ${Math.round(call.duration / 60)}ë¶„ ëŒ€ê¸°`;
            
            document.getElementById('processStatus').value = call.processStatus || '';
            document.getElementById('processManager').value = call.processManager || currentUser.name;
            document.getElementById('processNote').value = '';

            hideAlert('processModalError');
            document.getElementById('processModal').classList.add('show');
            
            // ì²˜ë¦¬ ìƒíƒœì— í¬ì»¤ìŠ¤
            setTimeout(() => {
                if (!call.processStatus) {
                    document.getElementById('processStatus').focus();
                } else {
                    document.getElementById('processManager').focus();
                }
            }, 100);
        }

        // OBì½œ ì²˜ë¦¬ ëª¨ë‹¬ ë‹«ê¸°
        function closeProcessModal() {
            closeModal('processModal');
            currentProcessingCall = null;
            hideAlert('processModalError');
        }

        // OBì½œ ì²˜ë¦¬ ì €ì¥
        async function saveProcess() {
            const processStatus = document.getElementById('processStatus').value;
            const processManager = document.getElementById('processManager').value.trim();
            const processNote = document.getElementById('processNote').value.trim();

            if (!processStatus || !processManager) {
                showAlert('processModalError', 'ì²˜ë¦¬ ì—¬ë¶€ì™€ ì²˜ë¦¬ë‹´ë‹¹ìë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            try {
                // ë²„íŠ¼ ìƒíƒœ ë³€ê²½
                const saveBtn = document.querySelector('#processModal .btn-success');
                const btnText = document.getElementById('processSaveBtnText');
                saveBtn.disabled = true;
                btnText.textContent = 'ì €ì¥ ì¤‘...';

                // ë””ë²„ê·¸ ë¡œê·¸ ì¶”ê°€
                Utils.debugLog('í˜„ì¬ ì²˜ë¦¬í•  ì½œ ì •ë³´:', currentProcessingCall);

                // ê·¸ë£¹ì˜ ëª¨ë“  ì½œì— ëŒ€í•´ ì—…ë°ì´íŠ¸
                const callsToUpdate = currentProcessingCall.groupCalls || [currentProcessingCall];
                
                Utils.debugLog('ì—…ë°ì´íŠ¸í•  ì½œ ëª©ë¡:', callsToUpdate);

                for (const call of callsToUpdate) {
                    Utils.debugLog('ì²˜ë¦¬ ì¤‘ì¸ ê°œë³„ ì½œ:', call);
                    
                    if (!call.rowIndex) {
                        throw new Error(`rowIndexê°€ ì—†ìŠµë‹ˆë‹¤. ì½œ ì •ë³´: ${JSON.stringify(call)}`);
                    }
                    
                    const updateData = {
                        rowIndex: call.rowIndex,
                        processStatus: processStatus,
                        processManager: processManager,
                        processNote: processNote
                    };
                    
                    Utils.debugLog('ì „ì†¡í•  ì—…ë°ì´íŠ¸ ë°ì´í„°:', updateData);
                    
                    // Apps Scriptì˜ updateCall ì•¡ì…˜ ì‚¬ìš©
                    const result = await GoogleAppsScriptAPI.updateCall(updateData);
                    
                    if (!result.success) {
                        throw new Error(result.error || 'ì—…ë°ì´íŠ¸ ì‹¤íŒ¨');
                    }
                }

                closeProcessModal();
                
                // í™”ë©´ ìƒˆë¡œê³ ì¹¨
                await searchCalls();
                
                alert(`âœ… OBì½œ ì²˜ë¦¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\nğŸ“ ${currentProcessingCall.phoneNumber}\nâœ¨ ${processStatus} (${processManager})`);

            } catch (error) {
                Utils.debugLog('ì²˜ë¦¬ ì €ì¥ ì˜¤ë¥˜:', error);
                showAlert('processModalError', 'ì²˜ë¦¬ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
            } finally {
                // ë²„íŠ¼ ë³µì›
                const saveBtn = document.querySelector('#processModal .btn-success');
                const btnText = document.getElementById('processSaveBtnText');
                saveBtn.disabled = false;
                btnText.textContent = 'ğŸ’¾ ì²˜ë¦¬ ì™„ë£Œ';
            }
        }

        // ë¹„ë°€ë²ˆí˜¸ í‘œì‹œ/ìˆ¨ê¸°ê¸° í† ê¸€
        function togglePassword(inputId) {
            const input = document.getElementById(inputId);
            const button = input.nextElementSibling;
            
            if (input.type === 'password') {
                input.type = 'text';
                button.textContent = 'ğŸ™ˆ';
            } else {
                input.type = 'password';
                button.textContent = 'ğŸ‘ï¸';
            }
        }

        // ì•Œë¦¼ ë©”ì‹œì§€ í‘œì‹œ
        function showAlert(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `alert alert-${type}`;
            element.classList.remove('hidden');
            
            if (type === 'success') {
                setTimeout(() => hideAlert(elementId), CONFIG.UI.TOAST_DURATION);
            }
        }

        // ì•Œë¦¼ ë©”ì‹œì§€ ìˆ¨ê¸°ê¸°
        function hideAlert(elementId) {
            document.getElementById(elementId).classList.add('hidden');
        }

        // ìš”ì†Œ í‘œì‹œ
        function showElement(elementId) {
            document.getElementById(elementId).classList.remove('hidden');
        }

        // ìš”ì†Œ ìˆ¨ê¸°ê¸°
        function hideElement(elementId) {
            document.getElementById(elementId).classList.add('hidden');
        }

        // ëª¨ë‹¬ ë‹«ê¸°
        function closeModal(modal) {
            if (typeof modal === 'string') {
                modal = document.getElementById(modal);
            }
            modal.classList.remove('show');
        }

        // ë¡œë”© í‘œì‹œ
        function showLoading(elementId) {
            showElement(elementId);
        }

        // ë¡œë”© ìˆ¨ê¸°ê¸°
        function hideLoading(elementId) {
            hideElement(elementId);
        }

        // ê³„ì • ì‹ ì²­ ëª¨ë‹¬ ì—´ê¸°
        function openAccountRequestModal() {
            document.getElementById('accountRequestForm').reset();
            hideAlert('accountRequestError');
            hideAlert('accountRequestSuccess');
            document.getElementById('accountRequestModal').classList.add('show');
            
            // ì²« ë²ˆì§¸ ì…ë ¥ í•„ë“œì— í¬ì»¤ìŠ¤
            setTimeout(() => {
                document.getElementById('requestName').focus();
            }, 100);
        }

        // ê³„ì • ì‹ ì²­ ëª¨ë‹¬ ë‹«ê¸°
        function closeAccountRequestModal() {
            closeModal('accountRequestModal');
        }

        // ê³„ì • ì‹ ì²­ì„œ ì œì¶œ (ìŠ¤í”„ë ˆë“œì‹œíŠ¸ì— ì €ì¥)
        async function submitAccountRequest() {
            const formData = {
                name: document.getElementById('requestName').value.trim(),
                email: document.getElementById('requestEmail').value.trim(),
                phone: document.getElementById('requestPhone').value.trim(),
                department: document.getElementById('requestDepartment').value.trim(),
                position: document.getElementById('requestPosition').value.trim(),
                role: document.getElementById('requestRole').value,
                reason: document.getElementById('requestReason').value.trim(),
                userId: document.getElementById('requestUserId').value.trim()
            };

            // ìœ íš¨ì„± ê²€ì‚¬
            if (!formData.name || !formData.email || !formData.phone || 
                !formData.department || !formData.role || !formData.reason) {
                showAlert('accountRequestError', 'í•„ìˆ˜ í•­ëª©(*)ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            if (!Utils.isValidEmail(formData.email)) {
                showAlert('accountRequestError', 'ì˜¬ë°”ë¥¸ ì´ë©”ì¼ ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            // ì „í™”ë²ˆí˜¸ í˜•ì‹ ê°„ë‹¨ ì²´í¬
            const phoneRegex = /^[\d\-\+\(\)\s]{10,}$/;
            if (!phoneRegex.test(formData.phone)) {
                showAlert('accountRequestError', 'ì˜¬ë°”ë¥¸ ì „í™”ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            try {
                // ë²„íŠ¼ ìƒíƒœ ë³€ê²½
                const submitBtn = document.querySelector('#accountRequestModal .btn-primary');
                const btnText = document.getElementById('accountRequestBtnText');
                submitBtn.disabled = true;
                btnText.textContent = 'ğŸ“§ ì œì¶œ ì¤‘...';

                // í˜„ì¬ ë‚ ì§œ/ì‹œê°„ ì¶”ê°€
                formData.requestDate = new Date().toLocaleString('ko-KR');
                
                // Apps Scriptë¥¼ í†µí•œ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì €ì¥
                const result = await GoogleAppsScriptAPI.submitAccountRequest(formData);

                if (result.success) {
                    showAlert('accountRequestSuccess', 
                        'âœ… ê³„ì • ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!\nê´€ë¦¬ì ê²€í†  í›„ ìŠ¹ì¸ë©ë‹ˆë‹¤.', 'success');
                    
                    // 3ì´ˆ í›„ ëª¨ë‹¬ ë‹«ê¸°
                    setTimeout(() => {
                        closeAccountRequestModal();
                    }, 3000);
                } else {
                    throw new Error(result.error || 'ì‹ ì²­ì„œ ì œì¶œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }

            } catch (error) {
                Utils.debugLog('ê³„ì • ì‹ ì²­ ì˜¤ë¥˜:', error);
                showAlert('accountRequestError', `ì œì¶œ ì‹¤íŒ¨: ${error.message}`, 'error');

            } finally {
                // ë²„íŠ¼ ë³µì›
                const submitBtn = document.querySelector('#accountRequestModal .btn-primary');
                const btnText = document.getElementById('accountRequestBtnText');
                submitBtn.disabled = false;
                btnText.textContent = 'ğŸ“§ ì‹ ì²­ì„œ ì œì¶œ';
            }
        }
    </script>
</body>
</html>
