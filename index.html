<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>투어비스 항공(국제선) Missing Call 처리 시스템</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        /* 로딩 스피너 */
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f4f6;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 로딩 메시지 */
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        /* 로그인 화면 스타일 */
        .login-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-box {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .login-header {
            margin-bottom: 30px;
        }

        .login-header h1 {
            color: #333;
            font-size: 1.8rem;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .login-header p {
            color: #666;
            font-size: 1rem;
        }

        /* 폼 스타일 */
        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
            font-family: inherit;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .password-container {
            position: relative;
        }

        .password-toggle {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            color: #666;
            font-size: 0.9rem;
            user-select: none;
            padding: 5px;
        }

        .password-toggle:hover {
            color: #333;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 20px;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
        }

        /* 버튼 스타일 */
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: inline-block;
            text-decoration: none;
            text-align: center;
            line-height: 1.2;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #5a6268;
            transform: translateY(-1px);
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(16, 185, 129, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(239, 68, 68, 0.3);
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 0.85rem;
        }

        /* 메인 대시보드 스타일 */
        .main-container {
            display: none;
            min-height: 100vh;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 15px 30px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #333;
            font-size: 1.5rem;
            font-weight: 300;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-name {
            color: #333;
            font-weight: 500;
        }

        .user-role {
            color: #666;
            font-size: 0.9rem;
            padding: 2px 8px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 12px;
        }

        .nav-menu {
            background: rgba(255, 255, 255, 0.9);
            padding: 15px 30px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .nav-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
        }

        .nav-btn:hover, .nav-btn.active {
            background: #667eea;
            color: white;
        }

        .content {
            padding: 30px;
            flex: 1;
        }

        .section {
            display: none;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .section.active {
            display: block;
        }

        .section-header {
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f1f3f4;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-header h2 {
            color: #333;
            font-size: 1.4rem;
            font-weight: 500;
        }

        /* 검색 섹션 */
        .search-section {
            background: #f8f9ff;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            border: 2px solid #e0e7ff;
        }

        .search-form {
            display: flex;
            gap: 15px;
            align-items: end;
            flex-wrap: wrap;
        }

        /* 테이블 스타일 */
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #f1f3f4;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        td {
            color: #555;
        }

        /* 상태 배지 */
        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-align: center;
            display: inline-block;
            min-width: 60px;
        }

        .status-processed { 
            background: #d1fae5; 
            color: #065f46; 
        }
        
        .status-pending { 
            background: #fee2e2; 
            color: #991b1b; 
        }
        
        .status-admin { 
            background: #dbeafe; 
            color: #1e40af; 
        }
        
        .status-manager { 
            background: #fef3c7; 
            color: #92400e; 
        }
        
        .status-user { 
            background: #f3f4f6; 
            color: #374151; 
        }

        .call-count {
            background: #fef3c7;
            color: #92400e;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            text-align: center;
            min-width: 60px;
            display: inline-block;
        }

        .phone-number {
            font-family: 'Courier New', monospace;
            font-weight: 600;
            color: #1f2937;
        }

        .time-display {
            font-family: 'Courier New', monospace;
            color: #4b5563;
        }

        /* 모달 스타일 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #f1f3f4;
        }

        .modal-header h3 {
            color: #333;
            font-size: 1.3rem;
            font-weight: 500;
            margin-bottom: 5px;
        }

        .modal-footer {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #f1f3f4;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        /* 알림 메시지 */
        .alert {
            padding: 12px 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-size: 0.9rem;
        }

        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }

        .alert-error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }

        .alert-info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #bfdbfe;
        }

        .alert-warning {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #fde68a;
        }

        /* 연결 상태 인디케이터 */
        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            z-index: 999;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .connection-status.show {
            opacity: 1;
        }

        .connection-status.connected {
            background: #d1fae5;
            color: #065f46;
        }

        .connection-status.disconnected {
            background: #fee2e2;
            color: #991b1b;
        }

        .connection-status.testing {
            background: #fef3c7;
            color: #92400e;
        }

        /* 유틸리티 클래스 */
        .hidden { 
            display: none !important; 
        }

        .text-center { 
            text-align: center; 
        }

        .mb-0 { margin-bottom: 0; }
        .mb-10 { margin-bottom: 10px; }
        .mb-20 { margin-bottom: 20px; }
        .mt-10 { margin-top: 10px; }
        .mt-20 { margin-top: 20px; }

        .text-small {
            font-size: 0.8rem;
            color: #666;
        }

        /* 반응형 디자인 */
        @media (max-width: 768px) {
            .header {
                padding: 15px 20px;
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }

            .nav-menu {
                padding: 15px 20px;
            }

            .content {
                padding: 20px;
            }

            .nav-buttons {
                justify-content: center;
            }

            .modal-content {
                margin: 20px;
                padding: 20px;
                max-width: none;
            }

            .search-form {
                flex-direction: column;
                align-items: stretch;
            }

            .form-group {
                width: 100%;
            }

            .section-header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .table-container {
                font-size: 0.85rem;
            }

            th, td {
                padding: 8px 6px;
            }

            .btn {
                width: 100%;
                margin-bottom: 10px;
            }

            .modal-footer {
                flex-direction: column;
            }

            .modal-footer .btn {
                margin-bottom: 0;
            }

            .user-info {
                flex-direction: column;
                gap: 8px;
            }

            .connection-status {
                position: static;
                margin: 10px auto;
                display: block;
                text-align: center;
                width: fit-content;
            }
        }

        @media (max-width: 480px) {
            .login-box {
                padding: 30px 20px;
            }

            .header h1 {
                font-size: 1.2rem;
            }

            .content {
                padding: 15px;
            }

            .section {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- 연결 상태 표시 -->
    <div id="connectionStatus" class="connection-status">
        <span id="connectionText">연결 확인 중...</span>
    </div>

    <!-- 로딩 화면 -->
    <div id="initialLoading" class="login-container">
        <div class="login-box text-center">
            <h2>🚀 시스템 초기화 중...</h2>
            <div class="loading">
                설정을 확인하고 있습니다<span class="spinner"></span>
            </div>
            <div id="initStatus" class="text-small mt-20">
                <!-- 초기화 상태 메시지 -->
            </div>
        </div>
    </div>

    <!-- 로그인 화면 -->
    <div id="loginContainer" class="login-container hidden">
        <div class="login-box">
            <div class="login-header">
                <h1>투어비스</h1>
                <p>항공(국제선) Missing Call 처리 시스템</p>
            </div>
            
            <form id="loginForm">
                <div class="form-group">
                    <label for="loginUsername">사용자 ID</label>
                    <input type="text" id="loginUsername" required autocomplete="username" placeholder="사용자 ID를 입력하세요">
                </div>
                
                <div class="form-group">
                    <label for="loginPassword">비밀번호</label>
                    <div class="password-container">
                        <input type="password" id="loginPassword" required autocomplete="current-password" placeholder="비밀번호를 입력하세요">
                        <button type="button" class="password-toggle" onclick="togglePassword('loginPassword')">👁️</button>
                    </div>
                </div>
                
                <div class="checkbox-group">
                    <input type="checkbox" id="rememberMe">
                    <label for="rememberMe">로그인 상태 유지 (7일)</label>
                </div>
                
                <button type="submit" class="btn btn-primary">
                    <span id="loginBtnText">로그인</span>
                </button>
            </form>
            
            <div id="loginError" class="alert alert-error hidden"></div>
            
            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee; font-size: 0.85rem; color: #666; text-align: center;">
                © 2025 TideSquare. All rights reserved.<br>
                <span class="text-small">기본 계정: admin / admin123</span>
            </div>
        </div>
    </div>

    <!-- 메인 대시보드 -->
    <div id="mainContainer" class="main-container">
        <div class="header">
            <h1>투어비스 Missing Call 관리 시스템</h1>
            <div class="user-info">
                <span class="user-name" id="currentUserName">사용자</span>
                <span class="user-role" id="currentUserRole">권한</span>
                <button class="btn btn-secondary btn-small" onclick="logout()">로그아웃</button>
            </div>
        </div>

        <div class="nav-menu">
            <div class="nav-buttons">
                <button class="nav-btn active" onclick="showSection('dashboard')">📊 대시보드</button>
                <button class="nav-btn hidden" onclick="showSection('users')" id="usersMenuBtn">👥 사용자 관리</button>
            </div>
        </div>

        <div class="content">
            <!-- 대시보드 섹션 -->
            <div id="dashboardSection" class="section active">
                <div class="section-header">
                    <h2>Missing Call 처리 현황</h2>
                    <div>
                        <button class="btn btn-secondary btn-small" onclick="refreshConnection()">🔄 연결 확인</button>
                    </div>
                </div>
                
                <div class="search-section">
                    <div class="search-form">
                        <div class="form-group">
                            <label for="searchDate">조회 일자</label>
                            <input type="date" id="searchDate">
                        </div>
                        <div class="form-group">
                            <button type="button" class="btn btn-primary" onclick="searchCalls()">
                                📋 조회
                            </button>
                        </div>
                    </div>
                </div>

                <div id="loadingMessage" class="loading hidden">
                    데이터를 조회하고 있습니다<span class="spinner"></span>
                </div>

                <div id="callsResults" class="hidden">
                    <div style="margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                        <h3 id="resultsCount" style="color: #333; margin: 0;">조회 결과</h3>
                        <div>
                            <button class="btn btn-secondary btn-small" onclick="searchCalls()">🔄 새로고침</button>
                            <button class="btn btn-primary btn-small" onclick="exportToCSV()" style="margin-left: 10px;">📥 CSV 내보내기</button>
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <table id="callsTable">
                            <thead>
                                <tr>
                                    <th>발생일</th>
                                    <th>인입시간</th>
                                    <th>대기시간(분)</th>
                                    <th>전화번호</th>
                                    <th>인입큐</th>
                                    <th>중복횟수</th>
                                    <th>처리상태</th>
                                    <th>처리담당자</th>
                                    <th>액션</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <div id="noDataMessage" class="text-center hidden" style="padding: 40px; color: #666;">
                    <h3>📭 조회된 데이터가 없습니다</h3>
                    <p>다른 날짜를 선택해서 조회해보세요.</p>
                </div>
            </div>

            <!-- 사용자 관리 섹션 -->
            <div id="usersSection" class="section">
                <div class="section-header">
                    <h2>사용자 관리</h2>
                    <button class="btn btn-primary" onclick="openUserModal()">➕ 새 사용자 추가</button>
                </div>

                <div id="usersLoading" class="loading hidden">
                    사용자 목록을 불러오고 있습니다<span class="spinner"></span>
                </div>

                <div id="usersResults" class="table-container">
                    <table id="usersTable">
                        <thead>
                            <tr>
                                <th>사용자 ID</th>
                                <th>실명</th>
                                <th>이메일</th>
                                <th>권한</th>
                                <th>등록일</th>
                                <th>마지막 로그인</th>
                                <th>액션</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- 사용자 등록/수정 모달 -->
    <div id="userModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="userModalTitle">사용자 추가</h3>
            </div>
            
            <form id="userForm">
                <input type="hidden" id="userId">
                
                <div class="form-group">
                    <label for="userUsername">사용자 ID *</label>
                    <input type="text" id="userUsername" required placeholder="영문/숫자로 입력하세요" autocomplete="username">
                </div>
                
                <div class="form-group">
                    <label for="userPassword">비밀번호 *</label>
                    <div class="password-container">
                        <input type="password" id="userPassword" placeholder="6자 이상 입력하세요" autocomplete="new-password">
                        <button type="button" class="password-toggle" onclick="togglePassword('userPassword')">👁️</button>
                    </div>
                    <small class="text-small">수정시 비밀번호를 변경하지 않으려면 비워두세요</small>
                </div>
                
                <div class="form-group">
                    <label for="userName">실명 *</label>
                    <input type="text" id="userName" required placeholder="실명을 입력하세요" autocomplete="name">
                </div>
                
                <div class="form-group">
                    <label for="userEmail">이메일 *</label>
                    <input type="email" id="userEmail" required placeholder="email@example.com" autocomplete="email">
                </div>
                
                <div class="form-group">
                    <label for="userRole">권한 *</label>
                    <select id="userRole" required>
                        <option value="">권한을 선택하세요</option>
                        <option value="user">일반 사용자</option>
                        <option value="manager">관리자</option>
                        <option value="admin">시스템 관리자</option>
                    </select>
                </div>
            </form>

            <div id="userModalError" class="alert alert-error hidden"></div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeUserModal()">취소</button>
                <button type="button" class="btn btn-success" onclick="saveUser()">
                    <span id="userSaveBtnText">💾 저장</span>
                </button>
            </div>
        </div>
    </div>

    <!-- OB콜 처리 모달 -->
    <div id="processModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>📞 OB콜 처리</h3>
                <p style="color: #666; margin: 5px 0 0 0;">
                    전화번호: <span id="modalPhoneNumber" class="phone-number"></span><br>
                    <span id="modalCallInfo" style="font-size: 0.9rem;"></span>
                </p>
            </div>
            
            <form id="processForm">
                <div class="form-group">
                    <label for="processStatus">처리 여부 *</label>
                    <select id="processStatus" required>
                        <option value="">선택해주세요</option>
                        <option value="완료">✅ 완료</option>
                        <option value="미완료">❌ 미완료</option>
                        <option value="보류">⏸️ 보류</option>
                        <option value="재시도">🔄 재시도 필요</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="processManager">처리담당자 *</label>
                    <input type="text" id="processManager" required placeholder="담당자명을 입력하세요" autocomplete="name">
                </div>

                <div class="form-group">
                    <label for="processNote">처리 메모 (선택)</label>
                    <textarea id="processNote" rows="3" placeholder="처리 내용이나 특이사항을 입력하세요"></textarea>
                </div>
            </form>

            <div id="processModalError" class="alert alert-error hidden"></div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeProcessModal()">취소</button>
                <button type="button" class="btn btn-success" onclick="saveProcess()">
                    <span id="processSaveBtnText">💾 처리 완료</span>
                </button>
            </div>
        </div>
    </div>

    <!-- config.js 파일 로드 -->
    <script src="config.js"></script>
    
    <script>
        // 전역 변수
        let currentUser = null;
        let currentCallsData = [];
        let currentUsersData = [];
        let currentProcessingCall = null;
        let connectionCheckInterval = null;

        // 페이지 로드시 초기화
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        // 앱 초기화
        async function initializeApp() {
            Utils.debugLog('앱 초기화 시작');
            
            try {
                // 초기화 상태 표시
                updateInitStatus('설정 파일 검증 중...');
                
                // 설정 검증
                if (!validateConfig()) {
                    showError('설정 파일에 오류가 있습니다. config.js를 확인해주세요.');
                    return;
                }

                updateInitStatus('연결 테스트 중...');
                
                // Apps Script 연결 테스트
                if (CONFIG.API.API_TYPE === 'apps_script') {
                    try {
                        const result = await GoogleAppsScriptAPI.testConnection();
                        if (result.success) {
                            showConnectionStatus('connected', '✅ 연결됨');
                            Utils.debugLog('✅ Apps Script 연결 테스트 성공');
                        } else {
                            showConnectionStatus('disconnected', '❌ 연결 실패');
                            Utils.debugLog('⚠️ Apps Script 연결 테스트 실패:', result.message);
                        }
                    } catch (error) {
                        showConnectionStatus('disconnected', '❌ 연결 실패');
                        Utils.debugLog('⚠️ Apps Script 연결 테스트 실패:', error.message);
                    }
                }

                updateInitStatus('세션 확인 중...');

                // 세션 확인
                const session = SessionManager.getSession();
                if (session) {
                    Utils.debugLog('기존 세션 발견:', session.username);
                    await loginSuccess(session);
                } else {
                    showLoginScreen();
                }

                // 오늘 날짜로 설정
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('searchDate').value = today;

                // 이벤트 리스너 등록
                setupEventListeners();

                // 주기적 연결 확인 시작
                startConnectionMonitoring();

            } catch (error) {
                Utils.debugLog('초기화 오류:', error);
                showError('시스템 초기화 중 오류가 발생했습니다: ' + error.message);
            }
        }

        // 초기화 상태 업데이트
        function updateInitStatus(message) {
            const statusEl = document.getElementById('initStatus');
            if (statusEl) {
                statusEl.textContent = message;
            }
        }

        // 연결 상태 표시
        function showConnectionStatus(status, text) {
            const statusEl = document.getElementById('connectionStatus');
            const textEl = document.getElementById('connectionText');
            
            statusEl.className = `connection-status ${status} show`;
            textEl.textContent = text;
            
            // 3초 후 자동 숨김 (연결됨 상태만)
            if (status === 'connected') {
                setTimeout(() => {
                    statusEl.classList.remove('show');
                }, 3000);
            }
        }

        // 연결 모니터링 시작
        function startConnectionMonitoring() {
            // 5분마다 연결 상태 확인
            connectionCheckInterval = setInterval(async () => {
                try {
                    const result = await GoogleAppsScriptAPI.testConnection();
                    if (!result.success) {
                        showConnectionStatus('disconnected', '❌ 연결 끊김');
                    }
                } catch (error) {
                    showConnectionStatus('disconnected', '❌ 연결 끊김');
                }
            }, 5 * 60 * 1000); // 5분
        }

        // 연결 새로고침
        async function refreshConnection() {
            showConnectionStatus('testing', '🔄 연결 확인 중...');
            
            try {
                const result = await GoogleAppsScriptAPI.testConnection();
                if (result.success) {
                    showConnectionStatus('connected', '✅ 연결 복구됨');
                } else {
                    showConnectionStatus('disconnected', '❌ 연결 실패');
                    alert('❌ 연결 확인 실패: ' + result.message);
                }
            } catch (error) {
                showConnectionStatus('disconnected', '❌ 연결 실패');
                alert('❌ 연결 확인 실패: ' + error.message);
            }
        }

        // 이벤트 리스너 설정
        function setupEventListeners() {
            // 로그인 폼
            document.getElementById('loginForm').addEventListener('submit', function(e) {
                e.preventDefault();
                handleLogin();
            });

            // 사용자 폼
            document.getElementById('userForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveUser();
            });

            // 처리 폼
            document.getElementById('processForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveProcess();
            });

            // Enter 키 처리
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    const activeModal = document.querySelector('.modal.show');
                    if (activeModal) {
                        const primaryButton = activeModal.querySelector('.btn-success, .btn-primary');
                        if (primaryButton && !primaryButton.disabled) {
                            primaryButton.click();
                        }
                    }
                }
                
                // ESC 키로 모달 닫기
                if (e.key === 'Escape') {
                    const openModal = document.querySelector('.modal.show');
                    if (openModal) {
                        closeModal(openModal);
                    }
                }
            });

            // 모달 외부 클릭시 닫기
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('modal')) {
                    closeModal(e.target);
                }
            });

            // 페이지 언로드시 정리
            window.addEventListener('beforeunload', function() {
                if (connectionCheckInterval) {
                    clearInterval(connectionCheckInterval);
                }
            });
        }

        // 오류 표시
        function showError(message) {
            document.getElementById('initialLoading').innerHTML = `
                <div class="login-box text-center">
                    <h2 style="color: #dc2626;">❌ 오류 발생</h2>
                    <div class="alert alert-error">${message}</div>
                    <button class="btn btn-primary mt-20" onclick="location.reload()">🔄 다시 시도</button>
                </div>
            `;
        }

        // 로그인 처리
        async function handleLogin() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            const rememberMe = document.getElementById('rememberMe').checked;

            if (!username || !password) {
                showAlert('loginError', '사용자 ID와 비밀번호를 입력해주세요.', 'error');
                return;
            }

            try {
                Utils.debugLog('로그인 시도:', username);
                
                // 버튼 상태 변경
                const loginBtn = document.querySelector('#loginForm .btn-primary');
                const btnText = document.getElementById('loginBtnText');
                loginBtn.disabled = true;
                btnText.textContent = '로그인 중...';
                
                // 사용자 인증 (Apps Script의 authenticate 액션 사용)
                const result = await GoogleAppsScriptAPI.authenticate(username, password);
                
                if (result.success && result.user) {
                    // 세션 생성
                    SessionManager.setSession(result.user, rememberMe);
                    await loginSuccess(result.user);
                } else {
                    showAlert('loginError', result.error || '사용자 ID 또는 비밀번호가 올바르지 않습니다.', 'error');
                }
            } catch (error) {
                Utils.debugLog('로그인 오류:', error);
                showAlert('loginError', '로그인 중 오류가 발생했습니다: ' + error.message, 'error');
            } finally {
                // 버튼 복원
                const loginBtn = document.querySelector('#loginForm .btn-primary');
                const btnText = document.getElementById('loginBtnText');
                loginBtn.disabled = false;
                btnText.textContent = '로그인';
            }
        }

        // 로그인 성공 처리
        async function loginSuccess(user) {
            currentUser = user;
            
            // UI 업데이트
            document.getElementById('currentUserName').textContent = user.name;
            document.getElementById('currentUserRole').textContent = getRoleDisplayName(user.role);
            
            // 권한에 따른 메뉴 표시
            const usersMenuBtn = document.getElementById('usersMenuBtn');
            if (SessionManager.hasRole('manager')) {
                usersMenuBtn.classList.remove('hidden');
            } else {
                usersMenuBtn.classList.add('hidden');
            }

            // 화면 전환
            document.getElementById('initialLoading').classList.add('hidden');
            document.getElementById('loginContainer').classList.add('hidden');
            document.getElementById('mainContainer').style.display = 'block';

            Utils.debugLog('로그인 성공:', user.name);
        }

        // 로그아웃
        function logout() {
            if (confirm('로그아웃 하시겠습니까?')) {
                SessionManager.clearSession();
                currentUser = null;
                
                // 연결 모니터링 중지
                if (connectionCheckInterval) {
                    clearInterval(connectionCheckInterval);
                }
                
                showLoginScreen();
                Utils.debugLog('로그아웃 완료');
            }
        }

        // 로그인 화면 표시
        function showLoginScreen() {
            document.getElementById('initialLoading').classList.add('hidden');
            document.getElementById('loginContainer').classList.remove('hidden');
            document.getElementById('mainContainer').style.display = 'none';
            
            // 폼 초기화
            document.getElementById('loginForm').reset();
            hideAlert('loginError');
        }

        // 섹션 표시
        function showSection(sectionName) {
            // 모든 섹션 숨기기
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            // 모든 네비게이션 버튼 비활성화
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // 선택된 섹션 표시
            document.getElementById(sectionName + 'Section').classList.add('active');
            
            // 선택된 버튼 활성화
            event.target.classList.add('active');

            // 섹션별 초기 로딩
            if (sectionName === 'users' && SessionManager.hasRole('manager')) {
                loadUsersSection();
            }
        }

        // 사용자 관리 섹션 로딩
        async function loadUsersSection() {
            if (!SessionManager.hasRole('manager')) {
                alert('❌ 권한이 없습니다.');
                return;
            }

            try {
                showLoading('usersLoading');
                
                // Apps Script의 getUsers 액션 사용
                const result = await GoogleAppsScriptAPI.getUsers();
                
                if (result.success) {
                    currentUsersData = result.users || [];
                    displayUsersResults(currentUsersData);
                } else {
                    throw new Error(result.error || '사용자 목록을 불러올 수 없습니다');
                }
                
                hideLoading('usersLoading');
                
            } catch (error) {
                Utils.debugLog('사용자 섹션 로딩 오류:', error);
                hideLoading('usersLoading');
                alert('❌ 사용자 목록을 불러오는 중 오류가 발생했습니다: ' + error.message);
            }
        }

        // 사용자 목록 결과 표시
        function displayUsersResults(users) {
            const tbody = document.querySelector('#usersTable tbody');
            tbody.innerHTML = '';

            if (users.length === 0) {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td colspan="7" class="text-center" style="padding: 40px; color: #666;">
                        👥 등록된 사용자가 없습니다.
                    </td>
                `;
                return;
            }

            users.forEach((user, index) => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td class="phone-number">${user.username}</td>
                    <td>${user.name}</td>
                    <td>${user.email}</td>
                    <td><span class="status-badge status-${user.role}">${getRoleDisplayName(user.role)}</span></td>
                    <td class="time-display">${user.createdAt || '-'}</td>
                    <td class="time-display">${user.lastLogin || '-'}</td>
                    <td style="white-space: nowrap;">
                        <button class="btn btn-primary btn-small" onclick="editUser(${index})" style="margin-right: 5px;">✏️ 수정</button>
                        ${user.username !== currentUser.username ? 
                            `<button class="btn btn-danger btn-small" onclick="deleteUser(${index})">🗑️ 삭제</button>` : 
                            '<span class="text-small">현재 사용자</span>'
                        }
                    </td>
                `;
            });
        }

        // 권한 표시명 반환
        function getRoleDisplayName(role) {
            const roleNames = {
                'admin': '시스템 관리자',
                'manager': '관리자', 
                'user': '일반 사용자'
            };
            return roleNames[role] || role;
        }

        // 사용자 모달 열기
        function openUserModal(user = null) {
            const isEdit = !!user;
            
            document.getElementById('userModalTitle').textContent = isEdit ? '✏️ 사용자 수정' : '➕ 사용자 추가';
            
            if (isEdit) {
                document.getElementById('userId').value = user.id;
                document.getElementById('userUsername').value = user.username;
                document.getElementById('userUsername').disabled = true;
                document.getElementById('userPassword').required = false;
                document.getElementById('userPassword').placeholder = '변경하지 않으려면 비워두세요';
                document.getElementById('userName').value = user.name;
                document.getElementById('userEmail').value = user.email;
                document.getElementById('userRole').value = user.role;
            } else {
                document.getElementById('userForm').reset();
                document.getElementById('userUsername').disabled = false;
                document.getElementById('userPassword').required = true;
                document.getElementById('userPassword').placeholder = '6자 이상 입력하세요';
            }

            hideAlert('userModalError');
            document.getElementById('userModal').classList.add('show');
            
            // 첫 번째 입력 필드에 포커스
            setTimeout(() => {
                if (!isEdit) {
                    document.getElementById('userUsername').focus();
                } else {
                    document.getElementById('userName').focus();
                }
            }, 100);
        }

        // 사용자 모달 닫기
        function closeUserModal() {
            closeModal('userModal');
        }

        // 사용자 수정
        function editUser(index) {
            const user = currentUsersData[index];
            openUserModal(user);
        }

        // 사용자 삭제
        async function deleteUser(index) {
            const user = currentUsersData[index];
            
            if (confirm(`⚠️ 사용자 '${user.name}'를 삭제하시겠습니까?\n\n이 작업은 되돌릴 수 없습니다.`)) {
                try {
                    // Apps Script의 deleteUser 액션 사용
                    const result = await GoogleAppsScriptAPI.deleteUser(user.id);

                    if (result.success) {
                        await loadUsersSection();
                        alert('✅ 사용자가 삭제되었습니다.');
                    } else {
                        alert('❌ 삭제 중 오류가 발생했습니다: ' + result.error);
                    }
                } catch (error) {
                    Utils.debugLog('사용자 삭제 오류:', error);
                    alert('❌ 삭제 중 오류가 발생했습니다: ' + error.message);
                }
            }
        }

        // 사용자 저장
        async function saveUser() {
            const userId = document.getElementById('userId').value;
            const username = document.getElementById('userUsername').value.trim();
            const password = document.getElementById('userPassword').value;
            const name = document.getElementById('userName').value.trim();
            const email = document.getElementById('userEmail').value.trim();
            const role = document.getElementById('userRole').value;

            // 유효성 검사
            if (!username || !name || !email || !role) {
                showAlert('userModalError', '필수 항목을 모두 입력해주세요.', 'error');
                return;
            }

            if (!Utils.isValidEmail(email)) {
                showAlert('userModalError', '올바른 이메일 주소를 입력해주세요.', 'error');
                return;
            }

            if (!userId && !password) {
                showAlert('userModalError', '새 사용자는 비밀번호가 필요합니다.', 'error');
                return;
            }

            if (password) {
                const passwordValidation = Utils.isValidPassword(password);
                if (!passwordValidation.valid) {
                    showAlert('userModalError', passwordValidation.message, 'error');
                    return;
                }
            }

            try {
                const isEdit = !!userId;
                
                // 버튼 상태 변경
                const saveBtn = document.querySelector('#userModal .btn-success');
                const btnText = document.getElementById('userSaveBtnText');
                saveBtn.disabled = true;
                btnText.textContent = '저장 중...';
                
                const userData = {
                    id: userId || Utils.generateUUID(),
                    username: username,
                    name: name,
                    email: email,
                    role: role,
                    createdAt: isEdit ? null : Utils.getCurrentDateTime(),
                    lastLogin: isEdit ? null : null
                };

                // 비밀번호가 있으면 해시 처리
                if (password) {
                    userData.passwordHash = Utils.simpleHash(password, username);
                }

                let result;
                if (isEdit) {
                    // Apps Script의 updateUser 액션 사용
                    result = await GoogleAppsScriptAPI.updateUser(userId, userData);
                } else {
                    // Apps Script의 addUser 액션 사용
                    result = await GoogleAppsScriptAPI.addUser(userData);
                }

                if (result.success) {
                    await loadUsersSection();
                    closeUserModal();
                    
                    alert(`✅ ${isEdit ? '사용자가 수정되었습니다.' : '사용자가 추가되었습니다.'}`);
                } else {
                    showAlert('userModalError', result.error || '저장 중 오류가 발생했습니다.', 'error');
                }

            } catch (error) {
                Utils.debugLog('사용자 저장 오류:', error);
                showAlert('userModalError', '사용자 저장 중 오류가 발생했습니다: ' + error.message, 'error');
            } finally {
                // 버튼 복원
                const saveBtn = document.querySelector('#userModal .btn-success');
                const btnText = document.getElementById('userSaveBtnText');
                saveBtn.disabled = false;
                btnText.textContent = '💾 저장';
            }
        }

        // Missing Call 조회
        async function searchCalls() {
            const searchDate = document.getElementById('searchDate').value;
            if (!searchDate) {
                alert('📅 조회할 날짜를 선택해주세요.');
                return;
            }

            try {
                showLoading('loadingMessage');
                hideElement('callsResults');
                hideElement('noDataMessage');
                
                // Apps Script의 getCalls 액션 사용
                const result = await GoogleAppsScriptAPI.getCalls({ date: searchDate });
                
                let data = [];
                if (result.success) {
                    data = processCallData(result.calls || []);
                } else {
                    throw new Error(result.error || '데이터를 불러올 수 없습니다');
                }
                
                currentCallsData = data;
                
                if (data.length > 0) {
                    displayCallsResults(data);
                    showElement('callsResults');
                } else {
                    showElement('noDataMessage');
                }
                
                hideLoading('loadingMessage');
                
            } catch (error) {
                Utils.debugLog('조회 오류:', error);
                hideLoading('loadingMessage');
                alert('❌ 데이터 조회 중 오류가 발생했습니다: ' + error.message);
            }
        }

        // 콜 데이터 처리 (중복 그룹화)
        function processCallData(rawCalls) {
            const groups = {};
            
            // 전화번호별로 그룹핑
            rawCalls.forEach((call, index) => {
                const phoneNumber = call.phoneNumber;
                if (!groups[phoneNumber]) {
                    groups[phoneNumber] = [];
                }
                groups[phoneNumber].push({...call, originalIndex: index});
            });

            const processedData = [];

            Object.keys(groups).forEach(phoneNumber => {
                const calls = groups[phoneNumber];
                
                // 시간순으로 정렬
                calls.sort((a, b) => {
                    const timeA = new Date(`${a.date} ${a.startTime}`);
                    const timeB = new Date(`${b.date} ${b.startTime}`);
                    return timeA - timeB;
                });

                // OB콜 처리가 된 콜들을 기준으로 그룹 분리
                let currentGroup = [];
                
                for (let i = 0; i < calls.length; i++) {
                    const call = calls[i];
                    currentGroup.push(call);
                    
                    // 다음 콜이 있고, 현재 콜이 처리되었으며, 다음 콜이 처리되지 않았다면 그룹 종료
                    if (i < calls.length - 1) {
                        const nextCall = calls[i + 1];
                        if (call.processStatus && !nextCall.processStatus) {
                            // 현재 그룹 처리
                            if (currentGroup.length > 0) {
                                const latestCall = currentGroup[currentGroup.length - 1];
                                processedData.push({
                                    ...latestCall,
                                    callCount: currentGroup.length,
                                    groupCalls: [...currentGroup]
                                });
                            }
                            currentGroup = [];
                        }
                    }
                }
                
                // 마지막 그룹 처리
                if (currentGroup.length > 0) {
                    const latestCall = currentGroup[currentGroup.length - 1];
                    processedData.push({
                        ...latestCall,
                        callCount: currentGroup.length,
                        groupCalls: [...currentGroup]
                    });
                }
            });

            return processedData;
        }

        // 콜 데이터 결과 표시
        function displayCallsResults(data) {
            const countDiv = document.getElementById('resultsCount');
            const tbody = document.querySelector('#callsTable tbody');

            countDiv.textContent = `📊 조회 결과: ${data.length}건`;
            tbody.innerHTML = '';

            data.forEach((call, index) => {
                const row = tbody.insertRow();
                const waitMinutes = Math.round(call.duration / 60);
                
                row.innerHTML = `
                    <td>${call.date}</td>
                    <td class="time-display">${call.startTime}</td>
                    <td class="time-display">${waitMinutes}분</td>
                    <td class="phone-number">${call.phoneNumber}</td>
                    <td>${call.queue}</td>
                    <td><span class="call-count">${call.callCount}번</span></td>
                    <td>
                        <span class="status-badge ${call.processStatus ? 'status-processed' : 'status-pending'}">
                            ${call.processStatus ? '✅ 처리완료' : '⏳ 미처리'}
                        </span>
                    </td>
                    <td>${call.processManager || '-'}</td>
                    <td>
                        <button class="btn btn-primary btn-small" onclick="openProcessModal(${index})">
                            ${call.processStatus ? '✏️ 수정' : '📞 처리'}
                        </button>
                    </td>
                `;
            });
        }

        // CSV 내보내기
        function exportToCSV() {
            if (currentCallsData.length === 0) {
                alert('📭 내보낼 데이터가 없습니다.');
                return;
            }

            const headers = ['발생일', '인입시간', '대기시간(분)', '전화번호', '인입큐', '중복횟수', '처리상태', '처리담당자'];
            const csvContent = [
                headers.join(','),
                ...currentCallsData.map(call => [
                    call.date,
                    call.startTime,
                    Math.round(call.duration / 60),
                    call.phoneNumber,
                    `"${call.queue}"`,
                    call.callCount,
                    call.processStatus || '미처리',
                    call.processManager || ''
                ].join(','))
            ].join('\n');

            const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `missing_calls_${document.getElementById('searchDate').value}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // OB콜 처리 모달 열기
        function openProcessModal(index) {
            const call = currentCallsData[index];
            currentProcessingCall = { ...call, index };

            document.getElementById('modalPhoneNumber').textContent = call.phoneNumber;
            document.getElementById('modalCallInfo').textContent = 
                `${call.callCount > 1 ? call.callCount + '번 중복 | ' : ''}${call.queue} | ${Math.round(call.duration / 60)}분 대기`;
            
            document.getElementById('processStatus').value = call.processStatus || '';
            document.getElementById('processManager').value = call.processManager || currentUser.name;
            document.getElementById('processNote').value = '';

            hideAlert('processModalError');
            document.getElementById('processModal').classList.add('show');
            
            // 처리 상태에 포커스
            setTimeout(() => {
                if (!call.processStatus) {
                    document.getElementById('processStatus').focus();
                } else {
                    document.getElementById('processManager').focus();
                }
            }, 100);
        }

        // OB콜 처리 모달 닫기
        function closeProcessModal() {
            closeModal('processModal');
            currentProcessingCall = null;
            hideAlert('processModalError');
        }

        // OB콜 처리 저장
        async function saveProcess() {
            const processStatus = document.getElementById('processStatus').value;
            const processManager = document.getElementById('processManager').value.trim();
            const processNote = document.getElementById('processNote').value.trim();

            if (!processStatus || !processManager) {
                showAlert('processModalError', '처리 여부와 처리담당자를 모두 입력해주세요.', 'error');
                return;
            }

            try {
                // 버튼 상태 변경
                const saveBtn = document.querySelector('#processModal .btn-success');
                const btnText = document.getElementById('processSaveBtnText');
                saveBtn.disabled = true;
                btnText.textContent = '저장 중...';

                // 그룹의 모든 콜에 대해 업데이트
                const callsToUpdate = currentProcessingCall.groupCalls || [currentProcessingCall];
                
                for (const call of callsToUpdate) {
                    const updateData = {
                        rowIndex: call.rowIndex,
                        processStatus: processStatus,
                        processManager: processManager,
                        processNote: processNote
                    };
                    
                    // Apps Script의 updateCall 액션 사용
                    const result = await GoogleAppsScriptAPI.updateCall(call.rowIndex, updateData);
                    
                    if (!result.success) {
                        throw new Error(result.error || '업데이트 실패');
                    }
                }

                closeProcessModal();
                
                // 화면 새로고침
                await searchCalls();
                
                alert(`✅ OB콜 처리가 완료되었습니다.\n📞 ${currentProcessingCall.phoneNumber}\n✨ ${processStatus} (${processManager})`);

            } catch (error) {
                Utils.debugLog('처리 저장 오류:', error);
                showAlert('processModalError', '처리 저장 중 오류가 발생했습니다: ' + error.message, 'error');
            } finally {
                // 버튼 복원
                const saveBtn = document.querySelector('#processModal .btn-success');
                const btnText = document.getElementById('processSaveBtnText');
                saveBtn.disabled = false;
                btnText.textContent = '💾 처리 완료';
            }
        }

        // 비밀번호 표시/숨기기 토글
        function togglePassword(inputId) {
            const input = document.getElementById(inputId);
            const button = input.nextElementSibling;
            
            if (input.type === 'password') {
                input.type = 'text';
                button.textContent = '🙈';
            } else {
                input.type = 'password';
                button.textContent = '👁️';
            }
        }

        // 알림 메시지 표시
        function showAlert(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `alert alert-${type}`;
            element.classList.remove('hidden');
            
            if (type === 'success') {
                setTimeout(() => hideAlert(elementId), CONFIG.UI.TOAST_DURATION);
            }
        }

        // 알림 메시지 숨기기
        function hideAlert(elementId) {
            document.getElementById(elementId).classList.add('hidden');
        }

        // 요소 표시
        function showElement(elementId) {
            document.getElementById(elementId).classList.remove('hidden');
        }

        // 요소 숨기기
        function hideElement(elementId) {
            document.getElementById(elementId).classList.add('hidden');
        }

        // 모달 닫기
        function closeModal(modal) {
            if (typeof modal === 'string') {
                modal = document.getElementById(modal);
            }
            modal.classList.remove('show');
        }

        // 로딩 표시
        function showLoading(elementId) {
            showElement(elementId);
        }

        // 로딩 숨기기
        function hideLoading(elementId) {
            hideElement(elementId);
        }
    </script>
</body>
</html>
