<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>íˆ¬ì–´ë¹„ìŠ¤ í•­ê³µ(êµ­ì œì„ ) Missing Call ì²˜ë¦¬ ì‹œìŠ¤í…œ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        /* ë¡œë”© ìŠ¤í”¼ë„ˆ */
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f4f6;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ë¡œë”© ë©”ì‹œì§€ */
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        /* ë¡œê·¸ì¸ í™”ë©´ ìŠ¤íƒ€ì¼ */
        .login-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-box {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .login-header {
            margin-bottom: 30px;
        }

        .login-header h1 {
            color: #333;
            font-size: 1.8rem;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .login-header p {
            color: #666;
            font-size: 1rem;
        }

        /* í¼ ìŠ¤íƒ€ì¼ */
        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
            font-family: inherit;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .password-container {
            position: relative;
        }

        .password-toggle {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            color: #666;
            font-size: 0.9rem;
            user-select: none;
            padding: 5px;
        }

        .password-toggle:hover {
            color: #333;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 20px;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
        }

        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: inline-block;
            text-decoration: none;
            text-align: center;
            line-height: 1.2;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #5a6268;
            transform: translateY(-1px);
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(16, 185, 129, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(239, 68, 68, 0.3);
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 0.85rem;
        }

        /* ë©”ì¸ ëŒ€ì‹œë³´ë“œ ìŠ¤íƒ€ì¼ */
        .main-container {
            display: none;
            min-height: 100vh;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 15px 30px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #333;
            font-size: 1.5rem;
            font-weight: 300;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-name {
            color: #333;
            font-weight: 500;
        }

        .user-role {
            color: #666;
            font-size: 0.9rem;
            padding: 2px 8px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 12px;
        }

        .nav-menu {
            background: rgba(255, 255, 255, 0.9);
            padding: 15px 30px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .nav-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
        }

        .nav-btn:hover, .nav-btn.active {
            background: #667eea;
            color: white;
        }

        .content {
            padding: 30px;
            flex: 1;
        }

        .section {
            display: none;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .section.active {
            display: block;
        }

        .section-header {
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f1f3f4;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-header h2 {
            color: #333;
            font-size: 1.4rem;
            font-weight: 500;
        }

        /* ê²€ìƒ‰ ì„¹ì…˜ */
        .search-section {
            background: #f8f9ff;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            border: 2px solid #e0e7ff;
        }

        .search-form {
            display: flex;
            gap: 15px;
            align-items: end;
            flex-wrap: wrap;
        }

        /* í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #f1f3f4;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        td {
            color: #555;
        }

        /* ìƒíƒœ ë°°ì§€ */
        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-align: center;
            display: inline-block;
            min-width: 60px;
        }

        .status-processed { 
            background: #d1fae5; 
            color: #065f46; 
        }
        
        .status-pending { 
            background: #fee2e2; 
            color: #991b1b; 
        }
        
        .status-admin { 
            background: #dbeafe; 
            color: #1e40af; 
        }
        
        .status-manager { 
            background: #fef3c7; 
            color: #92400e; 
        }
        
        .status-user { 
            background: #f3f4f6; 
            color: #374151; 
        }

        .call-count {
            background: #fef3c7;
            color: #92400e;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            text-align: center;
            min-width: 60px;
            display: inline-block;
        }

        .phone-number {
            font-family: 'Courier New', monospace;
            font-weight: 600;
            color: #1f2937;
        }

        .time-display {
            font-family: 'Courier New', monospace;
            color: #4b5563;
        }

        /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #f1f3f4;
        }

        .modal-header h3 {
            color: #333;
            font-size: 1.3rem;
            font-weight: 500;
            margin-bottom: 5px;
        }

        .modal-footer {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #f1f3f4;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        /* ì•Œë¦¼ ë©”ì‹œì§€ */
        .alert {
            padding: 12px 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-size: 0.9rem;
        }

        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }

        .alert-error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }

        .alert-info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #bfdbfe;
        }

        .alert-warning {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #fde68a;
        }

        /* ì—°ê²° ìƒíƒœ ì¸ë””ì¼€ì´í„° */
        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            z-index: 999;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .connection-status.show {
            opacity: 1;
        }

        .connection-status.connected {
            background: #d1fae5;
            color: #065f46;
        }

        .connection-status.disconnected {
            background: #fee2e2;
            color: #991b1b;
        }

        .connection-status.testing {
            background: #fef3c7;
            color: #92400e;
        }

        /* ìœ í‹¸ë¦¬í‹° í´ë˜ìŠ¤ */
        .hidden { 
            display: none !important; 
        }

        .text-center { 
            text-align: center; 
        }

        .mb-0 { margin-bottom: 0; }
        .mb-10 { margin-bottom: 10px; }
        .mb-20 { margin-bottom: 20px; }
        .mt-10 { margin-top: 10px; }
        .mt-20 { margin-top: 20px; }

        .text-small {
            font-size: 0.8rem;
            color: #666;
        }

        /* ë°˜ì‘í˜• ë””ìì¸ */
        @media (max-width: 768px) {
            .header {
                padding: 15px 20px;
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }

            .nav-menu {
                padding: 15px 20px;
            }

            .content {
                padding: 20px;
            }

            .nav-buttons {
                justify-content: center;
            }

            .modal-content {
                margin: 20px;
                padding: 20px;
                max-width: none;
            }

            .search-form {
                flex-direction: column;
                align-items: stretch;
            }

            .form-group {
                width: 100%;
            }

            .section-header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .table-container {
                font-size: 0.85rem;
            }

            th, td {
                padding: 8px 6px;
            }

            .btn {
                width: 100%;
                margin-bottom: 10px;
            }

            .modal-footer {
                flex-direction: column;
            }

            .modal-footer .btn {
                margin-bottom: 0;
            }

            .user-info {
                flex-direction: column;
                gap: 8px;
            }

            .connection-status {
                position: static;
                margin: 10px auto;
                display: block;
                text-align: center;
                width: fit-content;
            }
        }

        @media (max-width: 480px) {
            .login-box {
                padding: 30px 20px;
            }

            .header h1 {
                font-size: 1.2rem;
            }

            .content {
                padding: 15px;
            }

            .section {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- ì—°ê²° ìƒíƒœ í‘œì‹œ -->
    <div id="connectionStatus" class="connection-status">
        <span id="connectionText">ì—°ê²° í™•ì¸ ì¤‘...</span>
    </div>

    <!-- ë¡œë”© í™”ë©´ -->
    <div id="initialLoading" class="login-container">
        <div class="login-box text-center">
            <h2>ğŸš€ ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì¤‘...</h2>
            <div class="loading">
                ì„¤ì •ì„ í™•ì¸í•˜ê³  ìˆìŠµë‹ˆë‹¤<span class="spinner"></span>
            </div>
            <div id="initStatus" class="text-small mt-20">
                <!-- ì´ˆê¸°í™” ìƒíƒœ ë©”ì‹œì§€ -->
            </div>
        </div>
    </div>

    <!-- ë¡œê·¸ì¸ í™”ë©´ -->
    <div id="loginContainer" class="login-container hidden">
        <div class="login-box">
            <div class="login-header">
                <h1>íˆ¬ì–´ë¹„ìŠ¤</h1>
                <p>í•­ê³µ(êµ­ì œì„ ) Missing Call ì²˜ë¦¬ ì‹œìŠ¤í…œ</p>
            </div>
            
            <form id="loginForm">
                <div class="form-group">
                    <label for="loginUsername">ì‚¬ìš©ì ID</label>
                    <input type="text" id="loginUsername" required autocomplete="username" placeholder="ì‚¬ìš©ì IDë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                </div>
                
                <div class="form-group">
                    <label for="loginPassword">ë¹„ë°€ë²ˆí˜¸</label>
                    <div class="password-container">
                        <input type="password" id="loginPassword" required autocomplete="current-password" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                        <button type="button" class="password-toggle" onclick="togglePassword('loginPassword')">ğŸ‘ï¸</button>
                    </div>
                </div>
                
                <div class="checkbox-group">
                    <input type="checkbox" id="rememberMe">
                    <label for="rememberMe">ë¡œê·¸ì¸ ìƒíƒœ ìœ ì§€ (7ì¼)</label>
                </div>
                
                <button type="submit" class="btn btn-primary">
                    <span id="loginBtnText">ë¡œê·¸ì¸</span>
                </button>
            </form>
            
            <div id="loginError" class="alert alert-error hidden"></div>
            
            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee; font-size: 0.85rem; color: #666; text-align: center;">
                Â© 2025 TideSquare. All rights reserved.<br>
                <span class="text-small">ê¸°ë³¸ ê³„ì •: admin / admin123</span>
            </div>
        </div>
    </div>

    <!-- ë©”ì¸ ëŒ€ì‹œë³´ë“œ -->
    <div id="mainContainer" class="main-container">
        <div class="header">
            <h1>íˆ¬ì–´ë¹„ìŠ¤ Missing Call ê´€ë¦¬ ì‹œìŠ¤í…œ</h1>
            <div class="user-info">
                <span class="user-name" id="currentUserName">ì‚¬ìš©ì</span>
                <span class="user-role" id="currentUserRole">ê¶Œí•œ</span>
                <button class="btn btn-secondary btn-small" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </div>

        <div class="nav-menu">
            <div class="nav-buttons">
                <button class="nav-btn active" onclick="showSection('dashboard')">ğŸ“Š ëŒ€ì‹œë³´ë“œ</button>
                <button class="nav-btn hidden" onclick="showSection('users')" id="usersMenuBtn">ğŸ‘¥ ì‚¬ìš©ì ê´€ë¦¬</button>
            </div>
        </div>

        <div class="content">
            <!-- ëŒ€ì‹œë³´ë“œ ì„¹ì…˜ -->
            <div id="dashboardSection" class="section active">
                <div class="section-header">
                    <h2>Missing Call ì²˜ë¦¬ í˜„í™©</h2>
                    <div>
                        <button class="btn btn-secondary btn-small" onclick="refreshConnection()">ğŸ”„ ì—°ê²° í™•ì¸</button>
                    </div>
                </div>
                
                <div class="search-section">
                    <div class="search-form">
                        <div class="form-group">
                            <label for="searchDate">ì¡°íšŒ ì¼ì</label>
                            <input type="date" id="searchDate">
                        </div>
                        <div class="form-group">
                            <button type="button" class="btn btn-primary" onclick="searchCalls()">
                                ğŸ“‹ ì¡°íšŒ
                            </button>
                        </div>
                    </div>
                </div>

                <div id="loadingMessage" class="loading hidden">
                    ë°ì´í„°ë¥¼ ì¡°íšŒí•˜ê³  ìˆìŠµë‹ˆë‹¤<span class="spinner"></span>
                </div>

                <div id="callsResults" class="hidden">
                    <div style="margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                        <h3 id="resultsCount" style="color: #333; margin: 0;">ì¡°íšŒ ê²°ê³¼</h3>
                        <div>
                            <button class="btn btn-secondary btn-small" onclick="searchCalls()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
                            <button class="btn btn-primary btn-small" onclick="exportToCSV()" style="margin-left: 10px;">ğŸ“¥ CSV ë‚´ë³´ë‚´ê¸°</button>
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <table id="callsTable">
                            <thead>
                                <tr>
                                    <th>ë°œìƒì¼</th>
                                    <th>ì¸ì…ì‹œê°„</th>
                                    <th>ëŒ€ê¸°ì‹œê°„(ë¶„)</th>
                                    <th>ì „í™”ë²ˆí˜¸</th>
                                    <th>ì¸ì…í</th>
                                    <th>ì¤‘ë³µíšŸìˆ˜</th>
                                    <th>ì²˜ë¦¬ìƒíƒœ</th>
                                    <th>ì²˜ë¦¬ë‹´ë‹¹ì</th>
                                    <th>ì•¡ì…˜</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <div id="noDataMessage" class="text-center hidden" style="padding: 40px; color: #666;">
                    <h3>ğŸ“­ ì¡°íšŒëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</h3>
                    <p>ë‹¤ë¥¸ ë‚ ì§œë¥¼ ì„ íƒí•´ì„œ ì¡°íšŒí•´ë³´ì„¸ìš”.</p>
                </div>
            </div>

            <!-- ì‚¬ìš©ì ê´€ë¦¬ ì„¹ì…˜ -->
            <div id="usersSection" class="section">
                <div class="section-header">
                    <h2>ì‚¬ìš©ì ê´€ë¦¬</h2>
                    <button class="btn btn-primary" onclick="openUserModal()">â• ìƒˆ ì‚¬ìš©ì ì¶”ê°€</button>
                </div>

                <div id="usersLoading" class="loading hidden">
                    ì‚¬ìš©ì ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ê³  ìˆìŠµë‹ˆë‹¤<span class="spinner"></span>
                </div>

                <div id="usersResults" class="table-container">
                    <table id="usersTable">
                        <thead>
                            <tr>
                                <th>ì‚¬ìš©ì ID</th>
                                <th>ì‹¤ëª…</th>
                                <th>ì´ë©”ì¼</th>
                                <th>ê¶Œí•œ</th>
                                <th>ë“±ë¡ì¼</th>
                                <th>ë§ˆì§€ë§‰ ë¡œê·¸ì¸</th>
                                <th>ì•¡ì…˜</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- ì‚¬ìš©ì ë“±ë¡/ìˆ˜ì • ëª¨ë‹¬ -->
    <div id="userModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="userModalTitle">ì‚¬ìš©ì ì¶”ê°€</h3>
            </div>
            
            <form id="userForm">
                <input type="hidden" id="userId">
                
                <div class="form-group">
                    <label for="userUsername">ì‚¬ìš©ì ID *</label>
                    <input type="text" id="userUsername" required placeholder="ì˜ë¬¸/ìˆ«ìë¡œ ì…ë ¥í•˜ì„¸ìš”" autocomplete="username">
                </div>
                
                <div class="form-group">
                    <label for="userPassword">ë¹„ë°€ë²ˆí˜¸ *</label>
                    <div class="password-container">
                        <input type="password" id="userPassword" placeholder="6ì ì´ìƒ ì…ë ¥í•˜ì„¸ìš”" autocomplete="new-password">
                        <button type="button" class="password-toggle" onclick="togglePassword('userPassword')">ğŸ‘ï¸</button>
                    </div>
                    <small class="text-small">ìˆ˜ì •ì‹œ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë³€ê²½í•˜ì§€ ì•Šìœ¼ë ¤ë©´ ë¹„ì›Œë‘ì„¸ìš”</small>
                </div>
                
                <div class="form-group">
                    <label for="userName">ì‹¤ëª… *</label>
                    <input type="text" id="userName" required placeholder="ì‹¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”" autocomplete="name">
                </div>
                
                <div class="form-group">
                    <label for="userEmail">ì´ë©”ì¼ *</label>
                    <input type="email" id="userEmail" required placeholder="email@example.com" autocomplete="email">
                </div>
                
                <div class="form-group">
                    <label for="userRole">ê¶Œí•œ *</label>
                    <select id="userRole" required>
                        <option value="">ê¶Œí•œì„ ì„ íƒí•˜ì„¸ìš”</option>
                        <option value="user">ì¼ë°˜ ì‚¬ìš©ì</option>
                        <option value="manager">ê´€ë¦¬ì</option>
                        <option value="admin">ì‹œìŠ¤í…œ ê´€ë¦¬ì</option>
                    </select>
                </div>
            </form>

            <div id="userModalError" class="alert alert-error hidden"></div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeUserModal()">ì·¨ì†Œ</button>
                <button type="button" class="btn btn-success" onclick="saveUser()">
                    <span id="userSaveBtnText">ğŸ’¾ ì €ì¥</span>
                </button>
            </div>
        </div>
    </div>

    <!-- OBì½œ ì²˜ë¦¬ ëª¨ë‹¬ -->
    <div id="processModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ğŸ“ OBì½œ ì²˜ë¦¬</h3>
                <p style="color: #666; margin: 5px 0 0 0;">
                    ì „í™”ë²ˆí˜¸: <span id="modalPhoneNumber" class="phone-number"></span><br>
                    <span id="modalCallInfo" style="font-size: 0.9rem;"></span>
                </p>
            </div>
            
            <form id="processForm">
                <div class="form-group">
                    <label for="processStatus">ì²˜ë¦¬ ì—¬ë¶€ *</label>
                    <select id="processStatus" required>
                        <option value="">ì„ íƒí•´ì£¼ì„¸ìš”</option>
                        <option value="ì™„ë£Œ">âœ… ì™„ë£Œ</option>
                        <option value="ë¯¸ì™„ë£Œ">âŒ ë¯¸ì™„ë£Œ</option>
                        <option value="ë³´ë¥˜">â¸ï¸ ë³´ë¥˜</option>
                        <option value="ì¬ì‹œë„">ğŸ”„ ì¬ì‹œë„ í•„ìš”</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="processManager">ì²˜ë¦¬ë‹´ë‹¹ì *</label>
                    <input type="text" id="processManager" required placeholder="ë‹´ë‹¹ìëª…ì„ ì…ë ¥í•˜ì„¸ìš”" autocomplete="name">
                </div>

                <div class="form-group">
                    <label for="processNote">ì²˜ë¦¬ ë©”ëª¨ (ì„ íƒ)</label>
                    <textarea id="processNote" rows="3" placeholder="ì²˜ë¦¬ ë‚´ìš©ì´ë‚˜ íŠ¹ì´ì‚¬í•­ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                </div>
            </form>

            <div id="processModalError" class="alert alert-error hidden"></div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeProcessModal()">ì·¨ì†Œ</button>
                <button type="button" class="btn btn-success" onclick="saveProcess()">
                    <span id="processSaveBtnText">ğŸ’¾ ì²˜ë¦¬ ì™„ë£Œ</span>
                </button>
            </div>
        </div>
    </div>

    <!-- config.js íŒŒì¼ ë¡œë“œ -->
    <script src="config.js"></script>
    
    <script>
        // ì „ì—­ ë³€ìˆ˜
        let currentUser = null;
        let currentCallsData = [];
        let currentUsersData = [];
        let currentProcessingCall = null;
        let connectionCheckInterval = null;

        // í˜ì´ì§€ ë¡œë“œì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        // ì•± ì´ˆê¸°í™”
        async function initializeApp() {
            Utils.debugLog('ì•± ì´ˆê¸°í™” ì‹œì‘');
            
            try {
                // ì´ˆê¸°í™” ìƒíƒœ í‘œì‹œ
                updateInitStatus('ì„¤ì • íŒŒì¼ ê²€ì¦ ì¤‘...');
                
                // ì„¤ì • ê²€ì¦
                if (!validateConfig()) {
                    showError('ì„¤ì • íŒŒì¼ì— ì˜¤ë¥˜ê°€ ìˆìŠµë‹ˆë‹¤. config.jsë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.');
                    return;
                }

                updateInitStatus('ì—°ê²° í…ŒìŠ¤íŠ¸ ì¤‘...');
                
                // Apps Script ì—°ê²° í…ŒìŠ¤íŠ¸
                if (CONFIG.API.API_TYPE === 'apps_script') {
                    try {
                        const result = await GoogleAppsScriptAPI.testConnection();
                        if (result.success) {
                            showConnectionStatus('connected', 'âœ… ì—°ê²°ë¨');
                            Utils.debugLog('âœ… Apps Script ì—°ê²° í…ŒìŠ¤íŠ¸ ì„±ê³µ');
                        } else {
                            showConnectionStatus('disconnected', 'âŒ ì—°ê²° ì‹¤íŒ¨');
                            Utils.debugLog('âš ï¸ Apps Script ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨:', result.message);
                        }
                    } catch (error) {
                        showConnectionStatus('disconnected', 'âŒ ì—°ê²° ì‹¤íŒ¨');
                        Utils.debugLog('âš ï¸ Apps Script ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨:', error.message);
                    }
                }

                updateInitStatus('ì„¸ì…˜ í™•ì¸ ì¤‘...');

                // ì„¸ì…˜ í™•ì¸
                const session = SessionManager.getSession();
                if (session) {
                    Utils.debugLog('ê¸°ì¡´ ì„¸ì…˜ ë°œê²¬:', session.username);
                    await loginSuccess(session);
                } else {
                    showLoginScreen();
                }

                // ì˜¤ëŠ˜ ë‚ ì§œë¡œ ì„¤ì •
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('searchDate').value = today;

                // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
                setupEventListeners();

                // ì£¼ê¸°ì  ì—°ê²° í™•ì¸ ì‹œì‘
                startConnectionMonitoring();

            } catch (error) {
                Utils.debugLog('ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
                showError('ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        // ì´ˆê¸°í™” ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateInitStatus(message) {
            const statusEl = document.getElementById('initStatus');
            if (statusEl) {
                statusEl.textContent = message;
            }
        }

        // ì—°ê²° ìƒíƒœ í‘œì‹œ
        function showConnectionStatus(status, text) {
            const statusEl = document.getElementById('connectionStatus');
            const textEl = document.getElementById('connectionText');
            
            statusEl.className = `connection-status ${status} show`;
            textEl.textContent = text;
            
            // 3ì´ˆ í›„ ìë™ ìˆ¨ê¹€ (ì—°ê²°ë¨ ìƒíƒœë§Œ)
            if (status === 'connected') {
                setTimeout(() => {
                    statusEl.classList.remove('show');
                }, 3000);
            }
        }

        // ì—°ê²° ëª¨ë‹ˆí„°ë§ ì‹œì‘
        function startConnectionMonitoring() {
            // 5ë¶„ë§ˆë‹¤ ì—°ê²° ìƒíƒœ í™•ì¸
            connectionCheckInterval = setInterval(async () => {
                try {
                    const result = await GoogleAppsScriptAPI.testConnection();
                    if (!result.success) {
                        showConnectionStatus('disconnected', 'âŒ ì—°ê²° ëŠê¹€');
                    }
                } catch (error) {
                    showConnectionStatus('disconnected', 'âŒ ì—°ê²° ëŠê¹€');
                }
            }, 5 * 60 * 1000); // 5ë¶„
        }

        // ì—°ê²° ìƒˆë¡œê³ ì¹¨
        async function refreshConnection() {
            showConnectionStatus('testing', 'ğŸ”„ ì—°ê²° í™•ì¸ ì¤‘...');
            
            try {
                const result = await GoogleAppsScriptAPI.testConnection();
                if (result.success) {
                    showConnectionStatus('connected', 'âœ… ì—°ê²° ë³µêµ¬ë¨');
                } else {
                    showConnectionStatus('disconnected', 'âŒ ì—°ê²° ì‹¤íŒ¨');
                    alert('âŒ ì—°ê²° í™•ì¸ ì‹¤íŒ¨: ' + result.message);
                }
            } catch (error) {
                showConnectionStatus('disconnected', 'âŒ ì—°ê²° ì‹¤íŒ¨');
                alert('âŒ ì—°ê²° í™•ì¸ ì‹¤íŒ¨: ' + error.message);
            }
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        function setupEventListeners() {
            // ë¡œê·¸ì¸ í¼
            document.getElementById('loginForm').addEventListener('submit', function(e) {
                e.preventDefault();
                handleLogin();
            });

            // ì‚¬ìš©ì í¼
            document.getElementById('userForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveUser();
            });

            // ì²˜ë¦¬ í¼
            document.getElementById('processForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveProcess();
            });

            // Enter í‚¤ ì²˜ë¦¬
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    const activeModal = document.querySelector('.modal.show');
                    if (activeModal) {
                        const primaryButton = activeModal.querySelector('.btn-success, .btn-primary');
                        if (primaryButton && !primaryButton.disabled) {
                            primaryButton.click();
                        }
                    }
                }
                
                // ESC í‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸°
                if (e.key === 'Escape') {
                    const openModal = document.querySelector('.modal.show');
                    if (openModal) {
                        closeModal(openModal);
                    }
                }
            });

            // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ì‹œ ë‹«ê¸°
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('modal')) {
                    closeModal(e.target);
                }
            });

            // í˜ì´ì§€ ì–¸ë¡œë“œì‹œ ì •ë¦¬
            window.addEventListener('beforeunload', function() {
                if (connectionCheckInterval) {
                    clearInterval(connectionCheckInterval);
                }
            });
        }

        // ì˜¤ë¥˜ í‘œì‹œ
        function showError(message) {
            document.getElementById('initialLoading').innerHTML = `
                <div class="login-box text-center">
                    <h2 style="color: #dc2626;">âŒ ì˜¤ë¥˜ ë°œìƒ</h2>
                    <div class="alert alert-error">${message}</div>
                    <button class="btn btn-primary mt-20" onclick="location.reload()">ğŸ”„ ë‹¤ì‹œ ì‹œë„</button>
                </div>
            `;
        }

        // ë¡œê·¸ì¸ ì²˜ë¦¬
        async function handleLogin() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            const rememberMe = document.getElementById('rememberMe').checked;

            if (!username || !password) {
                showAlert('loginError', 'ì‚¬ìš©ì IDì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            try {
                Utils.debugLog('ë¡œê·¸ì¸ ì‹œë„:', username);
                
                // ë²„íŠ¼ ìƒíƒœ ë³€ê²½
                const loginBtn = document.querySelector('#loginForm .btn-primary');
                const btnText = document.getElementById('loginBtnText');
                loginBtn.disabled = true;
                btnText.textContent = 'ë¡œê·¸ì¸ ì¤‘...';
                
                // ì‚¬ìš©ì ì¸ì¦ (Apps Scriptì˜ authenticate ì•¡ì…˜ ì‚¬ìš©)
                const result = await GoogleAppsScriptAPI.authenticate(username, password);
                
                if (result.success && result.user) {
                    // ì„¸ì…˜ ìƒì„±
                    SessionManager.setSession(result.user, rememberMe);
                    await loginSuccess(result.user);
                } else {
                    showAlert('loginError', result.error || 'ì‚¬ìš©ì ID ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'error');
                }
            } catch (error) {
                Utils.debugLog('ë¡œê·¸ì¸ ì˜¤ë¥˜:', error);
                showAlert('loginError', 'ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
            } finally {
                // ë²„íŠ¼ ë³µì›
                const loginBtn = document.querySelector('#loginForm .btn-primary');
                const btnText = document.getElementById('loginBtnText');
                loginBtn.disabled = false;
                btnText.textContent = 'ë¡œê·¸ì¸';
            }
        }

        // ë¡œê·¸ì¸ ì„±ê³µ ì²˜ë¦¬
        async function loginSuccess(user) {
            currentUser = user;
            
            // UI ì—…ë°ì´íŠ¸
            document.getElementById('currentUserName').textContent = user.name;
            document.getElementById('currentUserRole').textContent = getRoleDisplayName(user.role);
            
            // ê¶Œí•œì— ë”°ë¥¸ ë©”ë‰´ í‘œì‹œ
            const usersMenuBtn = document.getElementById('usersMenuBtn');
            if (SessionManager.hasRole('manager')) {
                usersMenuBtn.classList.remove('hidden');
            } else {
                usersMenuBtn.classList.add('hidden');
            }

            // í™”ë©´ ì „í™˜
            document.getElementById('initialLoading').classList.add('hidden');
            document.getElementById('loginContainer').classList.add('hidden');
            document.getElementById('mainContainer').style.display = 'block';

            Utils.debugLog('ë¡œê·¸ì¸ ì„±ê³µ:', user.name);
        }

        // ë¡œê·¸ì•„ì›ƒ
        function logout() {
            if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                SessionManager.clearSession();
                currentUser = null;
                
                // ì—°ê²° ëª¨ë‹ˆí„°ë§ ì¤‘ì§€
                if (connectionCheckInterval) {
                    clearInterval(connectionCheckInterval);
                }
                
                showLoginScreen();
                Utils.debugLog('ë¡œê·¸ì•„ì›ƒ ì™„ë£Œ');
            }
        }

        // ë¡œê·¸ì¸ í™”ë©´ í‘œì‹œ
        function showLoginScreen() {
            document.getElementById('initialLoading').classList.add('hidden');
            document.getElementById('loginContainer').classList.remove('hidden');
            document.getElementById('mainContainer').style.display = 'none';
            
            // í¼ ì´ˆê¸°í™”
            document.getElementById('loginForm').reset();
            hideAlert('loginError');
        }

        // ì„¹ì…˜ í‘œì‹œ
        function showSection(sectionName) {
            // ëª¨ë“  ì„¹ì…˜ ìˆ¨ê¸°ê¸°
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            // ëª¨ë“  ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ ë¹„í™œì„±í™”
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // ì„ íƒëœ ì„¹ì…˜ í‘œì‹œ
            document.getElementById(sectionName + 'Section').classList.add('active');
            
            // ì„ íƒëœ ë²„íŠ¼ í™œì„±í™”
            event.target.classList.add('active');

            // ì„¹ì…˜ë³„ ì´ˆê¸° ë¡œë”©
            if (sectionName === 'users' && SessionManager.hasRole('manager')) {
                loadUsersSection();
            }
        }

        // ì‚¬ìš©ì ê´€ë¦¬ ì„¹ì…˜ ë¡œë”©
        async function loadUsersSection() {
            if (!SessionManager.hasRole('manager')) {
                alert('âŒ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            try {
                showLoading('usersLoading');
                
                // Apps Scriptì˜ getUsers ì•¡ì…˜ ì‚¬ìš©
                const result = await GoogleAppsScriptAPI.getUsers();
                
                if (result.success) {
                    currentUsersData = result.users || [];
                    displayUsersResults(currentUsersData);
                } else {
                    throw new Error(result.error || 'ì‚¬ìš©ì ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                }
                
                hideLoading('usersLoading');
                
            } catch (error) {
                Utils.debugLog('ì‚¬ìš©ì ì„¹ì…˜ ë¡œë”© ì˜¤ë¥˜:', error);
                hideLoading('usersLoading');
                alert('âŒ ì‚¬ìš©ì ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        // ì‚¬ìš©ì ëª©ë¡ ê²°ê³¼ í‘œì‹œ
        function displayUsersResults(users) {
            const tbody = document.querySelector('#usersTable tbody');
            tbody.innerHTML = '';

            if (users.length === 0) {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td colspan="7" class="text-center" style="padding: 40px; color: #666;">
                        ğŸ‘¥ ë“±ë¡ëœ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.
                    </td>
                `;
                return;
            }

            users.forEach((user, index) => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td class="phone-number">${user.username}</td>
                    <td>${user.name}</td>
                    <td>${user.email}</td>
                    <td><span class="status-badge status-${user.role}">${getRoleDisplayName(user.role)}</span></td>
                    <td class="time-display">${user.createdAt || '-'}</td>
                    <td class="time-display">${user.lastLogin || '-'}</td>
                    <td style="white-space: nowrap;">
                        <button class="btn btn-primary btn-small" onclick="editUser(${index})" style="margin-right: 5px;">âœï¸ ìˆ˜ì •</button>
                        ${user.username !== currentUser.username ? 
                            `<button class="btn btn-danger btn-small" onclick="deleteUser(${index})">ğŸ—‘ï¸ ì‚­ì œ</button>` : 
                            '<span class="text-small">í˜„ì¬ ì‚¬ìš©ì</span>'
                        }
                    </td>
                `;
            });
        }

        // ê¶Œí•œ í‘œì‹œëª… ë°˜í™˜
        function getRoleDisplayName(role) {
            const roleNames = {
                'admin': 'ì‹œìŠ¤í…œ ê´€ë¦¬ì',
                'manager': 'ê´€ë¦¬ì', 
                'user': 'ì¼ë°˜ ì‚¬ìš©ì'
            };
            return roleNames[role] || role;
        }

        // ì‚¬ìš©ì ëª¨ë‹¬ ì—´ê¸°
        function openUserModal(user = null) {
            const isEdit = !!user;
            
            document.getElementById('userModalTitle').textContent = isEdit ? 'âœï¸ ì‚¬ìš©ì ìˆ˜ì •' : 'â• ì‚¬ìš©ì ì¶”ê°€';
            
            if (isEdit) {
                document.getElementById('userId').value = user.id;
                document.getElementById('userUsername').value = user.username;
                document.getElementById('userUsername').disabled = true;
                document.getElementById('userPassword').required = false;
                document.getElementById('userPassword').placeholder = 'ë³€ê²½í•˜ì§€ ì•Šìœ¼ë ¤ë©´ ë¹„ì›Œë‘ì„¸ìš”';
                document.getElementById('userName').value = user.name;
                document.getElementById('userEmail').value = user.email;
                document.getElementById('userRole').value = user.role;
            } else {
                document.getElementById('userForm').reset();
                document.getElementById('userUsername').disabled = false;
                document.getElementById('userPassword').required = true;
                document.getElementById('userPassword').placeholder = '6ì ì´ìƒ ì…ë ¥í•˜ì„¸ìš”';
            }

            hideAlert('userModalError');
            document.getElementById('userModal').classList.add('show');
            
            // ì²« ë²ˆì§¸ ì…ë ¥ í•„ë“œì— í¬ì»¤ìŠ¤
            setTimeout(() => {
                if (!isEdit) {
                    document.getElementById('userUsername').focus();
                } else {
                    document.getElementById('userName').focus();
                }
            }, 100);
        }

        // ì‚¬ìš©ì ëª¨ë‹¬ ë‹«ê¸°
        function closeUserModal() {
            closeModal('userModal');
        }

        // ì‚¬ìš©ì ìˆ˜ì •
        function editUser(index) {
            const user = currentUsersData[index];
            openUserModal(user);
        }

        // ì‚¬ìš©ì ì‚­ì œ
        async function deleteUser(index) {
            const user = currentUsersData[index];
            
            if (confirm(`âš ï¸ ì‚¬ìš©ì '${user.name}'ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) {
                try {
                    // Apps Scriptì˜ deleteUser ì•¡ì…˜ ì‚¬ìš©
                    const result = await GoogleAppsScriptAPI.deleteUser(user.id);

                    if (result.success) {
                        await loadUsersSection();
                        alert('âœ… ì‚¬ìš©ìê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    } else {
                        alert('âŒ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + result.error);
                    }
                } catch (error) {
                    Utils.debugLog('ì‚¬ìš©ì ì‚­ì œ ì˜¤ë¥˜:', error);
                    alert('âŒ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                }
            }
        }

        // ì‚¬ìš©ì ì €ì¥
        async function saveUser() {
            const userId = document.getElementById('userId').value;
            const username = document.getElementById('userUsername').value.trim();
            const password = document.getElementById('userPassword').value;
            const name = document.getElementById('userName').value.trim();
            const email = document.getElementById('userEmail').value.trim();
            const role = document.getElementById('userRole').value;

            // ìœ íš¨ì„± ê²€ì‚¬
            if (!username || !name || !email || !role) {
                showAlert('userModalError', 'í•„ìˆ˜ í•­ëª©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            if (!Utils.isValidEmail(email)) {
                showAlert('userModalError', 'ì˜¬ë°”ë¥¸ ì´ë©”ì¼ ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            if (!userId && !password) {
                showAlert('userModalError', 'ìƒˆ ì‚¬ìš©ìëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ í•„ìš”í•©ë‹ˆë‹¤.', 'error');
                return;
            }

            if (password) {
                const passwordValidation = Utils.isValidPassword(password);
                if (!passwordValidation.valid) {
                    showAlert('userModalError', passwordValidation.message, 'error');
                    return;
                }
            }

            try {
                const isEdit = !!userId;
                
                // ë²„íŠ¼ ìƒíƒœ ë³€ê²½
                const saveBtn = document.querySelector('#userModal .btn-success');
                const btnText = document.getElementById('userSaveBtnText');
                saveBtn.disabled = true;
                btnText.textContent = 'ì €ì¥ ì¤‘...';
                
                const userData = {
                    id: userId || Utils.generateUUID(),
                    username: username,
                    name: name,
                    email: email,
                    role: role,
                    createdAt: isEdit ? null : Utils.getCurrentDateTime(),
                    lastLogin: isEdit ? null : null
                };

                // ë¹„ë°€ë²ˆí˜¸ê°€ ìˆìœ¼ë©´ í•´ì‹œ ì²˜ë¦¬
                if (password) {
                    userData.passwordHash = Utils.simpleHash(password, username);
                }

                let result;
                if (isEdit) {
                    // Apps Scriptì˜ updateUser ì•¡ì…˜ ì‚¬ìš©
                    result = await GoogleAppsScriptAPI.updateUser(userId, userData);
                } else {
                    // Apps Scriptì˜ addUser ì•¡ì…˜ ì‚¬ìš©
                    result = await GoogleAppsScriptAPI.addUser(userData);
                }

                if (result.success) {
                    await loadUsersSection();
                    closeUserModal();
                    
                    alert(`âœ… ${isEdit ? 'ì‚¬ìš©ìê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ì‚¬ìš©ìê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.'}`);
                } else {
                    showAlert('userModalError', result.error || 'ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                }

            } catch (error) {
                Utils.debugLog('ì‚¬ìš©ì ì €ì¥ ì˜¤ë¥˜:', error);
                showAlert('userModalError', 'ì‚¬ìš©ì ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
            } finally {
                // ë²„íŠ¼ ë³µì›
                const saveBtn = document.querySelector('#userModal .btn-success');
                const btnText = document.getElementById('userSaveBtnText');
                saveBtn.disabled = false;
                btnText.textContent = 'ğŸ’¾ ì €ì¥';
            }
        }

        // Missing Call ì¡°íšŒ
        async function searchCalls() {
            const searchDate = document.getElementById('searchDate').value;
            if (!searchDate) {
                alert('ğŸ“… ì¡°íšŒí•  ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            try {
                showLoading('loadingMessage');
                hideElement('callsResults');
                hideElement('noDataMessage');
                
                // Apps Scriptì˜ getCalls ì•¡ì…˜ ì‚¬ìš©
                const result = await GoogleAppsScriptAPI.getCalls({ date: searchDate });
                
                let data = [];
                if (result.success) {
                    data = processCallData(result.calls || []);
                } else {
                    throw new Error(result.error || 'ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                }
                
                currentCallsData = data;
                
                if (data.length > 0) {
                    displayCallsResults(data);
                    showElement('callsResults');
                } else {
                    showElement('noDataMessage');
                }
                
                hideLoading('loadingMessage');
                
            } catch (error) {
                Utils.debugLog('ì¡°íšŒ ì˜¤ë¥˜:', error);
                hideLoading('loadingMessage');
                alert('âŒ ë°ì´í„° ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        // ì½œ ë°ì´í„° ì²˜ë¦¬ (ì¤‘ë³µ ê·¸ë£¹í™”)
        function processCallData(rawCalls) {
            const groups = {};
            
            // ì „í™”ë²ˆí˜¸ë³„ë¡œ ê·¸ë£¹í•‘
            rawCalls.forEach((call, index) => {
                const phoneNumber = call.phoneNumber;
                if (!groups[phoneNumber]) {
                    groups[phoneNumber] = [];
                }
                groups[phoneNumber].push({...call, originalIndex: index});
            });

            const processedData = [];

            Object.keys(groups).forEach(phoneNumber => {
                const calls = groups[phoneNumber];
                
                // ì‹œê°„ìˆœìœ¼ë¡œ ì •ë ¬
                calls.sort((a, b) => {
                    const timeA = new Date(`${a.date} ${a.startTime}`);
                    const timeB = new Date(`${b.date} ${b.startTime}`);
                    return timeA - timeB;
                });

                // OBì½œ ì²˜ë¦¬ê°€ ëœ ì½œë“¤ì„ ê¸°ì¤€ìœ¼ë¡œ ê·¸ë£¹ ë¶„ë¦¬
                let currentGroup = [];
                
                for (let i = 0; i < calls.length; i++) {
                    const call = calls[i];
                    currentGroup.push(call);
                    
                    // ë‹¤ìŒ ì½œì´ ìˆê³ , í˜„ì¬ ì½œì´ ì²˜ë¦¬ë˜ì—ˆìœ¼ë©°, ë‹¤ìŒ ì½œì´ ì²˜ë¦¬ë˜ì§€ ì•Šì•˜ë‹¤ë©´ ê·¸ë£¹ ì¢…ë£Œ
                    if (i < calls.length - 1) {
                        const nextCall = calls[i + 1];
                        if (call.processStatus && !nextCall.processStatus) {
                            // í˜„ì¬ ê·¸ë£¹ ì²˜ë¦¬
                            if (currentGroup.length > 0) {
                                const latestCall = currentGroup[currentGroup.length - 1];
                                processedData.push({
                                    ...latestCall,
                                    callCount: currentGroup.length,
                                    groupCalls: [...currentGroup]
                                });
                            }
                            currentGroup = [];
                        }
                    }
                }
                
                // ë§ˆì§€ë§‰ ê·¸ë£¹ ì²˜ë¦¬
                if (currentGroup.length > 0) {
                    const latestCall = currentGroup[currentGroup.length - 1];
                    processedData.push({
                        ...latestCall,
                        callCount: currentGroup.length,
                        groupCalls: [...currentGroup]
                    });
                }
            });

            return processedData;
        }

        // ì½œ ë°ì´í„° ê²°ê³¼ í‘œì‹œ
        function displayCallsResults(data) {
            const countDiv = document.getElementById('resultsCount');
            const tbody = document.querySelector('#callsTable tbody');

            countDiv.textContent = `ğŸ“Š ì¡°íšŒ ê²°ê³¼: ${data.length}ê±´`;
            tbody.innerHTML = '';

            data.forEach((call, index) => {
                const row = tbody.insertRow();
                const waitMinutes = Math.round(call.duration / 60);
                
                row.innerHTML = `
                    <td>${call.date}</td>
                    <td class="time-display">${call.startTime}</td>
                    <td class="time-display">${waitMinutes}ë¶„</td>
                    <td class="phone-number">${call.phoneNumber}</td>
                    <td>${call.queue}</td>
                    <td><span class="call-count">${call.callCount}ë²ˆ</span></td>
                    <td>
                        <span class="status-badge ${call.processStatus ? 'status-processed' : 'status-pending'}">
                            ${call.processStatus ? 'âœ… ì²˜ë¦¬ì™„ë£Œ' : 'â³ ë¯¸ì²˜ë¦¬'}
                        </span>
                    </td>
                    <td>${call.processManager || '-'}</td>
                    <td>
                        <button class="btn btn-primary btn-small" onclick="openProcessModal(${index})">
                            ${call.processStatus ? 'âœï¸ ìˆ˜ì •' : 'ğŸ“ ì²˜ë¦¬'}
                        </button>
                    </td>
                `;
            });
        }

        // CSV ë‚´ë³´ë‚´ê¸°
        function exportToCSV() {
            if (currentCallsData.length === 0) {
                alert('ğŸ“­ ë‚´ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const headers = ['ë°œìƒì¼', 'ì¸ì…ì‹œê°„', 'ëŒ€ê¸°ì‹œê°„(ë¶„)', 'ì „í™”ë²ˆí˜¸', 'ì¸ì…í', 'ì¤‘ë³µíšŸìˆ˜', 'ì²˜ë¦¬ìƒíƒœ', 'ì²˜ë¦¬ë‹´ë‹¹ì'];
            const csvContent = [
                headers.join(','),
                ...currentCallsData.map(call => [
                    call.date,
                    call.startTime,
                    Math.round(call.duration / 60),
                    call.phoneNumber,
                    `"${call.queue}"`,
                    call.callCount,
                    call.processStatus || 'ë¯¸ì²˜ë¦¬',
                    call.processManager || ''
                ].join(','))
            ].join('\n');

            const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `missing_calls_${document.getElementById('searchDate').value}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // OBì½œ ì²˜ë¦¬ ëª¨ë‹¬ ì—´ê¸°
        function openProcessModal(index) {
            const call = currentCallsData[index];
            currentProcessingCall = { ...call, index };

            document.getElementById('modalPhoneNumber').textContent = call.phoneNumber;
            document.getElementById('modalCallInfo').textContent = 
                `${call.callCount > 1 ? call.callCount + 'ë²ˆ ì¤‘ë³µ | ' : ''}${call.queue} | ${Math.round(call.duration / 60)}ë¶„ ëŒ€ê¸°`;
            
            document.getElementById('processStatus').value = call.processStatus || '';
            document.getElementById('processManager').value = call.processManager || currentUser.name;
            document.getElementById('processNote').value = '';

            hideAlert('processModalError');
            document.getElementById('processModal').classList.add('show');
            
            // ì²˜ë¦¬ ìƒíƒœì— í¬ì»¤ìŠ¤
            setTimeout(() => {
                if (!call.processStatus) {
                    document.getElementById('processStatus').focus();
                } else {
                    document.getElementById('processManager').focus();
                }
            }, 100);
        }

        // OBì½œ ì²˜ë¦¬ ëª¨ë‹¬ ë‹«ê¸°
        function closeProcessModal() {
            closeModal('processModal');
            currentProcessingCall = null;
            hideAlert('processModalError');
        }

        // OBì½œ ì²˜ë¦¬ ì €ì¥
        async function saveProcess() {
            const processStatus = document.getElementById('processStatus').value;
            const processManager = document.getElementById('processManager').value.trim();
            const processNote = document.getElementById('processNote').value.trim();

            if (!processStatus || !processManager) {
                showAlert('processModalError', 'ì²˜ë¦¬ ì—¬ë¶€ì™€ ì²˜ë¦¬ë‹´ë‹¹ìë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            try {
                // ë²„íŠ¼ ìƒíƒœ ë³€ê²½
                const saveBtn = document.querySelector('#processModal .btn-success');
                const btnText = document.getElementById('processSaveBtnText');
                saveBtn.disabled = true;
                btnText.textContent = 'ì €ì¥ ì¤‘...';

                // ê·¸ë£¹ì˜ ëª¨ë“  ì½œì— ëŒ€í•´ ì—…ë°ì´íŠ¸
                const callsToUpdate = currentProcessingCall.groupCalls || [currentProcessingCall];
                
                for (const call of callsToUpdate) {
                    const updateData = {
                        rowIndex: call.rowIndex,
                        processStatus: processStatus,
                        processManager: processManager,
                        processNote: processNote
                    };
                    
                    // Apps Scriptì˜ updateCall ì•¡ì…˜ ì‚¬ìš©
                    const result = await GoogleAppsScriptAPI.updateCall(call.rowIndex, updateData);
                    
                    if (!result.success) {
                        throw new Error(result.error || 'ì—…ë°ì´íŠ¸ ì‹¤íŒ¨');
                    }
                }

                closeProcessModal();
                
                // í™”ë©´ ìƒˆë¡œê³ ì¹¨
                await searchCalls();
                
                alert(`âœ… OBì½œ ì²˜ë¦¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\nğŸ“ ${currentProcessingCall.phoneNumber}\nâœ¨ ${processStatus} (${processManager})`);

            } catch (error) {
                Utils.debugLog('ì²˜ë¦¬ ì €ì¥ ì˜¤ë¥˜:', error);
                showAlert('processModalError', 'ì²˜ë¦¬ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
            } finally {
                // ë²„íŠ¼ ë³µì›
                const saveBtn = document.querySelector('#processModal .btn-success');
                const btnText = document.getElementById('processSaveBtnText');
                saveBtn.disabled = false;
                btnText.textContent = 'ğŸ’¾ ì²˜ë¦¬ ì™„ë£Œ';
            }
        }

        // ë¹„ë°€ë²ˆí˜¸ í‘œì‹œ/ìˆ¨ê¸°ê¸° í† ê¸€
        function togglePassword(inputId) {
            const input = document.getElementById(inputId);
            const button = input.nextElementSibling;
            
            if (input.type === 'password') {
                input.type = 'text';
                button.textContent = 'ğŸ™ˆ';
            } else {
                input.type = 'password';
                button.textContent = 'ğŸ‘ï¸';
            }
        }

        // ì•Œë¦¼ ë©”ì‹œì§€ í‘œì‹œ
        function showAlert(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `alert alert-${type}`;
            element.classList.remove('hidden');
            
            if (type === 'success') {
                setTimeout(() => hideAlert(elementId), CONFIG.UI.TOAST_DURATION);
            }
        }

        // ì•Œë¦¼ ë©”ì‹œì§€ ìˆ¨ê¸°ê¸°
        function hideAlert(elementId) {
            document.getElementById(elementId).classList.add('hidden');
        }

        // ìš”ì†Œ í‘œì‹œ
        function showElement(elementId) {
            document.getElementById(elementId).classList.remove('hidden');
        }

        // ìš”ì†Œ ìˆ¨ê¸°ê¸°
        function hideElement(elementId) {
            document.getElementById(elementId).classList.add('hidden');
        }

        // ëª¨ë‹¬ ë‹«ê¸°
        function closeModal(modal) {
            if (typeof modal === 'string') {
                modal = document.getElementById(modal);
            }
            modal.classList.remove('show');
        }

        // ë¡œë”© í‘œì‹œ
        function showLoading(elementId) {
            showElement(elementId);
        }

        // ë¡œë”© ìˆ¨ê¸°ê¸°
        function hideLoading(elementId) {
            hideElement(elementId);
        }
    </script>
</body>
</html>
