<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>투어비스 항공(국제선) Missing Call 처리 시스템</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- 연결 상태 표시 -->
    <div id="connectionStatus" class="connection-status">
        <span id="connectionText">연결 확인 중...</span>
    </div>

    <!-- 로딩 화면 -->
    <div id="initialLoading" class="login-container">
        <div class="login-box text-center">
            <h2>🚀 시스템 초기화 중...</h2>
            <div class="loading">
                설정을 확인하고 있습니다<span class="spinner"></span>
            </div>
            <div id="initStatus" class="text-small mt-20">
                <!-- 초기화 상태 메시지 -->
            </div>
        </div>
    </div>

    <!-- 로그인 화면 -->
    <div id="loginContainer" class="login-container hidden">
        <div class="login-box">
            <div class="login-header">
                <h1>투어비스</h1>
                <p>항공(국제선) Missing Call 처리 시스템</p>
            </div>
            
            <form id="loginForm">
                <div class="form-group">
                    <label for="loginUsername">사용자 ID</label>
                    <input type="text" id="loginUsername" required autocomplete="username" placeholder="사용자 ID를 입력하세요" style="width: 100%; min-width: 250px;">
                </div>
                
                <div class="form-group">
                    <label for="loginPassword">비밀번호</label>
                    <div class="password-container">
                        <input type="password" id="loginPassword" required autocomplete="current-password" placeholder="비밀번호를 입력하세요" style="width: 100%; min-width: 250px;">
                        <button type="button" class="password-toggle" onclick="togglePassword('loginPassword')">👁️</button>
                    </div>
                </div>
                
                <div class="checkbox-group">
                    <input type="checkbox" id="rememberMe">
                    <label for="rememberMe">로그인 상태 유지 (7일)</label>
                </div>
                
                <button type="submit" class="btn btn-primary">
                    <span id="loginBtnText">로그인</span>
                </button>
                
                <button type="button" class="btn btn-secondary mt-10" onclick="openAccountRequestModal()" style="width: 100%;">
                    📧 계정 신청
                </button>
            </form>
            
            <div id="loginError" class="alert alert-error hidden"></div>
            
            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee; font-size: 0.85rem; color: #666; text-align: center;">
                © 2025 TideSquare. All rights reserved.<br>
                <span class="text-small">계정 문의: 김영훈 담당자</span>
            </div>
        </div>
    </div>

    <!-- 메인 컨테이너 -->
    <div id="mainContainer" class="main-container">
        <!-- 고정 헤더 -->
        <div class="fixed-header">
            <div class="header">
                <h1>투어비스 Missing Call 관리 시스템</h1>
                <div class="user-info">
                    <span class="user-name" id="currentUserName">사용자</span>
                    <span class="user-role" id="currentUserRole">권한</span>
                    <button class="btn btn-secondary btn-small" onclick="logout()" title="시스템에서 로그아웃">🚪 로그아웃</button>
                </div>
            </div>

            <div class="nav-menu">
                <div class="nav-buttons">
                    <button class="nav-btn active" onclick="showSection('dashboard')">📊 대시보드</button>
                    <button class="nav-btn hidden" onclick="showSection('users')" id="usersMenuBtn">👥 사용자 관리</button>
                    <button class="nav-btn hidden" onclick="showSection('requests')" id="requestsMenuBtn">📋 계정 신청 관리</button>
                </div>
            </div>
            
            <!-- 검색 섹션을 헤더로 이동 -->
            <div class="search-section">
                <div class="search-form">
                    <div class="form-group">
                        <label for="searchDate">조회 일자</label>
                        <input type="date" id="searchDate">
                    </div>
                    <div class="form-group">
                        <label for="processFilter">처리 상태</label>
                        <select id="processFilter">
                            <option value="all">전체</option>
                            <option value="processed">처리 완료</option>
                            <option value="pending">미처리</option>
                            <option value="onhold">보류</option>
                            <option value="retry">재시도 필요</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="queueFilter">인입큐</label>
                        <select id="queueFilter">
                            <option value="all">전체</option>
                            <option value="투어비스-항공 기타문의">기타문의</option>
                            <option value="투어비스-항공 환불문의">환불문의</option>
                            <option value="투어비스-항공 일정변경문의">일정변경문의</option>
                            <option value="투어비스-항공 예약내용확인">예약내용확인</option>
                            <option value="투어비스-항공 여권/체류자관련문의">여권/체류자관련문의</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <button type="button" class="btn btn-primary" onclick="searchCalls()">
                            📋 조회
                        </button>
                    </div>
                    <div class="form-group">
                        <button class="btn btn-secondary" onclick="refreshConnection()">🔄 연결 확인</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 컨텐츠 영역 -->
        <div class="content-wrapper">
            <!-- 대시보드 섹션 -->
            <div id="dashboardSection" class="section active">
                <div id="loadingMessage" class="loading hidden">
                    데이터를 조회하고 있습니다<span class="spinner"></span>
                </div>
                <div id="loadingMessage" class="loading hidden">
                    데이터를 조회하고 있습니다<span class="spinner"></span>
                </div>

                <div id="callsResults" class="results-container hidden">
                    <div class="results-header">
                        <h3 id="resultsCount">조회 결과</h3>
                        <div>
                            <button class="btn btn-secondary btn-small" onclick="searchCalls()" title="서버에서 최신 데이터를 가져옵니다">
                                🔄 새로고침
                            </button>
                            <button class="btn btn-primary btn-small" onclick="exportToCSV()" style="margin-left: 8px;">📥 CSV 내보내기</button>
                        </div>
                    </div>
                    
                    <div class="results-content">
                        <div class="table-container">
                            <table id="callsTable">
                                <thead>
                                    <tr>
                                        <th>순번</th>
                                        <th>발생일</th>
                                        <th class="sortable-header" onclick="sortTable('startTime')" title="클릭하여 정렬">
                                            인입시간
                                            <span id="sortArrow-startTime" class="sort-arrow desc active"></span>
                                        </th>
                                        <th>대기시간(분)</th>
                                        <th>전화번호</th>
                                        <th>인입큐</th>
                                        <th class="sortable-header" onclick="sortTable('callCount')" title="클릭하여 정렬">
                                            중복횟수
                                            <span id="sortArrow-callCount" class="sort-arrow none"></span>
                                        </th>
                                        <th>처리상태</th>
                                        <th>처리담당자</th>
                                        <th>액션</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="noDataMessage" class="no-data-message text-center hidden">
                    <h3 id="noDataTitle">📭 조회된 데이터가 없습니다</h3>
                    <p id="noDataSubtitle">다른 날짜를 선택하거나 필터 조건을 변경해보세요.</p>
                </div>
            </div>

            <!-- 사용자 관리 섹션 -->
            <div id="usersSection" class="section">
                <div class="section-header">
                    <h2>사용자 관리</h2>
                    <button class="btn btn-primary" onclick="openUserModal()">➕ 새 사용자 추가</button>
                </div>

                <div id="usersLoading" class="loading hidden">
                    사용자 목록을 불러오고 있습니다<span class="spinner"></span>
                </div>

                <div id="usersResults" class="table-container">
                    <table id="usersTable">
                        <thead>
                            <tr>
                                <th>사용자 ID</th>
                                <th>실명</th>
                                <th>이메일</th>
                                <th>권한</th>
                                <th>상태</th>
                                <th>등록일</th>
                                <th>마지막 로그인</th>
                                <th>액션</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- 계정 신청 관리 섹션 -->
            <div id="requestsSection" class="section">
                <div class="section-header">
                    <h2>계정 신청 관리</h2>
                    <button class="btn btn-secondary" onclick="loadRequestsSection()">🔄 새로고침</button>
                </div>

                <div id="requestsLoading" class="loading hidden">
                    계정 신청 목록을 불러오고 있습니다<span class="spinner"></span>
                </div>

                <div id="requestsResults" class="table-container">
                    <table id="requestsTable">
                        <thead>
                            <tr>
                                <th>신청일</th>
                                <th>신청자</th>
                                <th>이메일</th>
                                <th>연락처</th>
                                <th>부서/팀</th>
                                <th>요청 권한</th>
                                <th>희망 ID</th>
                                <th>상태</th>
                                <th>액션</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <div id="noRequestsMessage" class="text-center hidden" style="padding: 40px; color: #666;">
                    <h3>📭 대기 중인 계정 신청이 없습니다</h3>
                    <p>새로운 신청이 접수되면 여기에 표시됩니다.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 사용자 등록/수정 모달 -->
    <div id="userModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="userModalTitle">사용자 추가</h3>
            </div>
            
            <form id="userForm">
                <input type="hidden" id="userId">
                
                <div class="form-group">
                    <label for="userUsername">사용자 ID *</label>
                    <input type="text" id="userUsername" required placeholder="영문/숫자로 입력하세요" autocomplete="username">
                </div>
                
                <div class="form-group">
                    <label for="userPassword">비밀번호 *</label>
                    <div class="password-container">
                        <input type="password" id="userPassword" placeholder="6자 이상 입력하세요" autocomplete="new-password">
                        <button type="button" class="password-toggle" onclick="togglePassword('userPassword')">👁️</button>
                    </div>
                    <small class="text-small">수정시 비밀번호를 변경하지 않으려면 비워두세요</small>
                </div>
                
                <div class="form-group">
                    <label for="userName">실명 *</label>
                    <input type="text" id="userName" required placeholder="실명을 입력하세요" autocomplete="name">
                </div>
                
                <div class="form-group">
                    <label for="userEmail">이메일 *</label>
                    <input type="email" id="userEmail" required placeholder="email@example.com" autocomplete="email">
                </div>
                
                <div class="form-group">
                    <label for="userRole">권한 *</label>
                    <select id="userRole" required>
                        <option value="">권한을 선택하세요</option>
                        <option value="user">일반 사용자</option>
                        <option value="manager">관리자</option>
                        <option value="admin">시스템 관리자</option>
                    </select>
                </div>
            </form>

            <div id="userModalError" class="alert alert-error hidden"></div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeUserModal()">취소</button>
                <button type="button" class="btn btn-success" onclick="saveUser()">
                    <span id="userSaveBtnText">💾 저장</span>
                </button>
            </div>
        </div>
    </div>

    <!-- 계정 신청 승인 모달 -->
    <div id="approvalModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>✅ 계정 신청 승인</h3>
                <p style="color: #666; margin: 5px 0 0 0;">
                    신청자: <span id="approvalRequestName" class="font-bold"></span><br>
                    <span id="approvalRequestInfo" style="font-size: 0.9rem;"></span>
                </p>
            </div>
            
            <form id="approvalForm">
                <input type="hidden" id="approvalRequestId">
                
                <div class="form-group">
                    <label for="approvalUsername">사용자 ID *</label>
                    <input type="text" id="approvalUsername" required placeholder="영문/숫자로 입력하세요">
                    <small class="text-small">신청자가 요청한 ID를 수정할 수 있습니다.</small>
                </div>
                
                <div class="form-group">
                    <label for="approvalPassword">임시 비밀번호 *</label>
                    <div class="password-container">
                        <input type="password" id="approvalPassword" required placeholder="6자 이상 입력하세요">
                        <button type="button" class="password-toggle" onclick="togglePassword('approvalPassword')">👁️</button>
                    </div>
                    <small class="text-small">사용자가 첫 로그인 후 변경하도록 안내하세요.</small>
                </div>
                
                <div class="form-group">
                    <label for="approvalNote">승인 메모 (선택)</label>
                    <textarea id="approvalNote" rows="2" placeholder="승인 시 특이사항이나 전달 메시지"></textarea>
                </div>
            </form>

            <div id="approvalModalError" class="alert alert-error hidden"></div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeApprovalModal()">취소</button>
                <button type="button" class="btn btn-success" onclick="approveAccountRequest()">
                    <span id="approvalSaveBtnText">✅ 승인 및 계정 생성</span>
                </button>
            </div>
        </div>
    </div>

    <!-- OB콜 처리 모달 - UI 개선 완료 버전 -->
    <div id="processModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>📞 Missing Call 처리</h3>
                <div class="call-info-card">
                    <div class="call-info-row">
                        <span class="info-label">전화번호:</span>
                        <span id="modalPhoneNumber" class="phone-number"></span>
                    </div>
                    <div class="call-info-row">
                        <span id="modalCallInfo" class="info-details"></span>
                    </div>
                </div>
            </div>
            
            <form id="processForm">
                <!-- 처리 상태와 담당자를 같은 행에 배치 (좌우 50:50) -->
                <div class="form-row-horizontal">
                    <div class="form-group form-group-half">
                        <label for="processStatus">처리 상태 *</label>
                        <select id="processStatus" required>
                            <option value="">선택해주세요</option>
                            <option value="완료">✅ 완료</option>
                            <option value="미완료">❌ 미완료</option>
                            <option value="보류">⏸️ 보류</option>
                            <option value="재시도">🔄 재시도 필요</option>
                        </select>
                    </div>
                    
                    <div class="form-group form-group-half">
                        <label for="processManager">담당자 *</label>
                        <input type="text" id="processManager" required placeholder="담당자명을 입력하세요" autocomplete="name">
                    </div>
                </div>

                <!-- 처리 메모는 전체 너비로 확장 -->
                <div class="form-group form-group-full">
                    <label for="processNote">처리 메모</label>
                    <textarea id="processNote" rows="4" placeholder="처리 내용이나 특이사항을 입력하세요 (선택사항)"></textarea>
                </div>
            </form>

            <div id="processModalError" class="alert alert-error hidden"></div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeProcessModal()">취소</button>
                <button type="button" class="btn btn-success" onclick="saveProcess()">
                    <span id="processSaveBtnText">💾 저장</span>
                </button>
                <button type="button" class="btn btn-primary" onclick="saveAndNext()" title="저장 후 다음 미처리 건으로 이동">
                    ⏩ 저장 후 다음
                </button>
            </div>
        </div>
    </div>

    <!-- 계정 신청 모달 -->
    <div id="accountRequestModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>📧 계정 신청</h3>
                <p style="color: #666; margin: 5px 0 0 0; font-size: 0.9rem;">
                    신청서를 작성해주시면 관리자가 검토 후 계정을 생성해 드립니다.
                </p>
            </div>
            
            <form id="accountRequestForm">
                <div class="form-group">
                    <label for="requestName">성명 *</label>
                    <input type="text" id="requestName" required placeholder="실명을 입력하세요" autocomplete="name">
                </div>
                
                <div class="form-group">
                    <label for="requestEmail">이메일 *</label>
                    <input type="email" id="requestEmail" required placeholder="email@company.com" autocomplete="email">
                </div>
                
                <div class="form-group">
                    <label for="requestPhone">연락처 *</label>
                    <input type="tel" id="requestPhone" required placeholder="010-0000-0000" autocomplete="tel">
                </div>
                
                <div class="form-group">
                    <label for="requestDepartment">부서/팀 *</label>
                    <input type="text" id="requestDepartment" required placeholder="소속 부서나 팀을 입력하세요">
                </div>
                
                <div class="form-group">
                    <label for="requestPosition">직급/직책</label>
                    <input type="text" id="requestPosition" placeholder="직급이나 직책을 입력하세요">
                </div>
                
                <div class="form-group">
                    <label for="requestRole">요청 권한 *</label>
                    <select id="requestRole" required>
                        <option value="">권한을 선택하세요</option>
                        <option value="user">일반 사용자 (조회 및 처리만 가능)</option>
                        <option value="manager">관리자 (사용자 관리 포함)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="requestReason">신청 사유 *</label>
                    <textarea id="requestReason" rows="3" required placeholder="계정이 필요한 업무상 사유를 간단히 설명해주세요"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="requestUserId">희망 사용자 ID (사번)</label>
                    <input type="text" id="requestUserId" placeholder="사번을 입력하세요 (예: T2025001)">
                    <small class="text-small">본인의 사번을 입력해주세요. 비워두시면 관리자가 사번으로 생성해 드립니다.</small>
                </div>
            </form>

            <div id="accountRequestError" class="alert alert-error hidden"></div>
            <div id="accountRequestSuccess" class="alert alert-success hidden"></div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeAccountRequestModal()">취소</button>
                <button type="button" class="btn btn-primary" onclick="submitAccountRequest()">
                    <span id="accountRequestBtnText">📧 신청서 제출</span>
                </button>
            </div>
        </div>
    </div>

    <!-- config.js 파일 로드 -->
    <script src="config.js"></script>
    
    <script>
        // 전역 변수
        let currentUser = null;
        let currentCallsData = [];
        let currentUsersData = [];
        let currentRequestsData = [];
        let currentProcessingCall = null;
        let connectionCheckInterval = null;

        // 정렬 상태 관리
        let currentSort = {
            column: 'startTime',    // 기본 정렬 칼럼: 인입시간
            direction: 'desc'       // 기본 정렬 방향: 내림차순 (늦은 시간부터)
        };

        // 페이지 로드시 초기화
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        // 앱 초기화
        async function initializeApp() {
            Utils.debugLog('앱 초기화 시작');
            
            try {
                // 초기화 상태 표시
                updateInitStatus('설정 파일 검증 중...');
                
                // 설정 검증
                if (!validateConfig()) {
                    showError('설정 파일에 오류가 있습니다. config.js를 확인해주세요.');
                    return;
                }

                updateInitStatus('연결 테스트 중...');
                
                // Apps Script 연결 테스트
                if (CONFIG.API.API_TYPE === 'apps_script') {
                    try {
                        const result = await GoogleAppsScriptAPI.testConnection();
                        if (result.success) {
                            showConnectionStatus('connected', '✅ 연결됨');
                            Utils.debugLog('✅ Apps Script 연결 테스트 성공');
                        } else {
                            showConnectionStatus('disconnected', '❌ 연결 실패');
                            Utils.debugLog('⚠️ Apps Script 연결 테스트 실패:', result.message);
                        }
                    } catch (error) {
                        showConnectionStatus('disconnected', '❌ 연결 실패');
                        Utils.debugLog('⚠️ Apps Script 연결 테스트 실패:', error.message);
                    }
                }

                updateInitStatus('세션 확인 중...');

                // 세션 확인
                const session = SessionManager.getSession();
                if (session) {
                    Utils.debugLog('기존 세션 발견:', session.username);
                    await loginSuccess(session);
                } else {
                    showLoginScreen();
                }

                // 오늘 날짜 설정
                const today = Utils.getTodayString();
                document.getElementById('searchDate').value = today;
                
                // 기본 필터 설정
                document.getElementById('processFilter').value = 'all';
                document.getElementById('queueFilter').value = 'all';

                // 이벤트 리스너 등록
                setupEventListeners();

                // 주기적 연결 확인 시작
                startConnectionMonitoring();

            } catch (error) {
                Utils.debugLog('초기화 오류:', error);
                showError('시스템 초기화 중 오류가 발생했습니다: ' + error.message);
            }
        }

        // 테이블 정렬 함수
        function sortTable(column) {
            Utils.debugLog('정렬 요청:', { column, currentSort });
            
            // 현재 정렬 칼럼과 같으면 방향 변경, 다르면 새로운 칼럼으로 오름차순
            if (currentSort.column === column) {
                if (currentSort.direction === 'asc') {
                    currentSort.direction = 'desc';
                } else if (currentSort.direction === 'desc') {
                    currentSort.direction = 'none';
                } else {
                    currentSort.direction = 'asc';
                }
            } else {
                currentSort.column = column;
                currentSort.direction = 'asc';
            }
            
            // 정렬 상태에 따라 데이터 정렬
            let sortedData = [...currentCallsData];
            
            if (currentSort.direction !== 'none') {
                sortedData.sort((a, b) => {
                    let valueA, valueB;
                    
                    if (column === 'startTime') {
                        try {
                            const dateA = Utils.formatDateOnly(a.date) || '';
                            const timeA = Utils.formatTimeOnly(a.startTime) || '';
                            const dateB = Utils.formatDateOnly(b.date) || '';
                            const timeB = Utils.formatTimeOnly(b.startTime) || '';
                            
                            valueA = `${dateA} ${timeA}`;
                            valueB = `${dateB} ${timeB}`;
                            
                        } catch (error) {
                            Utils.debugLog('시간 정렬 오류:', error);
                            valueA = `${a.date} ${a.startTime}`;
                            valueB = `${b.date} ${b.startTime}`;
                        }
                    } else if (column === 'callCount') {
                        valueA = parseInt(a.callCount) || 0;
                        valueB = parseInt(b.callCount) || 0;
                    }
                    
                    // 정렬 방향에 따른 비교
                    if (currentSort.direction === 'asc') {
                        if (typeof valueA === 'string' && typeof valueB === 'string') {
                            return valueA.localeCompare(valueB);
                        }
                        return valueA - valueB;
                    } else {
                        if (typeof valueA === 'string' && typeof valueB === 'string') {
                            return valueB.localeCompare(valueA);
                        }
                        return valueB - valueA;
                    }
                });
            }
            
            // 정렬 화살표 업데이트
            updateSortArrows();
            
            // 테이블 다시 그리기
            displayCallsResultsWithData(sortedData);
            
            Utils.debugLog('정렬 완료:', { 
                column, 
                direction: currentSort.direction, 
                dataLength: sortedData.length
            });
        }

        // 정렬 화살표 업데이트
        function updateSortArrows() {
            // 모든 화살표 초기화
            const arrows = document.querySelectorAll('.sort-arrow');
            arrows.forEach(arrow => {
                arrow.className = 'sort-arrow none';
            });
            
            // 현재 정렬 칼럼의 화살표 업데이트
            const currentArrow = document.getElementById(`sortArrow-${currentSort.column}`);
            if (currentArrow) {
                currentArrow.className = `sort-arrow ${currentSort.direction}`;
                if (currentSort.direction !== 'none') {
                    currentArrow.classList.add('active');
                }
            }
        }

        // 초기화 상태 업데이트
        function updateInitStatus(message) {
            const statusEl = document.getElementById('initStatus');
            if (statusEl) {
                statusEl.textContent = message;
            }
        }

        // 연결 상태 표시
        function showConnectionStatus(status, text) {
            const statusEl = document.getElementById('connectionStatus');
            const textEl = document.getElementById('connectionText');
            
            statusEl.className = `connection-status ${status} show`;
            textEl.textContent = text;
            
            // 3초 후 자동 숨김 (연결됨 상태만)
            if (status === 'connected') {
                setTimeout(() => {
                    statusEl.classList.remove('show');
                }, 3000);
            }
        }

        // 연결 모니터링 시작
        function startConnectionMonitoring() {
            // 5분마다 연결 상태 확인
            connectionCheckInterval = setInterval(async () => {
                try {
                    const result = await GoogleAppsScriptAPI.testConnection();
                    if (!result.success) {
                        showConnectionStatus('disconnected', '❌ 연결 끊김');
                    }
                } catch (error) {
                    showConnectionStatus('disconnected', '❌ 연결 끊김');
                }
            }, 5 * 60 * 1000); // 5분
        }

        // 연결 새로고침
        async function refreshConnection() {
            showConnectionStatus('testing', '🔄 연결 확인 중...');
            
            try {
                const result = await GoogleAppsScriptAPI.testConnection();
                if (result.success) {
                    showConnectionStatus('connected', '✅ 연결 복구됨');
                } else {
                    showConnectionStatus('disconnected', '❌ 연결 실패');
                    alert('❌ 연결 확인 실패: ' + result.message);
                }
            } catch (error) {
                showConnectionStatus('disconnected', '❌ 연결 실패');
                alert('❌ 연결 확인 실패: ' + error.message);
            }
        }

        // 이벤트 리스너 설정
        function setupEventListeners() {
            // 로그인 폼
            document.getElementById('loginForm').addEventListener('submit', function(e) {
                e.preventDefault();
                handleLogin();
            });

            // 사용자 폼
            document.getElementById('userForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveUser();
            });

            // 처리 폼
            document.getElementById('processForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveProcess();
            });

            // 계정 신청 폼
            document.getElementById('accountRequestForm').addEventListener('submit', function(e) {
                e.preventDefault();
                submitAccountRequest();
            });

            // 승인 폼
            document.getElementById('approvalForm').addEventListener('submit', function(e) {
                e.preventDefault();
                approveAccountRequest();
            });

            // Enter 키 처리
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    const activeModal = document.querySelector('.modal.show');
                    if (activeModal) {
                        const primaryButton = activeModal.querySelector('.btn-success, .btn-primary');
                        if (primaryButton && !primaryButton.disabled) {
                            primaryButton.click();
                        }
                    }
                }
                
                // ESC 키로 모달 닫기
                if (e.key === 'Escape') {
                    const openModal = document.querySelector('.modal.show');
                    if (openModal) {
                        closeModal(openModal);
                    }
                }
            });

            // 모달 외부 클릭시 닫기
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('modal')) {
                    closeModal(e.target);
                }
            });

            // 페이지 언로드시 정리
            window.addEventListener('beforeunload', function() {
                if (connectionCheckInterval) {
                    clearInterval(connectionCheckInterval);
                }
            });
        }

        // 오류 표시
        function showError(message) {
            document.getElementById('initialLoading').innerHTML = `
                <div class="login-box text-center">
                    <h2 style="color: #dc2626;">❌ 오류 발생</h2>
                    <div class="alert alert-error">${message}</div>
                    <button class="btn btn-primary mt-20" onclick="location.reload()">🔄 다시 시도</button>
                </div>
            `;
        }

        // 로그인 처리
        async function handleLogin() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            const rememberMe = document.getElementById('rememberMe').checked;

            if (!username || !password) {
                showAlert('loginError', '사용자 ID와 비밀번호를 입력해주세요.', 'error');
                return;
            }

            try {
                Utils.debugLog('로그인 시도:', username);
                
                // 버튼 상태 변경
                const loginBtn = document.querySelector('#loginForm .btn-primary');
                const btnText = document.getElementById('loginBtnText');
                loginBtn.disabled = true;
                btnText.textContent = '로그인 중...';
                
                // 사용자 인증
                const result = await GoogleAppsScriptAPI.request('authenticate', { username, password });
                
                if (result.success && result.user) {
                    // 세션 생성
                    SessionManager.setSession(result.user, rememberMe);
                    await loginSuccess(result.user);
                } else {
                    showAlert('loginError', result.error || '사용자 ID 또는 비밀번호가 올바르지 않습니다.', 'error');
                }
            } catch (error) {
                Utils.debugLog('로그인 오류:', error);
                showAlert('loginError', '로그인 중 오류가 발생했습니다: ' + error.message, 'error');
            } finally {
                // 버튼 복원
                const loginBtn = document.querySelector('#loginForm .btn-primary');
                const btnText = document.getElementById('loginBtnText');
                loginBtn.disabled = false;
                btnText.textContent = '로그인';
            }
        }

        // 로그인 성공 처리
        async function loginSuccess(user) {
            currentUser = user;
            
            // UI 업데이트
            document.getElementById('currentUserName').textContent = user.name;
            document.getElementById('currentUserRole').textContent = getRoleDisplayName(user.role);
            
            // 권한에 따른 메뉴 표시
            const usersMenuBtn = document.getElementById('usersMenuBtn');
            const requestsMenuBtn = document.getElementById('requestsMenuBtn');
            
            if (SessionManager.hasRole('manager')) {
                usersMenuBtn.classList.remove('hidden');
                requestsMenuBtn.classList.remove('hidden');
            } else {
                usersMenuBtn.classList.add('hidden');
                requestsMenuBtn.classList.add('hidden');
            }

            // 화면 전환
            document.getElementById('initialLoading').classList.add('hidden');
            document.getElementById('loginContainer').classList.add('hidden');
            document.getElementById('mainContainer').style.display = 'block';

            Utils.debugLog('로그인 성공:', user.name);
        }

        // 로그아웃
        function logout() {
            if (confirm('로그아웃 하시겠습니까?')) {
                try {
                    // 세션 초기화
                    SessionManager.clearSession();
                    currentUser = null;
                    
                    // 연결 모니터링 중지
                    if (connectionCheckInterval) {
                        clearInterval(connectionCheckInterval);
                        connectionCheckInterval = null;
                    }
                    
                    // 데이터 초기화
                    currentCallsData = [];
                    currentUsersData = [];
                    currentRequestsData = [];
                    currentProcessingCall = null;
                    
                    // 정렬 상태 초기화
                    currentSort = {
                        column: 'startTime',
                        direction: 'desc'
                    };
                    
                    // 로그인 화면으로 이동
                    showLoginScreen();
                    Utils.debugLog('로그아웃 완료');
                    
                } catch (error) {
                    Utils.debugLog('로그아웃 중 오류:', error);
                    // 오류가 발생해도 강제로 로그인 화면으로 이동
                    showLoginScreen();
                }
            }
        }

        // 로그인 화면 표시
        function showLoginScreen() {
            document.getElementById('initialLoading').classList.add('hidden');
            document.getElementById('loginContainer').classList.remove('hidden');
            document.getElementById('mainContainer').style.display = 'none';
            
            // 폼 초기화
            document.getElementById('loginForm').reset();
            hideAlert('loginError');
        }

        // 섹션 표시
        function showSection(sectionName) {
            // 모든 섹션 숨기기
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            // 모든 네비게이션 버튼 비활성화
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // 선택된 섹션 표시
            document.getElementById(sectionName + 'Section').classList.add('active');
            
            // 선택된 버튼 활성화
            event.target.classList.add('active');

            // 섹션별 초기 로딩
            if (sectionName === 'users' && SessionManager.hasRole('manager')) {
                loadUsersSection();
            } else if (sectionName === 'requests' && SessionManager.hasRole('manager')) {
                loadRequestsSection();
            }
        }

        // Missing Call 조회
        async function searchCalls() {
            const searchDate = document.getElementById('searchDate').value;
            const processFilter = document.getElementById('processFilter').value;
            const queueFilter = document.getElementById('queueFilter').value;
            
            if (!searchDate || searchDate.trim() === '') {
                alert('📅 조회할 날짜를 선택해주세요.');
                return;
            }

            if (!searchDate.match(/^\d{4}-\d{2}-\d{2}$/)) {
                alert('⚠️ 올바른 날짜 형식이 아닙니다. YYYY-MM-DD 형식으로 입력해주세요.');
                return;
            }

            try {
                showLoading('loadingMessage');
                hideElement('callsResults');
                hideElement('noDataMessage');
                
                Utils.debugLog('Missing Call 조회 시작:', { date: searchDate, processFilter, queueFilter });
                
                const result = await GoogleAppsScriptAPI.getCalls({ date: searchDate });
                
                Utils.debugLog('Apps Script 응답:', result);
                
                let data = [];
                if (result.success) {
                    data = processCallData(result.calls || []);
                    
                    // 처리 상태 필터 적용
                    if (processFilter !== 'all') {
                        data = data.filter(call => {
                            const status = call.processStatus ? call.processStatus.trim() : '';
                            
                            switch (processFilter) {
                                case 'processed':
                                    return status && status !== '' && status !== '보류' && status !== '재시도';
                                case 'pending':
                                    return !status || status === '';
                                case 'onhold':
                                    return status === '보류';
                                case 'retry':
                                    return status === '재시도' || status === '재시도 필요';
                                default:
                                    return true;
                            }
                        });
                    }
                    
                    // 인입큐 필터 적용
                    if (queueFilter !== 'all') {
                        data = data.filter(call => call.queue === queueFilter);
                    }
                } else {
                    throw new Error(result.error || '데이터를 불러올 수 없습니다');
                }
                
                currentCallsData = data;
                
                if (data.length > 0) {
                    displayCallsResults(data);
                    showElement('callsResults');
                } else {
                    // 필터에 따른 메시지 변경
                    const noDataTitle = document.getElementById('noDataTitle');
                    const noDataSubtitle = document.getElementById('noDataSubtitle');
                    
                    let filterDesc = '';
                    if (processFilter !== 'all') {
                        const filterNames = {
                            'processed': '처리 완료된',
                            'pending': '미처리',
                            'onhold': '보류 상태의',
                            'retry': '재시도 필요한'
                        };
                        filterDesc += filterNames[processFilter] + ' ';
                    }
                    
                    if (queueFilter !== 'all') {
                        const queueName = queueFilter.replace('투어비스-항공 ', '');
                        filterDesc += `${queueName} `;
                    }
                    
                    noDataTitle.textContent = `📭 ${filterDesc}데이터가 없습니다`;
                    noDataSubtitle.textContent = '다른 날짜를 선택하거나 필터 조건을 변경해보세요.';
                    
                    showElement('noDataMessage');
                }
                
                hideLoading('loadingMessage');
                
            } catch (error) {
                Utils.debugLog('조회 오류:', error);
                hideLoading('loadingMessage');
                alert('❌ 데이터 조회 중 오류가 발생했습니다: ' + error.message);
            }
        }

        // 콜 데이터 처리
        function processCallData(rawCalls) {
            const groups = {};
            
            // 전화번호별로 그룹핑
            rawCalls.forEach((call, index) => {
                const phoneNumber = call.phoneNumber;
                if (!groups[phoneNumber]) {
                    groups[phoneNumber] = [];
                }
                groups[phoneNumber].push({...call, originalIndex: index});
            });

            const processedData = [];

            Object.keys(groups).forEach(phoneNumber => {
                const calls = groups[phoneNumber];
                
                // 시간 정렬
                calls.sort((a, b) => {
                    try {
                        const timeStrA = Utils.createSortableTimeString(a.date, a.startTime);
                        const timeStrB = Utils.createSortableTimeString(b.date, b.startTime);
                        return timeStrA.localeCompare(timeStrB);
                    } catch (error) {
                        Utils.debugLog('시간 정렬 오류:', error);
                        return 0;
                    }
                });

                // OB콜 처리가 된 콜들을 기준으로 그룹 분리
                let currentGroup = [];
                
                for (let i = 0; i < calls.length; i++) {
                    const call = calls[i];
                    currentGroup.push(call);
                    
                    // 다음 콜이 있고, 현재 콜이 처리되었으며, 다음 콜이 처리되지 않았다면 그룹 종료
                    if (i < calls.length - 1) {
                        const nextCall = calls[i + 1];
                        if (call.processStatus && !nextCall.processStatus) {
                            // 현재 그룹 처리
                            if (currentGroup.length > 0) {
                                const latestCall = currentGroup[currentGroup.length - 1];
                                processedData.push({
                                    ...latestCall,
                                    callCount: currentGroup.length,
                                    groupCalls: currentGroup.map(c => ({...c}))
                                });
                            }
                            currentGroup = [];
                        }
                    }
                }
                
                // 마지막 그룹 처리
                if (currentGroup.length > 0) {
                    const latestCall = currentGroup[currentGroup.length - 1];
                    processedData.push({
                        ...latestCall,
                        callCount: currentGroup.length,
                        groupCalls: currentGroup.map(c => ({...c}))
                    });
                }
            });

            Utils.debugLog('processCallData 완료:', {
                rawCount: rawCalls.length,
                processedCount: processedData.length
            });

            return processedData;
        }

        // 콜 데이터 결과 표시 (기본 정렬 적용)
        function displayCallsResults(data) {
            // 기본 정렬 상태 설정 (인입시간 내림차순)
            currentSort = {
                column: 'startTime',
                direction: 'desc'
            };
            
            // 기본 정렬 적용
            const sortedData = [...data].sort((a, b) => {
                const timeStrA = Utils.createSortableTimeString(a.date, a.startTime);
                const timeStrB = Utils.createSortableTimeString(b.date, b.startTime);
                return timeStrB.localeCompare(timeStrA); // 내림차순 (늦은 시간부터)
            });
            
            // 정렬 화살표 업데이트
            updateSortArrows();
            
            // 실제 테이블 표시
            displayCallsResultsWithData(sortedData);
        }

        // 콜 데이터 결과 표시 (순번 추가된 버전)
        function displayCallsResultsWithData(data) {
            const countDiv = document.getElementById('resultsCount');
            const tbody = document.querySelector('#callsTable tbody');
            const processFilter = document.getElementById('processFilter').value;
            const queueFilter = document.getElementById('queueFilter').value;
            
            // 필터 상태에 따른 제목 변경
            let filterText = '';
            if (processFilter !== 'all') {
                const filterNames = {
                    'processed': '처리 완료',
                    'pending': '미처리',
                    'onhold': '보류',
                    'retry': '재시도 필요'
                };
                filterText += ` (${filterNames[processFilter]})`;
            }
            
            if (queueFilter !== 'all') {
                const queueName = queueFilter.replace('투어비스-항공 ', '');
                filterText += ` (${queueName})`;
            }

            countDiv.textContent = `📊 조회 결과: ${data.length}건${filterText}`;
            tbody.innerHTML = '';

            // 글로벌 테이블 데이터 저장 (모달에서 사용)
            window.currentTableData = data;
            Utils.debugLog('테이블 데이터 저장됨:', { 
                dataLength: data.length, 
                sampleData: data.slice(0, 2) 
            });

            data.forEach((call, index) => {
                const row = tbody.insertRow();
                const waitMinutes = Math.round(call.duration / 60);
                
                // 처리 상태에 따른 스타일과 텍스트 결정
                let statusClass = 'status-pending';
                let statusText = '⏳ 미처리';
                let actionText = '📞 처리';
                
                if (call.processStatus && call.processStatus.trim() !== '') {
                    actionText = '✏️ 수정';
                    
                    switch (call.processStatus.trim()) {
                        case '완료':
                            statusClass = 'status-processed';
                            statusText = '✅ 완료';
                            break;
                        case '미완료':
                            statusClass = 'status-rejected';
                            statusText = '❌ 미완료';
                            break;
                        case '보류':
                            statusClass = 'status-pending';
                            statusText = '⏸️ 보류';
                            break;
                        case '재시도':
                            statusClass = 'status-warning';
                            statusText = '🔄 재시도';
                            break;
                        default:
                            statusClass = 'status-processed';
                            statusText = '✅ ' + call.processStatus;
                    }
                }
                
                // 행에 데이터 직접 저장 (가장 안전한 방법)
                row.callData = call;
                row.setAttribute('data-table-index', index);
                
                // 순번 칼럼 추가
                row.innerHTML = `
                    <td class="sequence-number">${index + 1}</td>
                    <td>${Utils.formatDateOnly(call.date)}</td>
                    <td class="time-display">${Utils.formatTimeOnly(call.startTime)}</td>
                    <td class="time-display">${waitMinutes}분</td>
                    <td class="phone-number">${call.phoneNumber}</td>
                    <td>${call.queue}</td>
                    <td><span class="call-count">${call.callCount}번</span></td>
                    <td>
                        <span class="status-badge ${statusClass}">
                            ${statusText}
                        </span>
                    </td>
                    <td>${call.processManager || '-'}</td>
                    <td>
                        <button class="btn btn-primary btn-small" onclick="openProcessModal(${index})">
                            ${actionText}
                        </button>
                    </td>
                `;
            });
        }

        // CSV 내보내기 (순번 추가)
        function exportToCSV() {
            if (currentCallsData.length === 0) {
                alert('📭 내보낼 데이터가 없습니다.');
                return;
            }

            const headers = ['순번', '발생일', '인입시간', '대기시간(분)', '전화번호', '인입큐', '중복횟수', '처리상태', '처리담당자'];
            const csvContent = [
                headers.join(','),
                ...currentCallsData.map((call, index) => [
                    index + 1,
                    Utils.formatDateOnly(call.date),
                    Utils.formatTimeOnly(call.startTime),
                    Math.round(call.duration / 60),
                    call.phoneNumber,
                    `"${call.queue}"`,
                    call.callCount,
                    call.processStatus || '미처리',
                    call.processManager || ''
                ].join(','))
            ].join('\n');

            const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `missing_calls_${document.getElementById('searchDate').value}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // 사용자 관리 섹션 로딩
        async function loadUsersSection() {
            if (!SessionManager.hasRole('manager')) {
                alert('❌ 권한이 없습니다.');
                return;
            }

            try {
                showLoading('usersLoading');
                
                const result = await GoogleAppsScriptAPI.getUsers();
                
                if (result.success) {
                    currentUsersData = result.users.filter(u => u.status === 'approved') || [];
                    displayUsersResults(currentUsersData);
                } else {
                    throw new Error(result.error || '사용자 목록을 불러올 수 없습니다');
                }
                
                hideLoading('usersLoading');
                
            } catch (error) {
                Utils.debugLog('사용자 섹션 로딩 오류:', error);
                hideLoading('usersLoading');
                alert('❌ 사용자 목록을 불러오는 중 오류가 발생했습니다: ' + error.message);
            }
        }

        // 계정 신청 관리 섹션 로딩
        async function loadRequestsSection() {
            if (!SessionManager.hasRole('manager')) {
                alert('❌ 권한이 없습니다.');
                return;
            }

            try {
                showLoading('requestsLoading');
                
                const result = await GoogleAppsScriptAPI.getPendingRequests();
                
                if (result.success) {
                    currentRequestsData = result.requests || [];
                    displayRequestsResults(currentRequestsData);
                } else {
                    throw new Error(result.error || '신청 목록을 불러올 수 없습니다');
                }
                
                hideLoading('requestsLoading');
                
            } catch (error) {
                Utils.debugLog('신청 섹션 로딩 오류:', error);
                hideLoading('requestsLoading');
                alert('❌ 신청 목록을 불러오는 중 오류가 발생했습니다: ' + error.message);
            }
        }

        // 사용자 목록 결과 표시
        function displayUsersResults(users) {
            const tbody = document.querySelector('#usersTable tbody');
            tbody.innerHTML = '';

            if (users.length === 0) {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td colspan="8" class="text-center" style="padding: 40px; color: #666;">
                        👥 등록된 사용자가 없습니다.
                    </td>
                `;
                return;
            }

            users.forEach((user, index) => {
                const row = tbody.insertRow();
                const statusClass = user.status === 'approved' ? 'status-processed' : 'status-pending';
                const statusText = user.status === 'approved' ? '✅ 활성' : '⏳ 대기중';
                
                row.innerHTML = `
                    <td class="phone-number">${user.username}</td>
                    <td>${user.name}</td>
                    <td>${user.email}</td>
                    <td><span class="status-badge status-${user.role}">${getRoleDisplayName(user.role)}</span></td>
                    <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                    <td class="time-display">${Utils.formatDateOnly(user.createdAt) || '-'}</td>
                    <td class="time-display">${Utils.formatKoreanDateTime(user.lastLogin) || '-'}</td>
                    <td style="white-space: nowrap;">
                        <button class="btn btn-primary btn-small" onclick="editUser(${index})" style="margin-right: 5px;">✏️ 수정</button>
                        ${user.username !== currentUser.username ? 
                            `<button class="btn btn-danger btn-small" onclick="deleteUser(${index})">🗑️ 삭제</button>` : 
                            '<span class="text-small">현재 사용자</span>'
                        }
                    </td>
                `;
            });
        }

        // 계정 신청 목록 결과 표시
        function displayRequestsResults(requests) {
            const tbody = document.querySelector('#requestsTable tbody');
            const noRequestsMsg = document.getElementById('noRequestsMessage');
            
            tbody.innerHTML = '';

            if (requests.length === 0) {
                showElement('noRequestsMessage');
                return;
            }

            hideElement('noRequestsMessage');

            requests.forEach((request, index) => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td class="time-display">${Utils.formatKoreanDateTime(request.requestDate)}</td>
                    <td>${request.name}</td>
                    <td>${request.email}</td>
                    <td>${request.phone}</td>
                    <td>${request.department}</td>
                    <td><span class="status-badge status-${request.role}">${getRoleDisplayName(request.role)}</span></td>
                    <td class="phone-number">${request.requestedUsername || '자동 생성'}</td>
                    <td><span class="status-badge status-pending">⏳ 대기중</span></td>
                    <td style="white-space: nowrap;">
                        <button class="btn btn-success btn-small" onclick="openApprovalModal(${index})" style="margin-right: 5px;">
                            ✅ 승인
                        </button>
                        <button class="btn btn-danger btn-small" onclick="rejectRequest(${index})">
                            ❌ 거부
                        </button>
                    </td>
                `;
            });
        }

        // 권한 표시명 반환
        function getRoleDisplayName(role) {
            const roleNames = {
                'admin': '시스템 관리자',
                'manager': '관리자', 
                'user': '일반 사용자'
            };
            return roleNames[role] || role;
        }

        // OB콜 처리 모달 열기 (순번 고려한 안전한 버전)
        function openProcessModal(tableIndex) {
            Utils.debugLog('=== openProcessModal 시작 ===');
            Utils.debugLog('요청된 테이블 인덱스:', tableIndex);
            
            try {
                // 방법 1: 글로벌 테이블 데이터에서 가져오기
                if (window.currentTableData && window.currentTableData[tableIndex]) {
                    const call = window.currentTableData[tableIndex];
                    Utils.debugLog('방법 1 성공 - 글로벌 테이블 데이터:', call);
                    setupModalWithCall(call, tableIndex);
                    return;
                }
                
                // 방법 2: 테이블 행에서 직접 가져오기
                const tableBody = document.querySelector('#callsTable tbody');
                const rows = tableBody.querySelectorAll('tr');
                
                if (tableIndex >= 0 && tableIndex < rows.length) {
                    const row = rows[tableIndex];
                    
                    // 행에 저장된 데이터 확인
                    if (row.callData) {
                        Utils.debugLog('방법 2 성공 - 행 데이터:', row.callData);
                        setupModalWithCall(row.callData, tableIndex);
                        return;
                    }
                }
                
                // 방법 3: currentCallsData에서 검색 (순번 칼럼 고려)
                Utils.debugLog('방법 3 시도 - currentCallsData 검색');
                Utils.debugLog('currentCallsData 길이:', currentCallsData ? currentCallsData.length : 'null/undefined');
                
                if (currentCallsData && currentCallsData.length > 0) {
                    // 테이블에서 전화번호 추출 (순번 추가로 인해 인덱스 조정)
                    const phoneCell = rows[tableIndex]?.querySelectorAll('td')[4]; // 전화번호는 5번째 칼럼
                    const timeCell = rows[tableIndex]?.querySelectorAll('td')[2];  // 인입시간은 3번째 칼럼
                    
                    if (phoneCell && timeCell) {
                        const phoneNumber = phoneCell.textContent.trim();
                        const timeText = timeCell.textContent.trim();
                        
                        Utils.debugLog('테이블에서 추출한 정보:', { phoneNumber, timeText });
                        
                        // 시간 형식으로 검색
                        const foundCall = currentCallsData.find(c => {
                            const callTime = Utils.formatTimeOnly(c.startTime);
                            return c.phoneNumber === phoneNumber && callTime === timeText;
                        });
                        
                        if (foundCall) {
                            Utils.debugLog('방법 3 성공 - 검색으로 찾음:', foundCall);
                            setupModalWithCall(foundCall, tableIndex);
                            return;
                        }
                    }
                }
                
                // 모든 방법 실패
                Utils.debugLog('=== 모든 방법 실패 ===');
                Utils.debugLog('currentTableData:', window.currentTableData);
                Utils.debugLog('currentCallsData:', currentCallsData);
                Utils.debugLog('테이블 행 수:', rows ? rows.length : 'null');
                
                alert('❌ 처리할 데이터를 찾을 수 없습니다.\n페이지를 새로고침 후 다시 시도해주세요.');
                
            } catch (error) {
                Utils.debugLog('openProcessModal 오류:', error);
                alert('❌ 모달 열기 중 오류가 발생했습니다: ' + error.message);
            }
        }
        
        // 모달 설정 공통 함수
        function setupModalWithCall(call, tableIndex) {
            Utils.debugLog('모달 설정 시작:', { call, tableIndex });
            
            currentProcessingCall = { 
                ...call, 
                tableIndex: tableIndex,
                phoneNumber: call.phoneNumber,
                startTime: call.startTime
            };

            Utils.debugLog('currentProcessingCall 설정 완료:', currentProcessingCall);

            document.getElementById('modalPhoneNumber').textContent = call.phoneNumber;
            document.getElementById('modalCallInfo').textContent = 
                `${call.callCount > 1 ? call.callCount + '번 중복 | ' : ''}${call.queue} | ${Math.round(call.duration / 60)}분 대기`;
            
            document.getElementById('processStatus').value = call.processStatus || '';
            document.getElementById('processManager').value = call.processManager || (currentUser ? currentUser.name : '');
            document.getElementById('processNote').value = '';

            hideAlert('processModalError');
            document.getElementById('processModal').classList.add('show');
            
            // 처리 상태에 포커스
            setTimeout(() => {
                if (!call.processStatus) {
                    document.getElementById('processStatus').focus();
                } else {
                    document.getElementById('processManager').focus();
                }
            }, 100);
            
            Utils.debugLog('모달 설정 완료');
        }

        // OB콜 처리 모달 닫기
        function closeProcessModal() {
            closeModal('processModal');
            currentProcessingCall = null;
            hideAlert('processModalError');
        }

        // OB콜 처리 저장 (개선된 안전 버전)
        async function saveProcess() {
            const processStatus = document.getElementById('processStatus').value;
            const processManager = document.getElementById('processManager').value.trim();
            const processNote = document.getElementById('processNote').value.trim();

            if (!processStatus || !processManager) {
                showAlert('processModalError', '처리 상태와 담당자를 모두 입력해주세요.', 'error');
                return;
            }

            try {
                // 버튼 상태 변경
                const saveBtn = document.querySelector('#processModal .btn-success');
                const btnText = document.getElementById('processSaveBtnText');
                saveBtn.disabled = true;
                btnText.textContent = '저장 중...';

                Utils.debugLog('저장 시작:', currentProcessingCall);

                if (!currentProcessingCall) {
                    throw new Error('처리할 콜 정보가 없습니다.');
                }

                // 서버 업데이트 (rowIndex가 있는 경우에만)
                if (currentProcessingCall.rowIndex) {
                    const callsToUpdate = currentProcessingCall.groupCalls || [currentProcessingCall];
                    
                    for (const call of callsToUpdate) {
                        const updateData = {
                            rowIndex: call.rowIndex,
                            processStatus: processStatus,
                            processManager: processManager,
                            processNote: processNote
                        };
                        
                        Utils.debugLog('서버 업데이트 데이터:', updateData);
                        
                        const result = await GoogleAppsScriptAPI.updateCall(updateData);
                        
                        if (!result.success) {
                            throw new Error(result.error || '서버 업데이트 실패');
                        }
                    }
                }

                // 로컬 데이터 업데이트
                updateLocalData(currentProcessingCall, processStatus, processManager);

                // 테이블 행 즉시 업데이트
                updateTableRow(currentProcessingCall.tableIndex, processStatus, processManager);

                closeProcessModal();
                
                // 성공 메시지
                Utils.showToast(`✅ ${currentProcessingCall.phoneNumber} 저장 완료 (${processStatus})`, 'success');

            } catch (error) {
                Utils.debugLog('저장 오류:', error);
                showAlert('processModalError', '저장 중 오류가 발생했습니다: ' + error.message, 'error');
            } finally {
                // 버튼 복원
                const saveBtn = document.querySelector('#processModal .btn-success');
                const btnText = document.getElementById('processSaveBtnText');
                saveBtn.disabled = false;
                btnText.textContent = '💾 저장';
            }
        }

        // 로컬 데이터 업데이트 함수
        function updateLocalData(processingCall, processStatus, processManager) {
            try {
                // 1. currentCallsData 업데이트
                if (currentCallsData && currentCallsData.length > 0) {
                    const callToUpdate = currentCallsData.find(c => 
                        c.phoneNumber === processingCall.phoneNumber && 
                        c.startTime === processingCall.startTime
                    );
                    
                    if (callToUpdate) {
                        callToUpdate.processStatus = processStatus;
                        callToUpdate.processManager = processManager;
                        Utils.debugLog('currentCallsData 업데이트 완료');
                    }
                }

                // 2. currentTableData 업데이트
                if (window.currentTableData && window.currentTableData[processingCall.tableIndex]) {
                    window.currentTableData[processingCall.tableIndex].processStatus = processStatus;
                    window.currentTableData[processingCall.tableIndex].processManager = processManager;
                    Utils.debugLog('currentTableData 업데이트 완료');
                }

                // 3. 테이블 행 데이터 업데이트
                const tableBody = document.querySelector('#callsTable tbody');
                const rows = tableBody.querySelectorAll('tr');
                if (rows[processingCall.tableIndex] && rows[processingCall.tableIndex].callData) {
                    rows[processingCall.tableIndex].callData.processStatus = processStatus;
                    rows[processingCall.tableIndex].callData.processManager = processManager;
                    Utils.debugLog('테이블 행 데이터 업데이트 완료');
                }
                
            } catch (error) {
                Utils.debugLog('로컬 데이터 업데이트 오류:', error);
            }
        }

        // 처리 후 다음 미처리 건으로 이동
        async function saveAndNext() {
            const processStatus = document.getElementById('processStatus').value;
            const processManager = document.getElementById('processManager').value.trim();

            if (!processStatus || !processManager) {
                showAlert('processModalError', '처리 상태와 담당자를 모두 입력해주세요.', 'error');
                return;
            }

            try {
                // 현재 처리 저장
                const saveBtn = document.querySelector('#processModal .btn-primary');
                const btnText = saveBtn.textContent;
                
                saveBtn.disabled = true;
                saveBtn.textContent = '⏳ 저장 중...';

                // 현재 콜 처리
                const currentIndex = currentProcessingCall.tableIndex;
                const callsToUpdate = currentProcessingCall.groupCalls || [currentProcessingCall];

                for (const call of callsToUpdate) {
                    if (!call.rowIndex) {
                        if (currentProcessingCall.rowIndex) {
                            call.rowIndex = currentProcessingCall.rowIndex;
                        } else {
                            throw new Error('rowIndex가 없습니다.');
                        }
                    }

                    const updateData = {
                        rowIndex: parseInt(call.rowIndex),
                        processStatus: processStatus,
                        processManager: processManager,
                        processNote: document.getElementById('processNote').value.trim()
                    };

                    const result = await GoogleAppsScriptAPI.updateCall(updateData);
                    if (!result.success) {
                        throw new Error(result.error || '업데이트 실패');
                    }
                }

                // 테이블 행 업데이트
                updateTableRow(currentIndex, processStatus, processManager);

                // 다음 미처리 건 찾기 (currentTableData에서)
                let nextIndex = -1;
                if (window.currentTableData && window.currentTableData.length > 0) {
                    for (let i = currentIndex + 1; i < window.currentTableData.length; i++) {
                        if (!window.currentTableData[i].processStatus || window.currentTableData[i].processStatus.trim() === '') {
                            nextIndex = i;
                            break;
                        }
                    }

                    // 다음 건이 없으면 처음부터 다시 찾기
                    if (nextIndex === -1) {
                        for (let i = 0; i < currentIndex; i++) {
                            if (!window.currentTableData[i].processStatus || window.currentTableData[i].processStatus.trim() === '') {
                                nextIndex = i;
                                break;
                            }
                        }
                    }
                }

                if (nextIndex !== -1) {
                    // 다음 미처리 건으로 모달 전환
                    Utils.showToast(`✅ ${currentProcessingCall.phoneNumber} 저장 완료`, 'success');
                    
                    // 잠시 대기 후 다음 건 열기
                    setTimeout(() => {
                        openProcessModal(nextIndex);
                        
                        // 테이블에서 해당 행으로 스크롤
                        const tableBody = document.querySelector('#callsTable tbody');
                        const targetRow = tableBody.querySelectorAll('tr')[nextIndex];
                        if (targetRow) {
                            targetRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            // 행 하이라이트
                            targetRow.style.backgroundColor = '#fef3c7';
                            setTimeout(() => {
                                targetRow.style.backgroundColor = '';
                            }, 2000);
                        }
                    }, 500);
                } else {
                    // 더 이상 미처리 건이 없음
                    closeProcessModal();
                    Utils.showToast(`✅ ${currentProcessingCall.phoneNumber} 저장 완료 - 미처리 건이 더 없습니다`, 'success');
                    alert('🎉 모든 건이 처리되었습니다!');
                }

            } catch (error) {
                Utils.debugLog('저장 후 다음 오류:', error);
                showAlert('processModalError', '저장 중 오류가 발생했습니다: ' + error.message, 'error');
            } finally {
                // 버튼 복원
                const saveBtn = document.querySelector('#processModal .btn-primary');
                saveBtn.disabled = false;
                saveBtn.textContent = '⏩ 저장 후 다음';
            }
        }

        // 테이블 특정 행 업데이트 (순번 칼럼 고려)
        function updateTableRow(tableIndex, processStatus, processManager) {
            try {
                const tableBody = document.querySelector('#callsTable tbody');
                const rows = tableBody.querySelectorAll('tr');
                
                if (rows[tableIndex]) {
                    const row = rows[tableIndex];
                    const cells = row.querySelectorAll('td');
                    
                    // 처리 상태에 따른 스타일과 텍스트 결정
                    let statusClass = 'status-pending';
                    let statusText = '⏳ 미처리';
                    let actionText = '📞 처리';
                    
                    if (processStatus && processStatus.trim() !== '') {
                        actionText = '✏️ 수정';
                        
                        switch (processStatus.trim()) {
                            case '완료':
                                statusClass = 'status-processed';
                                statusText = '✅ 완료';
                                break;
                            case '미완료':
                                statusClass = 'status-rejected';
                                statusText = '❌ 미완료';
                                break;
                            case '보류':
                                statusClass = 'status-pending';
                                statusText = '⏸️ 보류';
                                break;
                            case '재시도':
                                statusClass = 'status-warning';
                                statusText = '🔄 재시도';
                                break;
                            default:
                                statusClass = 'status-processed';
                                statusText = '✅ ' + processStatus;
                        }
                    }
                    
                    // 순번 칼럼 추가로 인한 인덱스 조정
                    // 처리상태 칼럼 업데이트 (8번째 칼럼, 인덱스 7)
                    if (cells[7]) {
                        cells[7].innerHTML = `
                            <span class="status-badge ${statusClass}">
                                ${statusText}
                            </span>
                        `;
                    }
                    
                    // 처리담당자 칼럼 업데이트 (9번째 칼럼, 인덱스 8)
                    if (cells[8]) {
                        cells[8].textContent = processManager;
                    }
                    
                    // 액션 버튼 업데이트 (10번째 칼럼, 인덱스 9)
                    if (cells[9]) {
                        cells[9].innerHTML = `
                            <button class="btn btn-primary btn-small" onclick="openProcessModal(${tableIndex})">
                                ${actionText}
                            </button>
                        `;
                    }
                    
                    // 행 하이라이트 효과 (일시적)
                    row.style.backgroundColor = '#d1fae5';
                    setTimeout(() => {
                        row.style.backgroundColor = '';
                    }, 2000);
                    
                    Utils.debugLog('테이블 행 즉시 업데이트 완료:', { tableIndex, processStatus, processManager });
                }
                
            } catch (error) {
                Utils.debugLog('테이블 행 업데이트 오류:', error);
            }
        }

        // 사용자 모달 열기
        function openUserModal(user = null) {
            const isEdit = !!user;
            
            document.getElementById('userModalTitle').textContent = isEdit ? '✏️ 사용자 수정' : '➕ 사용자 추가';
            
            if (isEdit) {
                document.getElementById('userId').value = user.id;
                document.getElementById('userUsername').value = user.username;
                document.getElementById('userUsername').disabled = true;
                document.getElementById('userPassword').required = false;
                document.getElementById('userPassword').placeholder = '변경하지 않으려면 비워두세요';
                document.getElementById('userName').value = user.name;
                document.getElementById('userEmail').value = user.email;
                document.getElementById('userRole').value = user.role;
            } else {
                document.getElementById('userForm').reset();
                document.getElementById('userUsername').disabled = false;
                document.getElementById('userPassword').required = true;
                document.getElementById('userPassword').placeholder = '6자 이상 입력하세요';
            }

            hideAlert('userModalError');
            document.getElementById('userModal').classList.add('show');
            
            // 첫 번째 입력 필드에 포커스
            setTimeout(() => {
                if (!isEdit) {
                    document.getElementById('userUsername').focus();
                } else {
                    document.getElementById('userName').focus();
                }
            }, 100);
        }

        // 사용자 모달 닫기
        function closeUserModal() {
            closeModal('userModal');
        }

        // 사용자 수정
        function editUser(index) {
            const user = currentUsersData[index];
            openUserModal(user);
        }

        // 사용자 삭제
        async function deleteUser(index) {
            const user = currentUsersData[index];
            
            if (confirm(`⚠️ 사용자 '${user.name}'를 삭제하시겠습니까?\n\n이 작업은 되돌릴 수 없습니다.`)) {
                try {
                    const result = await GoogleAppsScriptAPI.deleteUser(user.id);

                    if (result.success) {
                        await loadUsersSection();
                        alert('✅ 사용자가 삭제되었습니다.');
                    } else {
                        alert('❌ 삭제 중 오류가 발생했습니다: ' + result.error);
                    }
                } catch (error) {
                    Utils.debugLog('사용자 삭제 오류:', error);
                    alert('❌ 삭제 중 오류가 발생했습니다: ' + error.message);
                }
            }
        }

        // 사용자 저장
        async function saveUser() {
            const userId = document.getElementById('userId').value;
            const username = document.getElementById('userUsername').value.trim();
            const password = document.getElementById('userPassword').value;
            const name = document.getElementById('userName').value.trim();
            const email = document.getElementById('userEmail').value.trim();
            const role = document.getElementById('userRole').value;

            // 유효성 검사
            if (!username || !name || !email || !role) {
                showAlert('userModalError', '필수 항목을 모두 입력해주세요.', 'error');
                return;
            }

            if (!Utils.isValidEmail(email)) {
                showAlert('userModalError', '올바른 이메일 주소를 입력해주세요.', 'error');
                return;
            }

            if (!userId && !password) {
                showAlert('userModalError', '새 사용자는 비밀번호가 필요합니다.', 'error');
                return;
            }

            if (password) {
                const passwordValidation = Utils.isValidPassword(password);
                if (!passwordValidation.valid) {
                    showAlert('userModalError', passwordValidation.message, 'error');
                    return;
                }
            }

            try {
                const isEdit = !!userId;
                
                // 버튼 상태 변경
                const saveBtn = document.querySelector('#userModal .btn-success');
                const btnText = document.getElementById('userSaveBtnText');
                saveBtn.disabled = true;
                btnText.textContent = '저장 중...';
                
                const userData = {
                    id: userId || Utils.generateUUID(),
                    username: username,
                    name: name,
                    email: email,
                    role: role,
                    status: 'approved',
                    createdAt: isEdit ? null : Utils.getCurrentDateTime(),
                    lastLogin: isEdit ? null : null
                };

                // 비밀번호가 있으면 해시 처리
                if (password) {
                    userData.passwordHash = Utils.simpleHash(password, username);
                }

                let result;
                if (isEdit) {
                    result = await GoogleAppsScriptAPI.updateUser(userId, userData);
                } else {
                    result = await GoogleAppsScriptAPI.addUser(userData);
                }

                if (result.success) {
                    await loadUsersSection();
                    closeUserModal();
                    
                    alert(`✅ ${isEdit ? '사용자가 수정되었습니다.' : '사용자가 추가되었습니다.'}`);
                } else {
                    showAlert('userModalError', result.error || '저장 중 오류가 발생했습니다.', 'error');
                }

            } catch (error) {
                Utils.debugLog('사용자 저장 오류:', error);
                showAlert('userModalError', '사용자 저장 중 오류가 발생했습니다: ' + error.message, 'error');
            } finally {
                // 버튼 복원
                const saveBtn = document.querySelector('#userModal .btn-success');
                const btnText = document.getElementById('userSaveBtnText');
                saveBtn.disabled = false;
                btnText.textContent = '💾 저장';
            }
        }

        // 계정 신청 승인 모달 열기
        function openApprovalModal(index) {
            const request = currentRequestsData[index];
            
            document.getElementById('approvalRequestId').value = request.id;
            document.getElementById('approvalRequestName').textContent = request.name;
            document.getElementById('approvalRequestInfo').textContent = 
                `${request.email} | ${request.department} | ${getRoleDisplayName(request.role)}`;
            
            // 희망 사용자 ID가 있으면 미리 채워넣기
            document.getElementById('approvalUsername').value = request.requestedUsername || '';
            document.getElementById('approvalPassword').value = '';
            document.getElementById('approvalNote').value = '';

            hideAlert('approvalModalError');
            document.getElementById('approvalModal').classList.add('show');
            
            setTimeout(() => {
                const usernameField = document.getElementById('approvalUsername');
                if (usernameField.value) {
                    document.getElementById('approvalPassword').focus();
                } else {
                    usernameField.focus();
                }
            }, 100);
        }

        // 승인 모달 닫기
        function closeApprovalModal() {
            closeModal('approvalModal');
            hideAlert('approvalModalError');
        }

        // 계정 신청 승인 처리
        async function approveAccountRequest() {
            const requestId = document.getElementById('approvalRequestId').value;
            const username = document.getElementById('approvalUsername').value.trim();
            const password = document.getElementById('approvalPassword').value;
            const note = document.getElementById('approvalNote').value.trim();

            if (!username || !password) {
                showAlert('approvalModalError', '사용자 ID와 임시 비밀번호를 모두 입력해주세요.', 'error');
                return;
            }

            const passwordValidation = Utils.isValidPassword(password);
            if (!passwordValidation.valid) {
                showAlert('approvalModalError', passwordValidation.message, 'error');
                return;
            }

            try {
                // 버튼 상태 변경
                const approveBtn = document.querySelector('#approvalModal .btn-success');
                const btnText = document.getElementById('approvalSaveBtnText');
                approveBtn.disabled = true;
                btnText.textContent = '승인 처리 중...';

                const approvalData = {
                    username: username,
                    password: password,
                    note: note
                };

                const result = await GoogleAppsScriptAPI.approveRequest(requestId, approvalData);

                if (result.success) {
                    closeApprovalModal();
                    await loadRequestsSection(); // 목록 새로고침
                    
                    alert(`✅ 계정이 승인되어 생성되었습니다!\n\n👤 사용자: ${result.user.name}\n🆔 사용자 ID: ${result.user.username}\n📧 이메일: ${result.user.email}\n\n💡 생성된 임시 비밀번호를 사용자에게 전달해주세요.`);
                } else {
                    showAlert('approvalModalError', result.error || '승인 처리 중 오류가 발생했습니다.', 'error');
                }

            } catch (error) {
                Utils.debugLog('승인 처리 오류:', error);
                showAlert('approvalModalError', '승인 처리 중 오류가 발생했습니다: ' + error.message, 'error');
            } finally {
                // 버튼 복원
                const approveBtn = document.querySelector('#approvalModal .btn-success');
                const btnText = document.getElementById('approvalSaveBtnText');
                approveBtn.disabled = false;
                btnText.textContent = '✅ 승인 및 계정 생성';
            }
        }

        // 계정 신청 거부
        async function rejectRequest(index) {
            const request = currentRequestsData[index];
            
            const reason = prompt(`⚠️ 계정 신청을 거부하시겠습니까?\n\n신청자: ${request.name}\n이메일: ${request.email}\n\n거부 사유를 입력해주세요 (선택사항):`);
            
            if (reason === null) return; // 취소한 경우

            try {
                const result = await GoogleAppsScriptAPI.rejectRequest(request.id, reason);

                if (result.success) {
                    await loadRequestsSection(); // 목록 새로고침
                    alert(`❌ 계정 신청이 거부되었습니다.\n\n신청자: ${request.name}\n사유: ${reason || '사유 없음'}`);
                } else {
                    alert('❌ 거부 처리 중 오류가 발생했습니다: ' + result.error);
                }

            } catch (error) {
                Utils.debugLog('거부 처리 오류:', error);
                alert('❌ 거부 처리 중 오류가 발생했습니다: ' + error.message);
            }
        }

        // 계정 신청 모달 열기
        function openAccountRequestModal() {
            document.getElementById('accountRequestForm').reset();
            hideAlert('accountRequestError');
            hideAlert('accountRequestSuccess');
            document.getElementById('accountRequestModal').classList.add('show');
            
            // 첫 번째 입력 필드에 포커스
            setTimeout(() => {
                document.getElementById('requestName').focus();
            }, 100);
        }

        // 계정 신청 모달 닫기
        function closeAccountRequestModal() {
            closeModal('accountRequestModal');
        }

        // 계정 신청서 제출
        async function submitAccountRequest() {
            const formData = {
                name: document.getElementById('requestName').value.trim(),
                email: document.getElementById('requestEmail').value.trim(),
                phone: document.getElementById('requestPhone').value.trim(),
                department: document.getElementById('requestDepartment').value.trim(),
                position: document.getElementById('requestPosition').value.trim(),
                role: document.getElementById('requestRole').value,
                reason: document.getElementById('requestReason').value.trim(),
                userId: document.getElementById('requestUserId').value.trim()
            };

            // 유효성 검사
            if (!formData.name || !formData.email || !formData.phone || 
                !formData.department || !formData.role || !formData.reason) {
                showAlert('accountRequestError', '필수 항목(*)을 모두 입력해주세요.', 'error');
                return;
            }

            if (!Utils.isValidEmail(formData.email)) {
                showAlert('accountRequestError', '올바른 이메일 주소를 입력해주세요.', 'error');
                return;
            }

            // 전화번호 형식 간단 체크
            const phoneRegex = /^[\d\-\+\(\)\s]{10,}$/;
            if (!phoneRegex.test(formData.phone)) {
                showAlert('accountRequestError', '올바른 전화번호를 입력해주세요.', 'error');
                return;
            }

            try {
                // 버튼 상태 변경
                const submitBtn = document.querySelector('#accountRequestModal .btn-primary');
                const btnText = document.getElementById('accountRequestBtnText');
                submitBtn.disabled = true;
                btnText.textContent = '📧 제출 중...';

                // 현재 날짜/시간 추가
                formData.requestDate = new Date().toLocaleString('ko-KR');
                
                const result = await GoogleAppsScriptAPI.submitAccountRequest(formData);

                if (result.success) {
                    showAlert('accountRequestSuccess', 
                        '✅ 계정 신청이 완료되었습니다!\n관리자 검토 후 승인됩니다.', 'success');
                    
                    // 3초 후 모달 닫기
                    setTimeout(() => {
                        closeAccountRequestModal();
                    }, 3000);
                } else {
                    throw new Error(result.error || '신청서 제출에 실패했습니다.');
                }

            } catch (error) {
                Utils.debugLog('계정 신청 오류:', error);
                showAlert('accountRequestError', `제출 실패: ${error.message}`, 'error');

            } finally {
                // 버튼 복원
                const submitBtn = document.querySelector('#accountRequestModal .btn-primary');
                const btnText = document.getElementById('accountRequestBtnText');
                submitBtn.disabled = false;
                btnText.textContent = '📧 신청서 제출';
            }
        }

        // 비밀번호 표시/숨기기 토글
        function togglePassword(inputId) {
            const input = document.getElementById(inputId);
            const button = input.nextElementSibling;
            
            if (input.type === 'password') {
                input.type = 'text';
                button.textContent = '🙈';
            } else {
                input.type = 'password';
                button.textContent = '👁️';
            }
        }

        // 알림 메시지 표시
        function showAlert(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `alert alert-${type}`;
            element.classList.remove('hidden');
            
            if (type === 'success') {
                setTimeout(() => hideAlert(elementId), CONFIG.UI.TOAST_DURATION);
            }
        }

        // 알림 메시지 숨기기
        function hideAlert(elementId) {
            document.getElementById(elementId).classList.add('hidden');
        }

        // 요소 표시
        function showElement(elementId) {
            document.getElementById(elementId).classList.remove('hidden');
        }

        // 요소 숨기기
        function hideElement(elementId) {
            document.getElementById(elementId).classList.add('hidden');
        }

        // 모달 닫기
        function closeModal(modal) {
            if (typeof modal === 'string') {
                modal = document.getElementById(modal);
            }
            modal.classList.remove('show');
        }

        // 로딩 표시
        function showLoading(elementId) {
            showElement(elementId);
        }

        // 로딩 숨기기
        function hideLoading(elementId) {
            hideElement(elementId);
        }
    </script>
</body>
</html>
