<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>íˆ¬ì–´ë¹„ìŠ¤ í•­ê³µ(êµ­ì œì„ ) Missing Call ì²˜ë¦¬ ì‹œìŠ¤í…œ</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- ì—°ê²° ìƒíƒœ í‘œì‹œ -->
    <div id="connectionStatus" class="connection-status">
        <span id="connectionText">ì—°ê²° í™•ì¸ ì¤‘...</span>
    </div>

    <!-- ë¡œë”© í™”ë©´ -->
    <div id="initialLoading" class="login-container">
        <div class="login-box text-center">
            <h2>ğŸš€ ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì¤‘...</h2>
            <div class="loading">
                ì„¤ì •ì„ í™•ì¸í•˜ê³  ìˆìŠµë‹ˆë‹¤<span class="spinner"></span>
            </div>
            <div id="initStatus" class="text-small mt-20">
                <!-- ì´ˆê¸°í™” ìƒíƒœ ë©”ì‹œì§€ -->
            </div>
        </div>
    </div>

    <!-- ë¡œê·¸ì¸ í™”ë©´ -->
    <div id="loginContainer" class="login-container hidden">
        <div class="login-box">
            <div class="login-header">
                <h1>íˆ¬ì–´ë¹„ìŠ¤</h1>
                <p>í•­ê³µ(êµ­ì œì„ ) Missing Call ì²˜ë¦¬ ì‹œìŠ¤í…œ</p>
            </div>
            
            <form id="loginForm">
                <div class="form-group">
                    <label for="loginUsername">ì‚¬ìš©ì ID</label>
                    <input type="text" id="loginUsername" required autocomplete="username" placeholder="ì‚¬ìš©ì IDë¥¼ ì…ë ¥í•˜ì„¸ìš”" style="width: 100%; min-width: 250px;">
                </div>
                
                <div class="form-group">
                    <label for="loginPassword">ë¹„ë°€ë²ˆí˜¸</label>
                    <div class="password-container">
                        <input type="password" id="loginPassword" required autocomplete="current-password" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”" style="width: 100%; min-width: 250px;">
                        <button type="button" class="password-toggle" onclick="togglePassword('loginPassword')">ğŸ‘ï¸</button>
                    </div>
                </div>
                
                <div class="checkbox-group">
                    <input type="checkbox" id="rememberMe">
                    <label for="rememberMe">ë¡œê·¸ì¸ ìƒíƒœ ìœ ì§€ (7ì¼)</label>
                </div>
                
                <button type="submit" class="btn btn-primary">
                    <span id="loginBtnText">ë¡œê·¸ì¸</span>
                </button>
                
                <button type="button" class="btn btn-secondary mt-10" onclick="openAccountRequestModal()" style="width: 100%;">
                    ğŸ“§ ê³„ì • ì‹ ì²­
                </button>
            </form>
            
            <div id="loginError" class="alert alert-error hidden"></div>
            
            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee; font-size: 0.85rem; color: #666; text-align: center;">
                Â© 2025 TideSquare. All rights reserved.<br>
                <span class="text-small">ê³„ì • ë¬¸ì˜: ê¹€ì˜í›ˆ ë‹´ë‹¹ì</span>
            </div>
        </div>
    </div>

    <!-- ë©”ì¸ ì»¨í…Œì´ë„ˆ -->
    <div id="mainContainer" class="main-container">
        <!-- ê³ ì • í—¤ë” -->
        <div class="fixed-header">
            <div class="header">
                <h1>íˆ¬ì–´ë¹„ìŠ¤ Missing Call ê´€ë¦¬ ì‹œìŠ¤í…œ</h1>
                <div class="user-info">
                    <span class="user-name" id="currentUserName">ì‚¬ìš©ì</span>
                    <span class="user-role" id="currentUserRole">ê¶Œí•œ</span>
                    <button class="btn btn-secondary btn-small" onclick="logout()" title="ì‹œìŠ¤í…œì—ì„œ ë¡œê·¸ì•„ì›ƒ">ğŸšª ë¡œê·¸ì•„ì›ƒ</button>
                </div>
            </div>

            <div class="nav-menu">
                <div class="nav-buttons">
                    <button class="nav-btn active" onclick="showSection('dashboard')">ğŸ“Š ëŒ€ì‹œë³´ë“œ</button>
                    <button class="nav-btn hidden" onclick="showSection('users')" id="usersMenuBtn">ğŸ‘¥ ì‚¬ìš©ì ê´€ë¦¬</button>
                    <button class="nav-btn hidden" onclick="showSection('requests')" id="requestsMenuBtn">ğŸ“‹ ê³„ì • ì‹ ì²­ ê´€ë¦¬</button>
                </div>
            </div>
            
            <!-- ê²€ìƒ‰ ì„¹ì…˜ì„ í—¤ë”ë¡œ ì´ë™ -->
            <div class="search-section">
                <div class="search-form">
                    <div class="form-group">
                        <label for="searchDate">ì¡°íšŒ ì¼ì</label>
                        <input type="date" id="searchDate">
                    </div>
                    <div class="form-group">
                        <label for="processFilter">ì²˜ë¦¬ ìƒíƒœ</label>
                        <select id="processFilter">
                            <option value="all">ì „ì²´</option>
                            <option value="processed">ì²˜ë¦¬ ì™„ë£Œ</option>
                            <option value="pending">ë¯¸ì²˜ë¦¬</option>
                            <option value="onhold">ë³´ë¥˜</option>
                            <option value="retry">ì¬ì‹œë„ í•„ìš”</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="queueFilter">ì¸ì…í</label>
                        <select id="queueFilter">
                            <option value="all">ì „ì²´</option>
                            <option value="íˆ¬ì–´ë¹„ìŠ¤-í•­ê³µ ê¸°íƒ€ë¬¸ì˜">ê¸°íƒ€ë¬¸ì˜</option>
                            <option value="íˆ¬ì–´ë¹„ìŠ¤-í•­ê³µ í™˜ë¶ˆë¬¸ì˜">í™˜ë¶ˆë¬¸ì˜</option>
                            <option value="íˆ¬ì–´ë¹„ìŠ¤-í•­ê³µ ì¼ì •ë³€ê²½ë¬¸ì˜">ì¼ì •ë³€ê²½ë¬¸ì˜</option>
                            <option value="íˆ¬ì–´ë¹„ìŠ¤-í•­ê³µ ì˜ˆì•½ë‚´ìš©í™•ì¸">ì˜ˆì•½ë‚´ìš©í™•ì¸</option>
                            <option value="íˆ¬ì–´ë¹„ìŠ¤-í•­ê³µ ì—¬ê¶Œ/ì²´ë¥˜ìê´€ë ¨ë¬¸ì˜">ì—¬ê¶Œ/ì²´ë¥˜ìê´€ë ¨ë¬¸ì˜</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <button type="button" class="btn btn-primary" onclick="searchCalls()">
                            ğŸ“‹ ì¡°íšŒ
                        </button>
                    </div>
                    <div class="form-group">
                        <button class="btn btn-secondary" onclick="refreshConnection()">ğŸ”„ ì—°ê²° í™•ì¸</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ì»¨í…ì¸  ì˜ì—­ -->
        <div class="content-wrapper">
            <!-- ëŒ€ì‹œë³´ë“œ ì„¹ì…˜ -->
            <div id="dashboardSection" class="section active">
                <div id="loadingMessage" class="loading hidden">
                    ë°ì´í„°ë¥¼ ì¡°íšŒí•˜ê³  ìˆìŠµë‹ˆë‹¤<span class="spinner"></span>
                </div>
                <div id="loadingMessage" class="loading hidden">
                    ë°ì´í„°ë¥¼ ì¡°íšŒí•˜ê³  ìˆìŠµë‹ˆë‹¤<span class="spinner"></span>
                </div>

                <div id="callsResults" class="results-container hidden">
                    <div class="results-header">
                        <h3 id="resultsCount">ì¡°íšŒ ê²°ê³¼</h3>
                        <div>
                            <button class="btn btn-secondary btn-small" onclick="searchCalls()" title="ì„œë²„ì—ì„œ ìµœì‹  ë°ì´í„°ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤">
                                ğŸ”„ ìƒˆë¡œê³ ì¹¨
                            </button>
                            <button class="btn btn-primary btn-small" onclick="exportToCSV()" style="margin-left: 8px;">ğŸ“¥ CSV ë‚´ë³´ë‚´ê¸°</button>
                        </div>
                    </div>
                    
                    <div class="results-content">
                        <div class="table-container">
                            <table id="callsTable">
                                <thead>
                                    <tr>
                                        <th>ìˆœë²ˆ</th>
                                        <th>ë°œìƒì¼</th>
                                        <th class="sortable-header" onclick="sortTable('startTime')" title="í´ë¦­í•˜ì—¬ ì •ë ¬">
                                            ì¸ì…ì‹œê°„
                                            <span id="sortArrow-startTime" class="sort-arrow desc active"></span>
                                        </th>
                                        <th>ëŒ€ê¸°ì‹œê°„(ë¶„)</th>
                                        <th>ì „í™”ë²ˆí˜¸</th>
                                        <th>ì¸ì…í</th>
                                        <th class="sortable-header" onclick="sortTable('callCount')" title="í´ë¦­í•˜ì—¬ ì •ë ¬">
                                            ì¤‘ë³µíšŸìˆ˜
                                            <span id="sortArrow-callCount" class="sort-arrow none"></span>
                                        </th>
                                        <th>ì²˜ë¦¬ìƒíƒœ</th>
                                        <th>ì²˜ë¦¬ë‹´ë‹¹ì</th>
                                        <th>ì•¡ì…˜</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="noDataMessage" class="no-data-message text-center hidden">
                    <h3 id="noDataTitle">ğŸ“­ ì¡°íšŒëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</h3>
                    <p id="noDataSubtitle">ë‹¤ë¥¸ ë‚ ì§œë¥¼ ì„ íƒí•˜ê±°ë‚˜ í•„í„° ì¡°ê±´ì„ ë³€ê²½í•´ë³´ì„¸ìš”.</p>
                </div>
            </div>

            <!-- ì‚¬ìš©ì ê´€ë¦¬ ì„¹ì…˜ -->
            <div id="usersSection" class="section">
                <div class="section-header">
                    <h2>ì‚¬ìš©ì ê´€ë¦¬</h2>
                    <button class="btn btn-primary" onclick="openUserModal()">â• ìƒˆ ì‚¬ìš©ì ì¶”ê°€</button>
                </div>

                <div id="usersLoading" class="loading hidden">
                    ì‚¬ìš©ì ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ê³  ìˆìŠµë‹ˆë‹¤<span class="spinner"></span>
                </div>

                <div id="usersResults" class="table-container">
                    <table id="usersTable">
                        <thead>
                            <tr>
                                <th>ì‚¬ìš©ì ID</th>
                                <th>ì‹¤ëª…</th>
                                <th>ì´ë©”ì¼</th>
                                <th>ê¶Œí•œ</th>
                                <th>ìƒíƒœ</th>
                                <th>ë“±ë¡ì¼</th>
                                <th>ë§ˆì§€ë§‰ ë¡œê·¸ì¸</th>
                                <th>ì•¡ì…˜</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- ê³„ì • ì‹ ì²­ ê´€ë¦¬ ì„¹ì…˜ -->
            <div id="requestsSection" class="section">
                <div class="section-header">
                    <h2>ê³„ì • ì‹ ì²­ ê´€ë¦¬</h2>
                    <button class="btn btn-secondary" onclick="loadRequestsSection()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
                </div>

                <div id="requestsLoading" class="loading hidden">
                    ê³„ì • ì‹ ì²­ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ê³  ìˆìŠµë‹ˆë‹¤<span class="spinner"></span>
                </div>

                <div id="requestsResults" class="table-container">
                    <table id="requestsTable">
                        <thead>
                            <tr>
                                <th>ì‹ ì²­ì¼</th>
                                <th>ì‹ ì²­ì</th>
                                <th>ì´ë©”ì¼</th>
                                <th>ì—°ë½ì²˜</th>
                                <th>ë¶€ì„œ/íŒ€</th>
                                <th>ìš”ì²­ ê¶Œí•œ</th>
                                <th>í¬ë§ ID</th>
                                <th>ìƒíƒœ</th>
                                <th>ì•¡ì…˜</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <div id="noRequestsMessage" class="text-center hidden" style="padding: 40px; color: #666;">
                    <h3>ğŸ“­ ëŒ€ê¸° ì¤‘ì¸ ê³„ì • ì‹ ì²­ì´ ì—†ìŠµë‹ˆë‹¤</h3>
                    <p>ìƒˆë¡œìš´ ì‹ ì²­ì´ ì ‘ìˆ˜ë˜ë©´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ì‚¬ìš©ì ë“±ë¡/ìˆ˜ì • ëª¨ë‹¬ -->
    <div id="userModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="userModalTitle">ì‚¬ìš©ì ì¶”ê°€</h3>
            </div>
            
            <form id="userForm">
                <input type="hidden" id="userId">
                
                <div class="form-group">
                    <label for="userUsername">ì‚¬ìš©ì ID *</label>
                    <input type="text" id="userUsername" required placeholder="ì˜ë¬¸/ìˆ«ìë¡œ ì…ë ¥í•˜ì„¸ìš”" autocomplete="username">
                </div>
                
                <div class="form-group">
                    <label for="userPassword">ë¹„ë°€ë²ˆí˜¸ *</label>
                    <div class="password-container">
                        <input type="password" id="userPassword" placeholder="6ì ì´ìƒ ì…ë ¥í•˜ì„¸ìš”" autocomplete="new-password">
                        <button type="button" class="password-toggle" onclick="togglePassword('userPassword')">ğŸ‘ï¸</button>
                    </div>
                    <small class="text-small">ìˆ˜ì •ì‹œ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë³€ê²½í•˜ì§€ ì•Šìœ¼ë ¤ë©´ ë¹„ì›Œë‘ì„¸ìš”</small>
                </div>
                
                <div class="form-group">
                    <label for="userName">ì‹¤ëª… *</label>
                    <input type="text" id="userName" required placeholder="ì‹¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”" autocomplete="name">
                </div>
                
                <div class="form-group">
                    <label for="userEmail">ì´ë©”ì¼ *</label>
                    <input type="email" id="userEmail" required placeholder="email@example.com" autocomplete="email">
                </div>
                
                <div class="form-group">
                    <label for="userRole">ê¶Œí•œ *</label>
                    <select id="userRole" required>
                        <option value="">ê¶Œí•œì„ ì„ íƒí•˜ì„¸ìš”</option>
                        <option value="user">ì¼ë°˜ ì‚¬ìš©ì</option>
                        <option value="manager">ê´€ë¦¬ì</option>
                        <option value="admin">ì‹œìŠ¤í…œ ê´€ë¦¬ì</option>
                    </select>
                </div>
            </form>

            <div id="userModalError" class="alert alert-error hidden"></div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeUserModal()">ì·¨ì†Œ</button>
                <button type="button" class="btn btn-success" onclick="saveUser()">
                    <span id="userSaveBtnText">ğŸ’¾ ì €ì¥</span>
                </button>
            </div>
        </div>
    </div>

    <!-- ê³„ì • ì‹ ì²­ ìŠ¹ì¸ ëª¨ë‹¬ -->
    <div id="approvalModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>âœ… ê³„ì • ì‹ ì²­ ìŠ¹ì¸</h3>
                <p style="color: #666; margin: 5px 0 0 0;">
                    ì‹ ì²­ì: <span id="approvalRequestName" class="font-bold"></span><br>
                    <span id="approvalRequestInfo" style="font-size: 0.9rem;"></span>
                </p>
            </div>
            
            <form id="approvalForm">
                <input type="hidden" id="approvalRequestId">
                
                <div class="form-group">
                    <label for="approvalUsername">ì‚¬ìš©ì ID *</label>
                    <input type="text" id="approvalUsername" required placeholder="ì˜ë¬¸/ìˆ«ìë¡œ ì…ë ¥í•˜ì„¸ìš”">
                    <small class="text-small">ì‹ ì²­ìê°€ ìš”ì²­í•œ IDë¥¼ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</small>
                </div>
                
                <div class="form-group">
                    <label for="approvalPassword">ì„ì‹œ ë¹„ë°€ë²ˆí˜¸ *</label>
                    <div class="password-container">
                        <input type="password" id="approvalPassword" required placeholder="6ì ì´ìƒ ì…ë ¥í•˜ì„¸ìš”">
                        <button type="button" class="password-toggle" onclick="togglePassword('approvalPassword')">ğŸ‘ï¸</button>
                    </div>
                    <small class="text-small">ì‚¬ìš©ìê°€ ì²« ë¡œê·¸ì¸ í›„ ë³€ê²½í•˜ë„ë¡ ì•ˆë‚´í•˜ì„¸ìš”.</small>
                </div>
                
                <div class="form-group">
                    <label for="approvalNote">ìŠ¹ì¸ ë©”ëª¨ (ì„ íƒ)</label>
                    <textarea id="approvalNote" rows="2" placeholder="ìŠ¹ì¸ ì‹œ íŠ¹ì´ì‚¬í•­ì´ë‚˜ ì „ë‹¬ ë©”ì‹œì§€"></textarea>
                </div>
            </form>

            <div id="approvalModalError" class="alert alert-error hidden"></div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeApprovalModal()">ì·¨ì†Œ</button>
                <button type="button" class="btn btn-success" onclick="approveAccountRequest()">
                    <span id="approvalSaveBtnText">âœ… ìŠ¹ì¸ ë° ê³„ì • ìƒì„±</span>
                </button>
            </div>
        </div>
    </div>

    <!-- OBì½œ ì²˜ë¦¬ ëª¨ë‹¬ - UI ê°œì„  ì™„ë£Œ ë²„ì „ -->
    <div id="processModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ğŸ“ Missing Call ì²˜ë¦¬</h3>
                <div class="call-info-card">
                    <div class="call-info-row">
                        <span class="info-label">ì „í™”ë²ˆí˜¸:</span>
                        <span id="modalPhoneNumber" class="phone-number"></span>
                    </div>
                    <div class="call-info-row">
                        <span id="modalCallInfo" class="info-details"></span>
                    </div>
                </div>
            </div>
            
            <form id="processForm">
                <!-- ì²˜ë¦¬ ìƒíƒœì™€ ë‹´ë‹¹ìë¥¼ ê°™ì€ í–‰ì— ë°°ì¹˜ (ì¢Œìš° 50:50) -->
                <div class="form-row-horizontal">
                    <div class="form-group form-group-half">
                        <label for="processStatus">ì²˜ë¦¬ ìƒíƒœ *</label>
                        <select id="processStatus" required>
                            <option value="">ì„ íƒí•´ì£¼ì„¸ìš”</option>
                            <option value="ì™„ë£Œ">âœ… ì™„ë£Œ</option>
                            <option value="ë¯¸ì™„ë£Œ">âŒ ë¯¸ì™„ë£Œ</option>
                            <option value="ë³´ë¥˜">â¸ï¸ ë³´ë¥˜</option>
                            <option value="ì¬ì‹œë„">ğŸ”„ ì¬ì‹œë„ í•„ìš”</option>
                        </select>
                    </div>
                    
                    <div class="form-group form-group-half">
                        <label for="processManager">ë‹´ë‹¹ì *</label>
                        <input type="text" id="processManager" required placeholder="ë‹´ë‹¹ìëª…ì„ ì…ë ¥í•˜ì„¸ìš”" autocomplete="name">
                    </div>
                </div>

                <!-- ì²˜ë¦¬ ë©”ëª¨ëŠ” ì „ì²´ ë„ˆë¹„ë¡œ í™•ì¥ -->
                <div class="form-group form-group-full">
                    <label for="processNote">ì²˜ë¦¬ ë©”ëª¨</label>
                    <textarea id="processNote" rows="4" placeholder="ì²˜ë¦¬ ë‚´ìš©ì´ë‚˜ íŠ¹ì´ì‚¬í•­ì„ ì…ë ¥í•˜ì„¸ìš” (ì„ íƒì‚¬í•­)"></textarea>
                </div>
            </form>

            <div id="processModalError" class="alert alert-error hidden"></div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeProcessModal()">ì·¨ì†Œ</button>
                <button type="button" class="btn btn-success" onclick="saveProcess()">
                    <span id="processSaveBtnText">ğŸ’¾ ì €ì¥</span>
                </button>
                <button type="button" class="btn btn-primary" onclick="saveAndNext()" title="ì €ì¥ í›„ ë‹¤ìŒ ë¯¸ì²˜ë¦¬ ê±´ìœ¼ë¡œ ì´ë™">
                    â© ì €ì¥ í›„ ë‹¤ìŒ
                </button>
            </div>
        </div>
    </div>

    <!-- ê³„ì • ì‹ ì²­ ëª¨ë‹¬ -->
    <div id="accountRequestModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ğŸ“§ ê³„ì • ì‹ ì²­</h3>
                <p style="color: #666; margin: 5px 0 0 0; font-size: 0.9rem;">
                    ì‹ ì²­ì„œë¥¼ ì‘ì„±í•´ì£¼ì‹œë©´ ê´€ë¦¬ìê°€ ê²€í†  í›„ ê³„ì •ì„ ìƒì„±í•´ ë“œë¦½ë‹ˆë‹¤.
                </p>
            </div>
            
            <form id="accountRequestForm">
                <div class="form-group">
                    <label for="requestName">ì„±ëª… *</label>
                    <input type="text" id="requestName" required placeholder="ì‹¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”" autocomplete="name">
                </div>
                
                <div class="form-group">
                    <label for="requestEmail">ì´ë©”ì¼ *</label>
                    <input type="email" id="requestEmail" required placeholder="email@company.com" autocomplete="email">
                </div>
                
                <div class="form-group">
                    <label for="requestPhone">ì—°ë½ì²˜ *</label>
                    <input type="tel" id="requestPhone" required placeholder="010-0000-0000" autocomplete="tel">
                </div>
                
                <div class="form-group">
                    <label for="requestDepartment">ë¶€ì„œ/íŒ€ *</label>
                    <input type="text" id="requestDepartment" required placeholder="ì†Œì† ë¶€ì„œë‚˜ íŒ€ì„ ì…ë ¥í•˜ì„¸ìš”">
                </div>
                
                <div class="form-group">
                    <label for="requestPosition">ì§ê¸‰/ì§ì±…</label>
                    <input type="text" id="requestPosition" placeholder="ì§ê¸‰ì´ë‚˜ ì§ì±…ì„ ì…ë ¥í•˜ì„¸ìš”">
                </div>
                
                <div class="form-group">
                    <label for="requestRole">ìš”ì²­ ê¶Œí•œ *</label>
                    <select id="requestRole" required>
                        <option value="">ê¶Œí•œì„ ì„ íƒí•˜ì„¸ìš”</option>
                        <option value="user">ì¼ë°˜ ì‚¬ìš©ì (ì¡°íšŒ ë° ì²˜ë¦¬ë§Œ ê°€ëŠ¥)</option>
                        <option value="manager">ê´€ë¦¬ì (ì‚¬ìš©ì ê´€ë¦¬ í¬í•¨)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="requestReason">ì‹ ì²­ ì‚¬ìœ  *</label>
                    <textarea id="requestReason" rows="3" required placeholder="ê³„ì •ì´ í•„ìš”í•œ ì—…ë¬´ìƒ ì‚¬ìœ ë¥¼ ê°„ë‹¨íˆ ì„¤ëª…í•´ì£¼ì„¸ìš”"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="requestUserId">í¬ë§ ì‚¬ìš©ì ID (ì‚¬ë²ˆ)</label>
                    <input type="text" id="requestUserId" placeholder="ì‚¬ë²ˆì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: T2025001)">
                    <small class="text-small">ë³¸ì¸ì˜ ì‚¬ë²ˆì„ ì…ë ¥í•´ì£¼ì„¸ìš”. ë¹„ì›Œë‘ì‹œë©´ ê´€ë¦¬ìê°€ ì‚¬ë²ˆìœ¼ë¡œ ìƒì„±í•´ ë“œë¦½ë‹ˆë‹¤.</small>
                </div>
            </form>

            <div id="accountRequestError" class="alert alert-error hidden"></div>
            <div id="accountRequestSuccess" class="alert alert-success hidden"></div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeAccountRequestModal()">ì·¨ì†Œ</button>
                <button type="button" class="btn btn-primary" onclick="submitAccountRequest()">
                    <span id="accountRequestBtnText">ğŸ“§ ì‹ ì²­ì„œ ì œì¶œ</span>
                </button>
            </div>
        </div>
    </div>

    <!-- config.js íŒŒì¼ ë¡œë“œ -->
    <script src="config.js"></script>
    
    <script>
        // ì „ì—­ ë³€ìˆ˜
        let currentUser = null;
        let currentCallsData = [];
        let currentUsersData = [];
        let currentRequestsData = [];
        let currentProcessingCall = null;
        let connectionCheckInterval = null;

        // ì •ë ¬ ìƒíƒœ ê´€ë¦¬
        let currentSort = {
            column: 'startTime',    // ê¸°ë³¸ ì •ë ¬ ì¹¼ëŸ¼: ì¸ì…ì‹œê°„
            direction: 'desc'       // ê¸°ë³¸ ì •ë ¬ ë°©í–¥: ë‚´ë¦¼ì°¨ìˆœ (ëŠ¦ì€ ì‹œê°„ë¶€í„°)
        };

        // í˜ì´ì§€ ë¡œë“œì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        // ì•± ì´ˆê¸°í™”
        async function initializeApp() {
            Utils.debugLog('ì•± ì´ˆê¸°í™” ì‹œì‘');
            
            try {
                // ì´ˆê¸°í™” ìƒíƒœ í‘œì‹œ
                updateInitStatus('ì„¤ì • íŒŒì¼ ê²€ì¦ ì¤‘...');
                
                // ì„¤ì • ê²€ì¦
                if (!validateConfig()) {
                    showError('ì„¤ì • íŒŒì¼ì— ì˜¤ë¥˜ê°€ ìˆìŠµë‹ˆë‹¤. config.jsë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.');
                    return;
                }

                updateInitStatus('ì—°ê²° í…ŒìŠ¤íŠ¸ ì¤‘...');
                
                // Apps Script ì—°ê²° í…ŒìŠ¤íŠ¸
                if (CONFIG.API.API_TYPE === 'apps_script') {
                    try {
                        const result = await GoogleAppsScriptAPI.testConnection();
                        if (result.success) {
                            showConnectionStatus('connected', 'âœ… ì—°ê²°ë¨');
                            Utils.debugLog('âœ… Apps Script ì—°ê²° í…ŒìŠ¤íŠ¸ ì„±ê³µ');
                        } else {
                            showConnectionStatus('disconnected', 'âŒ ì—°ê²° ì‹¤íŒ¨');
                            Utils.debugLog('âš ï¸ Apps Script ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨:', result.message);
                        }
                    } catch (error) {
                        showConnectionStatus('disconnected', 'âŒ ì—°ê²° ì‹¤íŒ¨');
                        Utils.debugLog('âš ï¸ Apps Script ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨:', error.message);
                    }
                }

                updateInitStatus('ì„¸ì…˜ í™•ì¸ ì¤‘...');

                // ì„¸ì…˜ í™•ì¸
                const session = SessionManager.getSession();
                if (session) {
                    Utils.debugLog('ê¸°ì¡´ ì„¸ì…˜ ë°œê²¬:', session.username);
                    await loginSuccess(session);
                } else {
                    showLoginScreen();
                }

                // ì˜¤ëŠ˜ ë‚ ì§œ ì„¤ì •
                const today = Utils.getTodayString();
                document.getElementById('searchDate').value = today;
                
                // ê¸°ë³¸ í•„í„° ì„¤ì •
                document.getElementById('processFilter').value = 'all';
                document.getElementById('queueFilter').value = 'all';

                // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
                setupEventListeners();

                // ì£¼ê¸°ì  ì—°ê²° í™•ì¸ ì‹œì‘
                startConnectionMonitoring();

            } catch (error) {
                Utils.debugLog('ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
                showError('ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        // í…Œì´ë¸” ì •ë ¬ í•¨ìˆ˜
        function sortTable(column) {
            Utils.debugLog('ì •ë ¬ ìš”ì²­:', { column, currentSort });
            
            // í˜„ì¬ ì •ë ¬ ì¹¼ëŸ¼ê³¼ ê°™ìœ¼ë©´ ë°©í–¥ ë³€ê²½, ë‹¤ë¥´ë©´ ìƒˆë¡œìš´ ì¹¼ëŸ¼ìœ¼ë¡œ ì˜¤ë¦„ì°¨ìˆœ
            if (currentSort.column === column) {
                if (currentSort.direction === 'asc') {
                    currentSort.direction = 'desc';
                } else if (currentSort.direction === 'desc') {
                    currentSort.direction = 'none';
                } else {
                    currentSort.direction = 'asc';
                }
            } else {
                currentSort.column = column;
                currentSort.direction = 'asc';
            }
            
            // ì •ë ¬ ìƒíƒœì— ë”°ë¼ ë°ì´í„° ì •ë ¬
            let sortedData = [...currentCallsData];
            
            if (currentSort.direction !== 'none') {
                sortedData.sort((a, b) => {
                    let valueA, valueB;
                    
                    if (column === 'startTime') {
                        try {
                            const dateA = Utils.formatDateOnly(a.date) || '';
                            const timeA = Utils.formatTimeOnly(a.startTime) || '';
                            const dateB = Utils.formatDateOnly(b.date) || '';
                            const timeB = Utils.formatTimeOnly(b.startTime) || '';
                            
                            valueA = `${dateA} ${timeA}`;
                            valueB = `${dateB} ${timeB}`;
                            
                        } catch (error) {
                            Utils.debugLog('ì‹œê°„ ì •ë ¬ ì˜¤ë¥˜:', error);
                            valueA = `${a.date} ${a.startTime}`;
                            valueB = `${b.date} ${b.startTime}`;
                        }
                    } else if (column === 'callCount') {
                        valueA = parseInt(a.callCount) || 0;
                        valueB = parseInt(b.callCount) || 0;
                    }
                    
                    // ì •ë ¬ ë°©í–¥ì— ë”°ë¥¸ ë¹„êµ
                    if (currentSort.direction === 'asc') {
                        if (typeof valueA === 'string' && typeof valueB === 'string') {
                            return valueA.localeCompare(valueB);
                        }
                        return valueA - valueB;
                    } else {
                        if (typeof valueA === 'string' && typeof valueB === 'string') {
                            return valueB.localeCompare(valueA);
                        }
                        return valueB - valueA;
                    }
                });
            }
            
            // ì •ë ¬ í™”ì‚´í‘œ ì—…ë°ì´íŠ¸
            updateSortArrows();
            
            // í…Œì´ë¸” ë‹¤ì‹œ ê·¸ë¦¬ê¸°
            displayCallsResultsWithData(sortedData);
            
            Utils.debugLog('ì •ë ¬ ì™„ë£Œ:', { 
                column, 
                direction: currentSort.direction, 
                dataLength: sortedData.length
            });
        }

        // ì •ë ¬ í™”ì‚´í‘œ ì—…ë°ì´íŠ¸
        function updateSortArrows() {
            // ëª¨ë“  í™”ì‚´í‘œ ì´ˆê¸°í™”
            const arrows = document.querySelectorAll('.sort-arrow');
            arrows.forEach(arrow => {
                arrow.className = 'sort-arrow none';
            });
            
            // í˜„ì¬ ì •ë ¬ ì¹¼ëŸ¼ì˜ í™”ì‚´í‘œ ì—…ë°ì´íŠ¸
            const currentArrow = document.getElementById(`sortArrow-${currentSort.column}`);
            if (currentArrow) {
                currentArrow.className = `sort-arrow ${currentSort.direction}`;
                if (currentSort.direction !== 'none') {
                    currentArrow.classList.add('active');
                }
            }
        }

        // ì´ˆê¸°í™” ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateInitStatus(message) {
            const statusEl = document.getElementById('initStatus');
            if (statusEl) {
                statusEl.textContent = message;
            }
        }

        // ì—°ê²° ìƒíƒœ í‘œì‹œ
        function showConnectionStatus(status, text) {
            const statusEl = document.getElementById('connectionStatus');
            const textEl = document.getElementById('connectionText');
            
            statusEl.className = `connection-status ${status} show`;
            textEl.textContent = text;
            
            // 3ì´ˆ í›„ ìë™ ìˆ¨ê¹€ (ì—°ê²°ë¨ ìƒíƒœë§Œ)
            if (status === 'connected') {
                setTimeout(() => {
                    statusEl.classList.remove('show');
                }, 3000);
            }
        }

        // ì—°ê²° ëª¨ë‹ˆí„°ë§ ì‹œì‘
        function startConnectionMonitoring() {
            // 5ë¶„ë§ˆë‹¤ ì—°ê²° ìƒíƒœ í™•ì¸
            connectionCheckInterval = setInterval(async () => {
                try {
                    const result = await GoogleAppsScriptAPI.testConnection();
                    if (!result.success) {
                        showConnectionStatus('disconnected', 'âŒ ì—°ê²° ëŠê¹€');
                    }
                } catch (error) {
                    showConnectionStatus('disconnected', 'âŒ ì—°ê²° ëŠê¹€');
                }
            }, 5 * 60 * 1000); // 5ë¶„
        }

        // ì—°ê²° ìƒˆë¡œê³ ì¹¨
        async function refreshConnection() {
            showConnectionStatus('testing', 'ğŸ”„ ì—°ê²° í™•ì¸ ì¤‘...');
            
            try {
                const result = await GoogleAppsScriptAPI.testConnection();
                if (result.success) {
                    showConnectionStatus('connected', 'âœ… ì—°ê²° ë³µêµ¬ë¨');
                } else {
                    showConnectionStatus('disconnected', 'âŒ ì—°ê²° ì‹¤íŒ¨');
                    alert('âŒ ì—°ê²° í™•ì¸ ì‹¤íŒ¨: ' + result.message);
                }
            } catch (error) {
                showConnectionStatus('disconnected', 'âŒ ì—°ê²° ì‹¤íŒ¨');
                alert('âŒ ì—°ê²° í™•ì¸ ì‹¤íŒ¨: ' + error.message);
            }
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        function setupEventListeners() {
            // ë¡œê·¸ì¸ í¼
            document.getElementById('loginForm').addEventListener('submit', function(e) {
                e.preventDefault();
                handleLogin();
            });

            // ì‚¬ìš©ì í¼
            document.getElementById('userForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveUser();
            });

            // ì²˜ë¦¬ í¼
            document.getElementById('processForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveProcess();
            });

            // ê³„ì • ì‹ ì²­ í¼
            document.getElementById('accountRequestForm').addEventListener('submit', function(e) {
                e.preventDefault();
                submitAccountRequest();
            });

            // ìŠ¹ì¸ í¼
            document.getElementById('approvalForm').addEventListener('submit', function(e) {
                e.preventDefault();
                approveAccountRequest();
            });

            // Enter í‚¤ ì²˜ë¦¬
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    const activeModal = document.querySelector('.modal.show');
                    if (activeModal) {
                        const primaryButton = activeModal.querySelector('.btn-success, .btn-primary');
                        if (primaryButton && !primaryButton.disabled) {
                            primaryButton.click();
                        }
                    }
                }
                
                // ESC í‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸°
                if (e.key === 'Escape') {
                    const openModal = document.querySelector('.modal.show');
                    if (openModal) {
                        closeModal(openModal);
                    }
                }
            });

            // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ì‹œ ë‹«ê¸°
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('modal')) {
                    closeModal(e.target);
                }
            });

            // í˜ì´ì§€ ì–¸ë¡œë“œì‹œ ì •ë¦¬
            window.addEventListener('beforeunload', function() {
                if (connectionCheckInterval) {
                    clearInterval(connectionCheckInterval);
                }
            });
        }

        // ì˜¤ë¥˜ í‘œì‹œ
        function showError(message) {
            document.getElementById('initialLoading').innerHTML = `
                <div class="login-box text-center">
                    <h2 style="color: #dc2626;">âŒ ì˜¤ë¥˜ ë°œìƒ</h2>
                    <div class="alert alert-error">${message}</div>
                    <button class="btn btn-primary mt-20" onclick="location.reload()">ğŸ”„ ë‹¤ì‹œ ì‹œë„</button>
                </div>
            `;
        }

        // ë¡œê·¸ì¸ ì²˜ë¦¬
        async function handleLogin() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            const rememberMe = document.getElementById('rememberMe').checked;

            if (!username || !password) {
                showAlert('loginError', 'ì‚¬ìš©ì IDì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            try {
                Utils.debugLog('ë¡œê·¸ì¸ ì‹œë„:', username);
                
                // ë²„íŠ¼ ìƒíƒœ ë³€ê²½
                const loginBtn = document.querySelector('#loginForm .btn-primary');
                const btnText = document.getElementById('loginBtnText');
                loginBtn.disabled = true;
                btnText.textContent = 'ë¡œê·¸ì¸ ì¤‘...';
                
                // ì‚¬ìš©ì ì¸ì¦
                const result = await GoogleAppsScriptAPI.request('authenticate', { username, password });
                
                if (result.success && result.user) {
                    // ì„¸ì…˜ ìƒì„±
                    SessionManager.setSession(result.user, rememberMe);
                    await loginSuccess(result.user);
                } else {
                    showAlert('loginError', result.error || 'ì‚¬ìš©ì ID ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'error');
                }
            } catch (error) {
                Utils.debugLog('ë¡œê·¸ì¸ ì˜¤ë¥˜:', error);
                showAlert('loginError', 'ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
            } finally {
                // ë²„íŠ¼ ë³µì›
                const loginBtn = document.querySelector('#loginForm .btn-primary');
                const btnText = document.getElementById('loginBtnText');
                loginBtn.disabled = false;
                btnText.textContent = 'ë¡œê·¸ì¸';
            }
        }

        // ë¡œê·¸ì¸ ì„±ê³µ ì²˜ë¦¬
        async function loginSuccess(user) {
            currentUser = user;
            
            // UI ì—…ë°ì´íŠ¸
            document.getElementById('currentUserName').textContent = user.name;
            document.getElementById('currentUserRole').textContent = getRoleDisplayName(user.role);
            
            // ê¶Œí•œì— ë”°ë¥¸ ë©”ë‰´ í‘œì‹œ
            const usersMenuBtn = document.getElementById('usersMenuBtn');
            const requestsMenuBtn = document.getElementById('requestsMenuBtn');
            
            if (SessionManager.hasRole('manager')) {
                usersMenuBtn.classList.remove('hidden');
                requestsMenuBtn.classList.remove('hidden');
            } else {
                usersMenuBtn.classList.add('hidden');
                requestsMenuBtn.classList.add('hidden');
            }

            // í™”ë©´ ì „í™˜
            document.getElementById('initialLoading').classList.add('hidden');
            document.getElementById('loginContainer').classList.add('hidden');
            document.getElementById('mainContainer').style.display = 'block';

            Utils.debugLog('ë¡œê·¸ì¸ ì„±ê³µ:', user.name);
        }

        // ë¡œê·¸ì•„ì›ƒ
        function logout() {
            if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                try {
                    // ì„¸ì…˜ ì´ˆê¸°í™”
                    SessionManager.clearSession();
                    currentUser = null;
                    
                    // ì—°ê²° ëª¨ë‹ˆí„°ë§ ì¤‘ì§€
                    if (connectionCheckInterval) {
                        clearInterval(connectionCheckInterval);
                        connectionCheckInterval = null;
                    }
                    
                    // ë°ì´í„° ì´ˆê¸°í™”
                    currentCallsData = [];
                    currentUsersData = [];
                    currentRequestsData = [];
                    currentProcessingCall = null;
                    
                    // ì •ë ¬ ìƒíƒœ ì´ˆê¸°í™”
                    currentSort = {
                        column: 'startTime',
                        direction: 'desc'
                    };
                    
                    // ë¡œê·¸ì¸ í™”ë©´ìœ¼ë¡œ ì´ë™
                    showLoginScreen();
                    Utils.debugLog('ë¡œê·¸ì•„ì›ƒ ì™„ë£Œ');
                    
                } catch (error) {
                    Utils.debugLog('ë¡œê·¸ì•„ì›ƒ ì¤‘ ì˜¤ë¥˜:', error);
                    // ì˜¤ë¥˜ê°€ ë°œìƒí•´ë„ ê°•ì œë¡œ ë¡œê·¸ì¸ í™”ë©´ìœ¼ë¡œ ì´ë™
                    showLoginScreen();
                }
            }
        }

        // ë¡œê·¸ì¸ í™”ë©´ í‘œì‹œ
        function showLoginScreen() {
            document.getElementById('initialLoading').classList.add('hidden');
            document.getElementById('loginContainer').classList.remove('hidden');
            document.getElementById('mainContainer').style.display = 'none';
            
            // í¼ ì´ˆê¸°í™”
            document.getElementById('loginForm').reset();
            hideAlert('loginError');
        }

        // ì„¹ì…˜ í‘œì‹œ
        function showSection(sectionName) {
            // ëª¨ë“  ì„¹ì…˜ ìˆ¨ê¸°ê¸°
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            // ëª¨ë“  ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ ë¹„í™œì„±í™”
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // ì„ íƒëœ ì„¹ì…˜ í‘œì‹œ
            document.getElementById(sectionName + 'Section').classList.add('active');
            
            // ì„ íƒëœ ë²„íŠ¼ í™œì„±í™”
            event.target.classList.add('active');

            // ì„¹ì…˜ë³„ ì´ˆê¸° ë¡œë”©
            if (sectionName === 'users' && SessionManager.hasRole('manager')) {
                loadUsersSection();
            } else if (sectionName === 'requests' && SessionManager.hasRole('manager')) {
                loadRequestsSection();
            }
        }

        // Missing Call ì¡°íšŒ
        async function searchCalls() {
            const searchDate = document.getElementById('searchDate').value;
            const processFilter = document.getElementById('processFilter').value;
            const queueFilter = document.getElementById('queueFilter').value;
            
            if (!searchDate || searchDate.trim() === '') {
                alert('ğŸ“… ì¡°íšŒí•  ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            if (!searchDate.match(/^\d{4}-\d{2}-\d{2}$/)) {
                alert('âš ï¸ ì˜¬ë°”ë¥¸ ë‚ ì§œ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤. YYYY-MM-DD í˜•ì‹ìœ¼ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            try {
                showLoading('loadingMessage');
                hideElement('callsResults');
                hideElement('noDataMessage');
                
                Utils.debugLog('Missing Call ì¡°íšŒ ì‹œì‘:', { date: searchDate, processFilter, queueFilter });
                
                const result = await GoogleAppsScriptAPI.getCalls({ date: searchDate });
                
                Utils.debugLog('Apps Script ì‘ë‹µ:', result);
                
                let data = [];
                if (result.success) {
                    data = processCallData(result.calls || []);
                    
                    // ì²˜ë¦¬ ìƒíƒœ í•„í„° ì ìš©
                    if (processFilter !== 'all') {
                        data = data.filter(call => {
                            const status = call.processStatus ? call.processStatus.trim() : '';
                            
                            switch (processFilter) {
                                case 'processed':
                                    return status && status !== '' && status !== 'ë³´ë¥˜' && status !== 'ì¬ì‹œë„';
                                case 'pending':
                                    return !status || status === '';
                                case 'onhold':
                                    return status === 'ë³´ë¥˜';
                                case 'retry':
                                    return status === 'ì¬ì‹œë„' || status === 'ì¬ì‹œë„ í•„ìš”';
                                default:
                                    return true;
                            }
                        });
                    }
                    
                    // ì¸ì…í í•„í„° ì ìš©
                    if (queueFilter !== 'all') {
                        data = data.filter(call => call.queue === queueFilter);
                    }
                } else {
                    throw new Error(result.error || 'ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                }
                
                currentCallsData = data;
                
                if (data.length > 0) {
                    displayCallsResults(data);
                    showElement('callsResults');
                } else {
                    // í•„í„°ì— ë”°ë¥¸ ë©”ì‹œì§€ ë³€ê²½
                    const noDataTitle = document.getElementById('noDataTitle');
                    const noDataSubtitle = document.getElementById('noDataSubtitle');
                    
                    let filterDesc = '';
                    if (processFilter !== 'all') {
                        const filterNames = {
                            'processed': 'ì²˜ë¦¬ ì™„ë£Œëœ',
                            'pending': 'ë¯¸ì²˜ë¦¬',
                            'onhold': 'ë³´ë¥˜ ìƒíƒœì˜',
                            'retry': 'ì¬ì‹œë„ í•„ìš”í•œ'
                        };
                        filterDesc += filterNames[processFilter] + ' ';
                    }
                    
                    if (queueFilter !== 'all') {
                        const queueName = queueFilter.replace('íˆ¬ì–´ë¹„ìŠ¤-í•­ê³µ ', '');
                        filterDesc += `${queueName} `;
                    }
                    
                    noDataTitle.textContent = `ğŸ“­ ${filterDesc}ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤`;
                    noDataSubtitle.textContent = 'ë‹¤ë¥¸ ë‚ ì§œë¥¼ ì„ íƒí•˜ê±°ë‚˜ í•„í„° ì¡°ê±´ì„ ë³€ê²½í•´ë³´ì„¸ìš”.';
                    
                    showElement('noDataMessage');
                }
                
                hideLoading('loadingMessage');
                
            } catch (error) {
                Utils.debugLog('ì¡°íšŒ ì˜¤ë¥˜:', error);
                hideLoading('loadingMessage');
                alert('âŒ ë°ì´í„° ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        // ì½œ ë°ì´í„° ì²˜ë¦¬
        function processCallData(rawCalls) {
            const groups = {};
            
            // ì „í™”ë²ˆí˜¸ë³„ë¡œ ê·¸ë£¹í•‘
            rawCalls.forEach((call, index) => {
                const phoneNumber = call.phoneNumber;
                if (!groups[phoneNumber]) {
                    groups[phoneNumber] = [];
                }
                groups[phoneNumber].push({...call, originalIndex: index});
            });

            const processedData = [];

            Object.keys(groups).forEach(phoneNumber => {
                const calls = groups[phoneNumber];
                
                // ì‹œê°„ ì •ë ¬
                calls.sort((a, b) => {
                    try {
                        const timeStrA = Utils.createSortableTimeString(a.date, a.startTime);
                        const timeStrB = Utils.createSortableTimeString(b.date, b.startTime);
                        return timeStrA.localeCompare(timeStrB);
                    } catch (error) {
                        Utils.debugLog('ì‹œê°„ ì •ë ¬ ì˜¤ë¥˜:', error);
                        return 0;
                    }
                });

                // OBì½œ ì²˜ë¦¬ê°€ ëœ ì½œë“¤ì„ ê¸°ì¤€ìœ¼ë¡œ ê·¸ë£¹ ë¶„ë¦¬
                let currentGroup = [];
                
                for (let i = 0; i < calls.length; i++) {
                    const call = calls[i];
                    currentGroup.push(call);
                    
                    // ë‹¤ìŒ ì½œì´ ìˆê³ , í˜„ì¬ ì½œì´ ì²˜ë¦¬ë˜ì—ˆìœ¼ë©°, ë‹¤ìŒ ì½œì´ ì²˜ë¦¬ë˜ì§€ ì•Šì•˜ë‹¤ë©´ ê·¸ë£¹ ì¢…ë£Œ
                    if (i < calls.length - 1) {
                        const nextCall = calls[i + 1];
                        if (call.processStatus && !nextCall.processStatus) {
                            // í˜„ì¬ ê·¸ë£¹ ì²˜ë¦¬
                            if (currentGroup.length > 0) {
                                const latestCall = currentGroup[currentGroup.length - 1];
                                processedData.push({
                                    ...latestCall,
                                    callCount: currentGroup.length,
                                    groupCalls: currentGroup.map(c => ({...c}))
                                });
                            }
                            currentGroup = [];
                        }
                    }
                }
                
                // ë§ˆì§€ë§‰ ê·¸ë£¹ ì²˜ë¦¬
                if (currentGroup.length > 0) {
                    const latestCall = currentGroup[currentGroup.length - 1];
                    processedData.push({
                        ...latestCall,
                        callCount: currentGroup.length,
                        groupCalls: currentGroup.map(c => ({...c}))
                    });
                }
            });

            Utils.debugLog('processCallData ì™„ë£Œ:', {
                rawCount: rawCalls.length,
                processedCount: processedData.length
            });

            return processedData;
        }

        // ì½œ ë°ì´í„° ê²°ê³¼ í‘œì‹œ (ê¸°ë³¸ ì •ë ¬ ì ìš©)
        function displayCallsResults(data) {
            // ê¸°ë³¸ ì •ë ¬ ìƒíƒœ ì„¤ì • (ì¸ì…ì‹œê°„ ë‚´ë¦¼ì°¨ìˆœ)
            currentSort = {
                column: 'startTime',
                direction: 'desc'
            };
            
            // ê¸°ë³¸ ì •ë ¬ ì ìš©
            const sortedData = [...data].sort((a, b) => {
                const timeStrA = Utils.createSortableTimeString(a.date, a.startTime);
                const timeStrB = Utils.createSortableTimeString(b.date, b.startTime);
                return timeStrB.localeCompare(timeStrA); // ë‚´ë¦¼ì°¨ìˆœ (ëŠ¦ì€ ì‹œê°„ë¶€í„°)
            });
            
            // ì •ë ¬ í™”ì‚´í‘œ ì—…ë°ì´íŠ¸
            updateSortArrows();
            
            // ì‹¤ì œ í…Œì´ë¸” í‘œì‹œ
            displayCallsResultsWithData(sortedData);
        }

        // ì½œ ë°ì´í„° ê²°ê³¼ í‘œì‹œ (ìˆœë²ˆ ì¶”ê°€ëœ ë²„ì „)
        function displayCallsResultsWithData(data) {
            const countDiv = document.getElementById('resultsCount');
            const tbody = document.querySelector('#callsTable tbody');
            const processFilter = document.getElementById('processFilter').value;
            const queueFilter = document.getElementById('queueFilter').value;
            
            // í•„í„° ìƒíƒœì— ë”°ë¥¸ ì œëª© ë³€ê²½
            let filterText = '';
            if (processFilter !== 'all') {
                const filterNames = {
                    'processed': 'ì²˜ë¦¬ ì™„ë£Œ',
                    'pending': 'ë¯¸ì²˜ë¦¬',
                    'onhold': 'ë³´ë¥˜',
                    'retry': 'ì¬ì‹œë„ í•„ìš”'
                };
                filterText += ` (${filterNames[processFilter]})`;
            }
            
            if (queueFilter !== 'all') {
                const queueName = queueFilter.replace('íˆ¬ì–´ë¹„ìŠ¤-í•­ê³µ ', '');
                filterText += ` (${queueName})`;
            }

            countDiv.textContent = `ğŸ“Š ì¡°íšŒ ê²°ê³¼: ${data.length}ê±´${filterText}`;
            tbody.innerHTML = '';

            // ê¸€ë¡œë²Œ í…Œì´ë¸” ë°ì´í„° ì €ì¥ (ëª¨ë‹¬ì—ì„œ ì‚¬ìš©)
            window.currentTableData = data;
            Utils.debugLog('í…Œì´ë¸” ë°ì´í„° ì €ì¥ë¨:', { 
                dataLength: data.length, 
                sampleData: data.slice(0, 2) 
            });

            data.forEach((call, index) => {
                const row = tbody.insertRow();
                const waitMinutes = Math.round(call.duration / 60);
                
                // ì²˜ë¦¬ ìƒíƒœì— ë”°ë¥¸ ìŠ¤íƒ€ì¼ê³¼ í…ìŠ¤íŠ¸ ê²°ì •
                let statusClass = 'status-pending';
                let statusText = 'â³ ë¯¸ì²˜ë¦¬';
                let actionText = 'ğŸ“ ì²˜ë¦¬';
                
                if (call.processStatus && call.processStatus.trim() !== '') {
                    actionText = 'âœï¸ ìˆ˜ì •';
                    
                    switch (call.processStatus.trim()) {
                        case 'ì™„ë£Œ':
                            statusClass = 'status-processed';
                            statusText = 'âœ… ì™„ë£Œ';
                            break;
                        case 'ë¯¸ì™„ë£Œ':
                            statusClass = 'status-rejected';
                            statusText = 'âŒ ë¯¸ì™„ë£Œ';
                            break;
                        case 'ë³´ë¥˜':
                            statusClass = 'status-pending';
                            statusText = 'â¸ï¸ ë³´ë¥˜';
                            break;
                        case 'ì¬ì‹œë„':
                            statusClass = 'status-warning';
                            statusText = 'ğŸ”„ ì¬ì‹œë„';
                            break;
                        default:
                            statusClass = 'status-processed';
                            statusText = 'âœ… ' + call.processStatus;
                    }
                }
                
                // í–‰ì— ë°ì´í„° ì§ì ‘ ì €ì¥ (ê°€ì¥ ì•ˆì „í•œ ë°©ë²•)
                row.callData = call;
                row.setAttribute('data-table-index', index);
                
                // ìˆœë²ˆ ì¹¼ëŸ¼ ì¶”ê°€
                row.innerHTML = `
                    <td class="sequence-number">${index + 1}</td>
                    <td>${Utils.formatDateOnly(call.date)}</td>
                    <td class="time-display">${Utils.formatTimeOnly(call.startTime)}</td>
                    <td class="time-display">${waitMinutes}ë¶„</td>
                    <td class="phone-number">${call.phoneNumber}</td>
                    <td>${call.queue}</td>
                    <td><span class="call-count">${call.callCount}ë²ˆ</span></td>
                    <td>
                        <span class="status-badge ${statusClass}">
                            ${statusText}
                        </span>
                    </td>
                    <td>${call.processManager || '-'}</td>
                    <td>
                        <button class="btn btn-primary btn-small" onclick="openProcessModal(${index})">
                            ${actionText}
                        </button>
                    </td>
                `;
            });
        }

        // CSV ë‚´ë³´ë‚´ê¸° (ìˆœë²ˆ ì¶”ê°€)
        function exportToCSV() {
            if (currentCallsData.length === 0) {
                alert('ğŸ“­ ë‚´ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const headers = ['ìˆœë²ˆ', 'ë°œìƒì¼', 'ì¸ì…ì‹œê°„', 'ëŒ€ê¸°ì‹œê°„(ë¶„)', 'ì „í™”ë²ˆí˜¸', 'ì¸ì…í', 'ì¤‘ë³µíšŸìˆ˜', 'ì²˜ë¦¬ìƒíƒœ', 'ì²˜ë¦¬ë‹´ë‹¹ì'];
            const csvContent = [
                headers.join(','),
                ...currentCallsData.map((call, index) => [
                    index + 1,
                    Utils.formatDateOnly(call.date),
                    Utils.formatTimeOnly(call.startTime),
                    Math.round(call.duration / 60),
                    call.phoneNumber,
                    `"${call.queue}"`,
                    call.callCount,
                    call.processStatus || 'ë¯¸ì²˜ë¦¬',
                    call.processManager || ''
                ].join(','))
            ].join('\n');

            const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `missing_calls_${document.getElementById('searchDate').value}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // ì‚¬ìš©ì ê´€ë¦¬ ì„¹ì…˜ ë¡œë”©
        async function loadUsersSection() {
            if (!SessionManager.hasRole('manager')) {
                alert('âŒ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            try {
                showLoading('usersLoading');
                
                const result = await GoogleAppsScriptAPI.getUsers();
                
                if (result.success) {
                    currentUsersData = result.users.filter(u => u.status === 'approved') || [];
                    displayUsersResults(currentUsersData);
                } else {
                    throw new Error(result.error || 'ì‚¬ìš©ì ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                }
                
                hideLoading('usersLoading');
                
            } catch (error) {
                Utils.debugLog('ì‚¬ìš©ì ì„¹ì…˜ ë¡œë”© ì˜¤ë¥˜:', error);
                hideLoading('usersLoading');
                alert('âŒ ì‚¬ìš©ì ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        // ê³„ì • ì‹ ì²­ ê´€ë¦¬ ì„¹ì…˜ ë¡œë”©
        async function loadRequestsSection() {
            if (!SessionManager.hasRole('manager')) {
                alert('âŒ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            try {
                showLoading('requestsLoading');
                
                const result = await GoogleAppsScriptAPI.getPendingRequests();
                
                if (result.success) {
                    currentRequestsData = result.requests || [];
                    displayRequestsResults(currentRequestsData);
                } else {
                    throw new Error(result.error || 'ì‹ ì²­ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                }
                
                hideLoading('requestsLoading');
                
            } catch (error) {
                Utils.debugLog('ì‹ ì²­ ì„¹ì…˜ ë¡œë”© ì˜¤ë¥˜:', error);
                hideLoading('requestsLoading');
                alert('âŒ ì‹ ì²­ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        // ì‚¬ìš©ì ëª©ë¡ ê²°ê³¼ í‘œì‹œ
        function displayUsersResults(users) {
            const tbody = document.querySelector('#usersTable tbody');
            tbody.innerHTML = '';

            if (users.length === 0) {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td colspan="8" class="text-center" style="padding: 40px; color: #666;">
                        ğŸ‘¥ ë“±ë¡ëœ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.
                    </td>
                `;
                return;
            }

            users.forEach((user, index) => {
                const row = tbody.insertRow();
                const statusClass = user.status === 'approved' ? 'status-processed' : 'status-pending';
                const statusText = user.status === 'approved' ? 'âœ… í™œì„±' : 'â³ ëŒ€ê¸°ì¤‘';
                
                row.innerHTML = `
                    <td class="phone-number">${user.username}</td>
                    <td>${user.name}</td>
                    <td>${user.email}</td>
                    <td><span class="status-badge status-${user.role}">${getRoleDisplayName(user.role)}</span></td>
                    <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                    <td class="time-display">${Utils.formatDateOnly(user.createdAt) || '-'}</td>
                    <td class="time-display">${Utils.formatKoreanDateTime(user.lastLogin) || '-'}</td>
                    <td style="white-space: nowrap;">
                        <button class="btn btn-primary btn-small" onclick="editUser(${index})" style="margin-right: 5px;">âœï¸ ìˆ˜ì •</button>
                        ${user.username !== currentUser.username ? 
                            `<button class="btn btn-danger btn-small" onclick="deleteUser(${index})">ğŸ—‘ï¸ ì‚­ì œ</button>` : 
                            '<span class="text-small">í˜„ì¬ ì‚¬ìš©ì</span>'
                        }
                    </td>
                `;
            });
        }

        // ê³„ì • ì‹ ì²­ ëª©ë¡ ê²°ê³¼ í‘œì‹œ
        function displayRequestsResults(requests) {
            const tbody = document.querySelector('#requestsTable tbody');
            const noRequestsMsg = document.getElementById('noRequestsMessage');
            
            tbody.innerHTML = '';

            if (requests.length === 0) {
                showElement('noRequestsMessage');
                return;
            }

            hideElement('noRequestsMessage');

            requests.forEach((request, index) => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td class="time-display">${Utils.formatKoreanDateTime(request.requestDate)}</td>
                    <td>${request.name}</td>
                    <td>${request.email}</td>
                    <td>${request.phone}</td>
                    <td>${request.department}</td>
                    <td><span class="status-badge status-${request.role}">${getRoleDisplayName(request.role)}</span></td>
                    <td class="phone-number">${request.requestedUsername || 'ìë™ ìƒì„±'}</td>
                    <td><span class="status-badge status-pending">â³ ëŒ€ê¸°ì¤‘</span></td>
                    <td style="white-space: nowrap;">
                        <button class="btn btn-success btn-small" onclick="openApprovalModal(${index})" style="margin-right: 5px;">
                            âœ… ìŠ¹ì¸
                        </button>
                        <button class="btn btn-danger btn-small" onclick="rejectRequest(${index})">
                            âŒ ê±°ë¶€
                        </button>
                    </td>
                `;
            });
        }

        // ê¶Œí•œ í‘œì‹œëª… ë°˜í™˜
        function getRoleDisplayName(role) {
            const roleNames = {
                'admin': 'ì‹œìŠ¤í…œ ê´€ë¦¬ì',
                'manager': 'ê´€ë¦¬ì', 
                'user': 'ì¼ë°˜ ì‚¬ìš©ì'
            };
            return roleNames[role] || role;
        }

        // OBì½œ ì²˜ë¦¬ ëª¨ë‹¬ ì—´ê¸° (ìˆœë²ˆ ê³ ë ¤í•œ ì•ˆì „í•œ ë²„ì „)
        function openProcessModal(tableIndex) {
            Utils.debugLog('=== openProcessModal ì‹œì‘ ===');
            Utils.debugLog('ìš”ì²­ëœ í…Œì´ë¸” ì¸ë±ìŠ¤:', tableIndex);
            
            try {
                // ë°©ë²• 1: ê¸€ë¡œë²Œ í…Œì´ë¸” ë°ì´í„°ì—ì„œ ê°€ì ¸ì˜¤ê¸°
                if (window.currentTableData && window.currentTableData[tableIndex]) {
                    const call = window.currentTableData[tableIndex];
                    Utils.debugLog('ë°©ë²• 1 ì„±ê³µ - ê¸€ë¡œë²Œ í…Œì´ë¸” ë°ì´í„°:', call);
                    setupModalWithCall(call, tableIndex);
                    return;
                }
                
                // ë°©ë²• 2: í…Œì´ë¸” í–‰ì—ì„œ ì§ì ‘ ê°€ì ¸ì˜¤ê¸°
                const tableBody = document.querySelector('#callsTable tbody');
                const rows = tableBody.querySelectorAll('tr');
                
                if (tableIndex >= 0 && tableIndex < rows.length) {
                    const row = rows[tableIndex];
                    
                    // í–‰ì— ì €ì¥ëœ ë°ì´í„° í™•ì¸
                    if (row.callData) {
                        Utils.debugLog('ë°©ë²• 2 ì„±ê³µ - í–‰ ë°ì´í„°:', row.callData);
                        setupModalWithCall(row.callData, tableIndex);
                        return;
                    }
                }
                
                // ë°©ë²• 3: currentCallsDataì—ì„œ ê²€ìƒ‰ (ìˆœë²ˆ ì¹¼ëŸ¼ ê³ ë ¤)
                Utils.debugLog('ë°©ë²• 3 ì‹œë„ - currentCallsData ê²€ìƒ‰');
                Utils.debugLog('currentCallsData ê¸¸ì´:', currentCallsData ? currentCallsData.length : 'null/undefined');
                
                if (currentCallsData && currentCallsData.length > 0) {
                    // í…Œì´ë¸”ì—ì„œ ì „í™”ë²ˆí˜¸ ì¶”ì¶œ (ìˆœë²ˆ ì¶”ê°€ë¡œ ì¸í•´ ì¸ë±ìŠ¤ ì¡°ì •)
                    const phoneCell = rows[tableIndex]?.querySelectorAll('td')[4]; // ì „í™”ë²ˆí˜¸ëŠ” 5ë²ˆì§¸ ì¹¼ëŸ¼
                    const timeCell = rows[tableIndex]?.querySelectorAll('td')[2];  // ì¸ì…ì‹œê°„ì€ 3ë²ˆì§¸ ì¹¼ëŸ¼
                    
                    if (phoneCell && timeCell) {
                        const phoneNumber = phoneCell.textContent.trim();
                        const timeText = timeCell.textContent.trim();
                        
                        Utils.debugLog('í…Œì´ë¸”ì—ì„œ ì¶”ì¶œí•œ ì •ë³´:', { phoneNumber, timeText });
                        
                        // ì‹œê°„ í˜•ì‹ìœ¼ë¡œ ê²€ìƒ‰
                        const foundCall = currentCallsData.find(c => {
                            const callTime = Utils.formatTimeOnly(c.startTime);
                            return c.phoneNumber === phoneNumber && callTime === timeText;
                        });
                        
                        if (foundCall) {
                            Utils.debugLog('ë°©ë²• 3 ì„±ê³µ - ê²€ìƒ‰ìœ¼ë¡œ ì°¾ìŒ:', foundCall);
                            setupModalWithCall(foundCall, tableIndex);
                            return;
                        }
                    }
                }
                
                // ëª¨ë“  ë°©ë²• ì‹¤íŒ¨
                Utils.debugLog('=== ëª¨ë“  ë°©ë²• ì‹¤íŒ¨ ===');
                Utils.debugLog('currentTableData:', window.currentTableData);
                Utils.debugLog('currentCallsData:', currentCallsData);
                Utils.debugLog('í…Œì´ë¸” í–‰ ìˆ˜:', rows ? rows.length : 'null');
                
                alert('âŒ ì²˜ë¦¬í•  ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\ní˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                
            } catch (error) {
                Utils.debugLog('openProcessModal ì˜¤ë¥˜:', error);
                alert('âŒ ëª¨ë‹¬ ì—´ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }
        
        // ëª¨ë‹¬ ì„¤ì • ê³µí†µ í•¨ìˆ˜
        function setupModalWithCall(call, tableIndex) {
            Utils.debugLog('ëª¨ë‹¬ ì„¤ì • ì‹œì‘:', { call, tableIndex });
            
            currentProcessingCall = { 
                ...call, 
                tableIndex: tableIndex,
                phoneNumber: call.phoneNumber,
                startTime: call.startTime
            };

            Utils.debugLog('currentProcessingCall ì„¤ì • ì™„ë£Œ:', currentProcessingCall);

            document.getElementById('modalPhoneNumber').textContent = call.phoneNumber;
            document.getElementById('modalCallInfo').textContent = 
                `${call.callCount > 1 ? call.callCount + 'ë²ˆ ì¤‘ë³µ | ' : ''}${call.queue} | ${Math.round(call.duration / 60)}ë¶„ ëŒ€ê¸°`;
            
            document.getElementById('processStatus').value = call.processStatus || '';
            document.getElementById('processManager').value = call.processManager || (currentUser ? currentUser.name : '');
            document.getElementById('processNote').value = '';

            hideAlert('processModalError');
            document.getElementById('processModal').classList.add('show');
            
            // ì²˜ë¦¬ ìƒíƒœì— í¬ì»¤ìŠ¤
            setTimeout(() => {
                if (!call.processStatus) {
                    document.getElementById('processStatus').focus();
                } else {
                    document.getElementById('processManager').focus();
                }
            }, 100);
            
            Utils.debugLog('ëª¨ë‹¬ ì„¤ì • ì™„ë£Œ');
        }

        // OBì½œ ì²˜ë¦¬ ëª¨ë‹¬ ë‹«ê¸°
        function closeProcessModal() {
            closeModal('processModal');
            currentProcessingCall = null;
            hideAlert('processModalError');
        }

        // OBì½œ ì²˜ë¦¬ ì €ì¥ (ê°œì„ ëœ ì•ˆì „ ë²„ì „)
        async function saveProcess() {
            const processStatus = document.getElementById('processStatus').value;
            const processManager = document.getElementById('processManager').value.trim();
            const processNote = document.getElementById('processNote').value.trim();

            if (!processStatus || !processManager) {
                showAlert('processModalError', 'ì²˜ë¦¬ ìƒíƒœì™€ ë‹´ë‹¹ìë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            try {
                // ë²„íŠ¼ ìƒíƒœ ë³€ê²½
                const saveBtn = document.querySelector('#processModal .btn-success');
                const btnText = document.getElementById('processSaveBtnText');
                saveBtn.disabled = true;
                btnText.textContent = 'ì €ì¥ ì¤‘...';

                Utils.debugLog('ì €ì¥ ì‹œì‘:', currentProcessingCall);

                if (!currentProcessingCall) {
                    throw new Error('ì²˜ë¦¬í•  ì½œ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
                }

                // ì„œë²„ ì—…ë°ì´íŠ¸ (rowIndexê°€ ìˆëŠ” ê²½ìš°ì—ë§Œ)
                if (currentProcessingCall.rowIndex) {
                    const callsToUpdate = currentProcessingCall.groupCalls || [currentProcessingCall];
                    
                    for (const call of callsToUpdate) {
                        const updateData = {
                            rowIndex: call.rowIndex,
                            processStatus: processStatus,
                            processManager: processManager,
                            processNote: processNote
                        };
                        
                        Utils.debugLog('ì„œë²„ ì—…ë°ì´íŠ¸ ë°ì´í„°:', updateData);
                        
                        const result = await GoogleAppsScriptAPI.updateCall(updateData);
                        
                        if (!result.success) {
                            throw new Error(result.error || 'ì„œë²„ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨');
                        }
                    }
                }

                // ë¡œì»¬ ë°ì´í„° ì—…ë°ì´íŠ¸
                updateLocalData(currentProcessingCall, processStatus, processManager);

                // í…Œì´ë¸” í–‰ ì¦‰ì‹œ ì—…ë°ì´íŠ¸
                updateTableRow(currentProcessingCall.tableIndex, processStatus, processManager);

                closeProcessModal();
                
                // ì„±ê³µ ë©”ì‹œì§€
                Utils.showToast(`âœ… ${currentProcessingCall.phoneNumber} ì €ì¥ ì™„ë£Œ (${processStatus})`, 'success');

            } catch (error) {
                Utils.debugLog('ì €ì¥ ì˜¤ë¥˜:', error);
                showAlert('processModalError', 'ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
            } finally {
                // ë²„íŠ¼ ë³µì›
                const saveBtn = document.querySelector('#processModal .btn-success');
                const btnText = document.getElementById('processSaveBtnText');
                saveBtn.disabled = false;
                btnText.textContent = 'ğŸ’¾ ì €ì¥';
            }
        }

        // ë¡œì»¬ ë°ì´í„° ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateLocalData(processingCall, processStatus, processManager) {
            try {
                // 1. currentCallsData ì—…ë°ì´íŠ¸
                if (currentCallsData && currentCallsData.length > 0) {
                    const callToUpdate = currentCallsData.find(c => 
                        c.phoneNumber === processingCall.phoneNumber && 
                        c.startTime === processingCall.startTime
                    );
                    
                    if (callToUpdate) {
                        callToUpdate.processStatus = processStatus;
                        callToUpdate.processManager = processManager;
                        Utils.debugLog('currentCallsData ì—…ë°ì´íŠ¸ ì™„ë£Œ');
                    }
                }

                // 2. currentTableData ì—…ë°ì´íŠ¸
                if (window.currentTableData && window.currentTableData[processingCall.tableIndex]) {
                    window.currentTableData[processingCall.tableIndex].processStatus = processStatus;
                    window.currentTableData[processingCall.tableIndex].processManager = processManager;
                    Utils.debugLog('currentTableData ì—…ë°ì´íŠ¸ ì™„ë£Œ');
                }

                // 3. í…Œì´ë¸” í–‰ ë°ì´í„° ì—…ë°ì´íŠ¸
                const tableBody = document.querySelector('#callsTable tbody');
                const rows = tableBody.querySelectorAll('tr');
                if (rows[processingCall.tableIndex] && rows[processingCall.tableIndex].callData) {
                    rows[processingCall.tableIndex].callData.processStatus = processStatus;
                    rows[processingCall.tableIndex].callData.processManager = processManager;
                    Utils.debugLog('í…Œì´ë¸” í–‰ ë°ì´í„° ì—…ë°ì´íŠ¸ ì™„ë£Œ');
                }
                
            } catch (error) {
                Utils.debugLog('ë¡œì»¬ ë°ì´í„° ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
            }
        }

        // ì²˜ë¦¬ í›„ ë‹¤ìŒ ë¯¸ì²˜ë¦¬ ê±´ìœ¼ë¡œ ì´ë™
        async function saveAndNext() {
            const processStatus = document.getElementById('processStatus').value;
            const processManager = document.getElementById('processManager').value.trim();

            if (!processStatus || !processManager) {
                showAlert('processModalError', 'ì²˜ë¦¬ ìƒíƒœì™€ ë‹´ë‹¹ìë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            try {
                // í˜„ì¬ ì²˜ë¦¬ ì €ì¥
                const saveBtn = document.querySelector('#processModal .btn-primary');
                const btnText = saveBtn.textContent;
                
                saveBtn.disabled = true;
                saveBtn.textContent = 'â³ ì €ì¥ ì¤‘...';

                // í˜„ì¬ ì½œ ì²˜ë¦¬
                const currentIndex = currentProcessingCall.tableIndex;
                const callsToUpdate = currentProcessingCall.groupCalls || [currentProcessingCall];

                for (const call of callsToUpdate) {
                    if (!call.rowIndex) {
                        if (currentProcessingCall.rowIndex) {
                            call.rowIndex = currentProcessingCall.rowIndex;
                        } else {
                            throw new Error('rowIndexê°€ ì—†ìŠµë‹ˆë‹¤.');
                        }
                    }

                    const updateData = {
                        rowIndex: parseInt(call.rowIndex),
                        processStatus: processStatus,
                        processManager: processManager,
                        processNote: document.getElementById('processNote').value.trim()
                    };

                    const result = await GoogleAppsScriptAPI.updateCall(updateData);
                    if (!result.success) {
                        throw new Error(result.error || 'ì—…ë°ì´íŠ¸ ì‹¤íŒ¨');
                    }
                }

                // í…Œì´ë¸” í–‰ ì—…ë°ì´íŠ¸
                updateTableRow(currentIndex, processStatus, processManager);

                // ë‹¤ìŒ ë¯¸ì²˜ë¦¬ ê±´ ì°¾ê¸° (currentTableDataì—ì„œ)
                let nextIndex = -1;
                if (window.currentTableData && window.currentTableData.length > 0) {
                    for (let i = currentIndex + 1; i < window.currentTableData.length; i++) {
                        if (!window.currentTableData[i].processStatus || window.currentTableData[i].processStatus.trim() === '') {
                            nextIndex = i;
                            break;
                        }
                    }

                    // ë‹¤ìŒ ê±´ì´ ì—†ìœ¼ë©´ ì²˜ìŒë¶€í„° ë‹¤ì‹œ ì°¾ê¸°
                    if (nextIndex === -1) {
                        for (let i = 0; i < currentIndex; i++) {
                            if (!window.currentTableData[i].processStatus || window.currentTableData[i].processStatus.trim() === '') {
                                nextIndex = i;
                                break;
                            }
                        }
                    }
                }

                if (nextIndex !== -1) {
                    // ë‹¤ìŒ ë¯¸ì²˜ë¦¬ ê±´ìœ¼ë¡œ ëª¨ë‹¬ ì „í™˜
                    Utils.showToast(`âœ… ${currentProcessingCall.phoneNumber} ì €ì¥ ì™„ë£Œ`, 'success');
                    
                    // ì ì‹œ ëŒ€ê¸° í›„ ë‹¤ìŒ ê±´ ì—´ê¸°
                    setTimeout(() => {
                        openProcessModal(nextIndex);
                        
                        // í…Œì´ë¸”ì—ì„œ í•´ë‹¹ í–‰ìœ¼ë¡œ ìŠ¤í¬ë¡¤
                        const tableBody = document.querySelector('#callsTable tbody');
                        const targetRow = tableBody.querySelectorAll('tr')[nextIndex];
                        if (targetRow) {
                            targetRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            // í–‰ í•˜ì´ë¼ì´íŠ¸
                            targetRow.style.backgroundColor = '#fef3c7';
                            setTimeout(() => {
                                targetRow.style.backgroundColor = '';
                            }, 2000);
                        }
                    }, 500);
                } else {
                    // ë” ì´ìƒ ë¯¸ì²˜ë¦¬ ê±´ì´ ì—†ìŒ
                    closeProcessModal();
                    Utils.showToast(`âœ… ${currentProcessingCall.phoneNumber} ì €ì¥ ì™„ë£Œ - ë¯¸ì²˜ë¦¬ ê±´ì´ ë” ì—†ìŠµë‹ˆë‹¤`, 'success');
                    alert('ğŸ‰ ëª¨ë“  ê±´ì´ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
                }

            } catch (error) {
                Utils.debugLog('ì €ì¥ í›„ ë‹¤ìŒ ì˜¤ë¥˜:', error);
                showAlert('processModalError', 'ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
            } finally {
                // ë²„íŠ¼ ë³µì›
                const saveBtn = document.querySelector('#processModal .btn-primary');
                saveBtn.disabled = false;
                saveBtn.textContent = 'â© ì €ì¥ í›„ ë‹¤ìŒ';
            }
        }

        // í…Œì´ë¸” íŠ¹ì • í–‰ ì—…ë°ì´íŠ¸ (ìˆœë²ˆ ì¹¼ëŸ¼ ê³ ë ¤)
        function updateTableRow(tableIndex, processStatus, processManager) {
            try {
                const tableBody = document.querySelector('#callsTable tbody');
                const rows = tableBody.querySelectorAll('tr');
                
                if (rows[tableIndex]) {
                    const row = rows[tableIndex];
                    const cells = row.querySelectorAll('td');
                    
                    // ì²˜ë¦¬ ìƒíƒœì— ë”°ë¥¸ ìŠ¤íƒ€ì¼ê³¼ í…ìŠ¤íŠ¸ ê²°ì •
                    let statusClass = 'status-pending';
                    let statusText = 'â³ ë¯¸ì²˜ë¦¬';
                    let actionText = 'ğŸ“ ì²˜ë¦¬';
                    
                    if (processStatus && processStatus.trim() !== '') {
                        actionText = 'âœï¸ ìˆ˜ì •';
                        
                        switch (processStatus.trim()) {
                            case 'ì™„ë£Œ':
                                statusClass = 'status-processed';
                                statusText = 'âœ… ì™„ë£Œ';
                                break;
                            case 'ë¯¸ì™„ë£Œ':
                                statusClass = 'status-rejected';
                                statusText = 'âŒ ë¯¸ì™„ë£Œ';
                                break;
                            case 'ë³´ë¥˜':
                                statusClass = 'status-pending';
                                statusText = 'â¸ï¸ ë³´ë¥˜';
                                break;
                            case 'ì¬ì‹œë„':
                                statusClass = 'status-warning';
                                statusText = 'ğŸ”„ ì¬ì‹œë„';
                                break;
                            default:
                                statusClass = 'status-processed';
                                statusText = 'âœ… ' + processStatus;
                        }
                    }
                    
                    // ìˆœë²ˆ ì¹¼ëŸ¼ ì¶”ê°€ë¡œ ì¸í•œ ì¸ë±ìŠ¤ ì¡°ì •
                    // ì²˜ë¦¬ìƒíƒœ ì¹¼ëŸ¼ ì—…ë°ì´íŠ¸ (8ë²ˆì§¸ ì¹¼ëŸ¼, ì¸ë±ìŠ¤ 7)
                    if (cells[7]) {
                        cells[7].innerHTML = `
                            <span class="status-badge ${statusClass}">
                                ${statusText}
                            </span>
                        `;
                    }
                    
                    // ì²˜ë¦¬ë‹´ë‹¹ì ì¹¼ëŸ¼ ì—…ë°ì´íŠ¸ (9ë²ˆì§¸ ì¹¼ëŸ¼, ì¸ë±ìŠ¤ 8)
                    if (cells[8]) {
                        cells[8].textContent = processManager;
                    }
                    
                    // ì•¡ì…˜ ë²„íŠ¼ ì—…ë°ì´íŠ¸ (10ë²ˆì§¸ ì¹¼ëŸ¼, ì¸ë±ìŠ¤ 9)
                    if (cells[9]) {
                        cells[9].innerHTML = `
                            <button class="btn btn-primary btn-small" onclick="openProcessModal(${tableIndex})">
                                ${actionText}
                            </button>
                        `;
                    }
                    
                    // í–‰ í•˜ì´ë¼ì´íŠ¸ íš¨ê³¼ (ì¼ì‹œì )
                    row.style.backgroundColor = '#d1fae5';
                    setTimeout(() => {
                        row.style.backgroundColor = '';
                    }, 2000);
                    
                    Utils.debugLog('í…Œì´ë¸” í–‰ ì¦‰ì‹œ ì—…ë°ì´íŠ¸ ì™„ë£Œ:', { tableIndex, processStatus, processManager });
                }
                
            } catch (error) {
                Utils.debugLog('í…Œì´ë¸” í–‰ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
            }
        }

        // ì‚¬ìš©ì ëª¨ë‹¬ ì—´ê¸°
        function openUserModal(user = null) {
            const isEdit = !!user;
            
            document.getElementById('userModalTitle').textContent = isEdit ? 'âœï¸ ì‚¬ìš©ì ìˆ˜ì •' : 'â• ì‚¬ìš©ì ì¶”ê°€';
            
            if (isEdit) {
                document.getElementById('userId').value = user.id;
                document.getElementById('userUsername').value = user.username;
                document.getElementById('userUsername').disabled = true;
                document.getElementById('userPassword').required = false;
                document.getElementById('userPassword').placeholder = 'ë³€ê²½í•˜ì§€ ì•Šìœ¼ë ¤ë©´ ë¹„ì›Œë‘ì„¸ìš”';
                document.getElementById('userName').value = user.name;
                document.getElementById('userEmail').value = user.email;
                document.getElementById('userRole').value = user.role;
            } else {
                document.getElementById('userForm').reset();
                document.getElementById('userUsername').disabled = false;
                document.getElementById('userPassword').required = true;
                document.getElementById('userPassword').placeholder = '6ì ì´ìƒ ì…ë ¥í•˜ì„¸ìš”';
            }

            hideAlert('userModalError');
            document.getElementById('userModal').classList.add('show');
            
            // ì²« ë²ˆì§¸ ì…ë ¥ í•„ë“œì— í¬ì»¤ìŠ¤
            setTimeout(() => {
                if (!isEdit) {
                    document.getElementById('userUsername').focus();
                } else {
                    document.getElementById('userName').focus();
                }
            }, 100);
        }

        // ì‚¬ìš©ì ëª¨ë‹¬ ë‹«ê¸°
        function closeUserModal() {
            closeModal('userModal');
        }

        // ì‚¬ìš©ì ìˆ˜ì •
        function editUser(index) {
            const user = currentUsersData[index];
            openUserModal(user);
        }

        // ì‚¬ìš©ì ì‚­ì œ
        async function deleteUser(index) {
            const user = currentUsersData[index];
            
            if (confirm(`âš ï¸ ì‚¬ìš©ì '${user.name}'ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) {
                try {
                    const result = await GoogleAppsScriptAPI.deleteUser(user.id);

                    if (result.success) {
                        await loadUsersSection();
                        alert('âœ… ì‚¬ìš©ìê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    } else {
                        alert('âŒ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + result.error);
                    }
                } catch (error) {
                    Utils.debugLog('ì‚¬ìš©ì ì‚­ì œ ì˜¤ë¥˜:', error);
                    alert('âŒ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                }
            }
        }

        // ì‚¬ìš©ì ì €ì¥
        async function saveUser() {
            const userId = document.getElementById('userId').value;
            const username = document.getElementById('userUsername').value.trim();
            const password = document.getElementById('userPassword').value;
            const name = document.getElementById('userName').value.trim();
            const email = document.getElementById('userEmail').value.trim();
            const role = document.getElementById('userRole').value;

            // ìœ íš¨ì„± ê²€ì‚¬
            if (!username || !name || !email || !role) {
                showAlert('userModalError', 'í•„ìˆ˜ í•­ëª©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            if (!Utils.isValidEmail(email)) {
                showAlert('userModalError', 'ì˜¬ë°”ë¥¸ ì´ë©”ì¼ ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            if (!userId && !password) {
                showAlert('userModalError', 'ìƒˆ ì‚¬ìš©ìëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ í•„ìš”í•©ë‹ˆë‹¤.', 'error');
                return;
            }

            if (password) {
                const passwordValidation = Utils.isValidPassword(password);
                if (!passwordValidation.valid) {
                    showAlert('userModalError', passwordValidation.message, 'error');
                    return;
                }
            }

            try {
                const isEdit = !!userId;
                
                // ë²„íŠ¼ ìƒíƒœ ë³€ê²½
                const saveBtn = document.querySelector('#userModal .btn-success');
                const btnText = document.getElementById('userSaveBtnText');
                saveBtn.disabled = true;
                btnText.textContent = 'ì €ì¥ ì¤‘...';
                
                const userData = {
                    id: userId || Utils.generateUUID(),
                    username: username,
                    name: name,
                    email: email,
                    role: role,
                    status: 'approved',
                    createdAt: isEdit ? null : Utils.getCurrentDateTime(),
                    lastLogin: isEdit ? null : null
                };

                // ë¹„ë°€ë²ˆí˜¸ê°€ ìˆìœ¼ë©´ í•´ì‹œ ì²˜ë¦¬
                if (password) {
                    userData.passwordHash = Utils.simpleHash(password, username);
                }

                let result;
                if (isEdit) {
                    result = await GoogleAppsScriptAPI.updateUser(userId, userData);
                } else {
                    result = await GoogleAppsScriptAPI.addUser(userData);
                }

                if (result.success) {
                    await loadUsersSection();
                    closeUserModal();
                    
                    alert(`âœ… ${isEdit ? 'ì‚¬ìš©ìê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ì‚¬ìš©ìê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.'}`);
                } else {
                    showAlert('userModalError', result.error || 'ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                }

            } catch (error) {
                Utils.debugLog('ì‚¬ìš©ì ì €ì¥ ì˜¤ë¥˜:', error);
                showAlert('userModalError', 'ì‚¬ìš©ì ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
            } finally {
                // ë²„íŠ¼ ë³µì›
                const saveBtn = document.querySelector('#userModal .btn-success');
                const btnText = document.getElementById('userSaveBtnText');
                saveBtn.disabled = false;
                btnText.textContent = 'ğŸ’¾ ì €ì¥';
            }
        }

        // ê³„ì • ì‹ ì²­ ìŠ¹ì¸ ëª¨ë‹¬ ì—´ê¸°
        function openApprovalModal(index) {
            const request = currentRequestsData[index];
            
            document.getElementById('approvalRequestId').value = request.id;
            document.getElementById('approvalRequestName').textContent = request.name;
            document.getElementById('approvalRequestInfo').textContent = 
                `${request.email} | ${request.department} | ${getRoleDisplayName(request.role)}`;
            
            // í¬ë§ ì‚¬ìš©ì IDê°€ ìˆìœ¼ë©´ ë¯¸ë¦¬ ì±„ì›Œë„£ê¸°
            document.getElementById('approvalUsername').value = request.requestedUsername || '';
            document.getElementById('approvalPassword').value = '';
            document.getElementById('approvalNote').value = '';

            hideAlert('approvalModalError');
            document.getElementById('approvalModal').classList.add('show');
            
            setTimeout(() => {
                const usernameField = document.getElementById('approvalUsername');
                if (usernameField.value) {
                    document.getElementById('approvalPassword').focus();
                } else {
                    usernameField.focus();
                }
            }, 100);
        }

        // ìŠ¹ì¸ ëª¨ë‹¬ ë‹«ê¸°
        function closeApprovalModal() {
            closeModal('approvalModal');
            hideAlert('approvalModalError');
        }

        // ê³„ì • ì‹ ì²­ ìŠ¹ì¸ ì²˜ë¦¬
        async function approveAccountRequest() {
            const requestId = document.getElementById('approvalRequestId').value;
            const username = document.getElementById('approvalUsername').value.trim();
            const password = document.getElementById('approvalPassword').value;
            const note = document.getElementById('approvalNote').value.trim();

            if (!username || !password) {
                showAlert('approvalModalError', 'ì‚¬ìš©ì IDì™€ ì„ì‹œ ë¹„ë°€ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            const passwordValidation = Utils.isValidPassword(password);
            if (!passwordValidation.valid) {
                showAlert('approvalModalError', passwordValidation.message, 'error');
                return;
            }

            try {
                // ë²„íŠ¼ ìƒíƒœ ë³€ê²½
                const approveBtn = document.querySelector('#approvalModal .btn-success');
                const btnText = document.getElementById('approvalSaveBtnText');
                approveBtn.disabled = true;
                btnText.textContent = 'ìŠ¹ì¸ ì²˜ë¦¬ ì¤‘...';

                const approvalData = {
                    username: username,
                    password: password,
                    note: note
                };

                const result = await GoogleAppsScriptAPI.approveRequest(requestId, approvalData);

                if (result.success) {
                    closeApprovalModal();
                    await loadRequestsSection(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                    
                    alert(`âœ… ê³„ì •ì´ ìŠ¹ì¸ë˜ì–´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!\n\nğŸ‘¤ ì‚¬ìš©ì: ${result.user.name}\nğŸ†” ì‚¬ìš©ì ID: ${result.user.username}\nğŸ“§ ì´ë©”ì¼: ${result.user.email}\n\nğŸ’¡ ìƒì„±ëœ ì„ì‹œ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì‚¬ìš©ìì—ê²Œ ì „ë‹¬í•´ì£¼ì„¸ìš”.`);
                } else {
                    showAlert('approvalModalError', result.error || 'ìŠ¹ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                }

            } catch (error) {
                Utils.debugLog('ìŠ¹ì¸ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
                showAlert('approvalModalError', 'ìŠ¹ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
            } finally {
                // ë²„íŠ¼ ë³µì›
                const approveBtn = document.querySelector('#approvalModal .btn-success');
                const btnText = document.getElementById('approvalSaveBtnText');
                approveBtn.disabled = false;
                btnText.textContent = 'âœ… ìŠ¹ì¸ ë° ê³„ì • ìƒì„±';
            }
        }

        // ê³„ì • ì‹ ì²­ ê±°ë¶€
        async function rejectRequest(index) {
            const request = currentRequestsData[index];
            
            const reason = prompt(`âš ï¸ ê³„ì • ì‹ ì²­ì„ ê±°ë¶€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì‹ ì²­ì: ${request.name}\nì´ë©”ì¼: ${request.email}\n\nê±°ë¶€ ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš” (ì„ íƒì‚¬í•­):`);
            
            if (reason === null) return; // ì·¨ì†Œí•œ ê²½ìš°

            try {
                const result = await GoogleAppsScriptAPI.rejectRequest(request.id, reason);

                if (result.success) {
                    await loadRequestsSection(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                    alert(`âŒ ê³„ì • ì‹ ì²­ì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤.\n\nì‹ ì²­ì: ${request.name}\nì‚¬ìœ : ${reason || 'ì‚¬ìœ  ì—†ìŒ'}`);
                } else {
                    alert('âŒ ê±°ë¶€ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + result.error);
                }

            } catch (error) {
                Utils.debugLog('ê±°ë¶€ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
                alert('âŒ ê±°ë¶€ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        // ê³„ì • ì‹ ì²­ ëª¨ë‹¬ ì—´ê¸°
        function openAccountRequestModal() {
            document.getElementById('accountRequestForm').reset();
            hideAlert('accountRequestError');
            hideAlert('accountRequestSuccess');
            document.getElementById('accountRequestModal').classList.add('show');
            
            // ì²« ë²ˆì§¸ ì…ë ¥ í•„ë“œì— í¬ì»¤ìŠ¤
            setTimeout(() => {
                document.getElementById('requestName').focus();
            }, 100);
        }

        // ê³„ì • ì‹ ì²­ ëª¨ë‹¬ ë‹«ê¸°
        function closeAccountRequestModal() {
            closeModal('accountRequestModal');
        }

        // ê³„ì • ì‹ ì²­ì„œ ì œì¶œ
        async function submitAccountRequest() {
            const formData = {
                name: document.getElementById('requestName').value.trim(),
                email: document.getElementById('requestEmail').value.trim(),
                phone: document.getElementById('requestPhone').value.trim(),
                department: document.getElementById('requestDepartment').value.trim(),
                position: document.getElementById('requestPosition').value.trim(),
                role: document.getElementById('requestRole').value,
                reason: document.getElementById('requestReason').value.trim(),
                userId: document.getElementById('requestUserId').value.trim()
            };

            // ìœ íš¨ì„± ê²€ì‚¬
            if (!formData.name || !formData.email || !formData.phone || 
                !formData.department || !formData.role || !formData.reason) {
                showAlert('accountRequestError', 'í•„ìˆ˜ í•­ëª©(*)ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            if (!Utils.isValidEmail(formData.email)) {
                showAlert('accountRequestError', 'ì˜¬ë°”ë¥¸ ì´ë©”ì¼ ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            // ì „í™”ë²ˆí˜¸ í˜•ì‹ ê°„ë‹¨ ì²´í¬
            const phoneRegex = /^[\d\-\+\(\)\s]{10,}$/;
            if (!phoneRegex.test(formData.phone)) {
                showAlert('accountRequestError', 'ì˜¬ë°”ë¥¸ ì „í™”ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            try {
                // ë²„íŠ¼ ìƒíƒœ ë³€ê²½
                const submitBtn = document.querySelector('#accountRequestModal .btn-primary');
                const btnText = document.getElementById('accountRequestBtnText');
                submitBtn.disabled = true;
                btnText.textContent = 'ğŸ“§ ì œì¶œ ì¤‘...';

                // í˜„ì¬ ë‚ ì§œ/ì‹œê°„ ì¶”ê°€
                formData.requestDate = new Date().toLocaleString('ko-KR');
                
                const result = await GoogleAppsScriptAPI.submitAccountRequest(formData);

                if (result.success) {
                    showAlert('accountRequestSuccess', 
                        'âœ… ê³„ì • ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!\nê´€ë¦¬ì ê²€í†  í›„ ìŠ¹ì¸ë©ë‹ˆë‹¤.', 'success');
                    
                    // 3ì´ˆ í›„ ëª¨ë‹¬ ë‹«ê¸°
                    setTimeout(() => {
                        closeAccountRequestModal();
                    }, 3000);
                } else {
                    throw new Error(result.error || 'ì‹ ì²­ì„œ ì œì¶œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }

            } catch (error) {
                Utils.debugLog('ê³„ì • ì‹ ì²­ ì˜¤ë¥˜:', error);
                showAlert('accountRequestError', `ì œì¶œ ì‹¤íŒ¨: ${error.message}`, 'error');

            } finally {
                // ë²„íŠ¼ ë³µì›
                const submitBtn = document.querySelector('#accountRequestModal .btn-primary');
                const btnText = document.getElementById('accountRequestBtnText');
                submitBtn.disabled = false;
                btnText.textContent = 'ğŸ“§ ì‹ ì²­ì„œ ì œì¶œ';
            }
        }

        // ë¹„ë°€ë²ˆí˜¸ í‘œì‹œ/ìˆ¨ê¸°ê¸° í† ê¸€
        function togglePassword(inputId) {
            const input = document.getElementById(inputId);
            const button = input.nextElementSibling;
            
            if (input.type === 'password') {
                input.type = 'text';
                button.textContent = 'ğŸ™ˆ';
            } else {
                input.type = 'password';
                button.textContent = 'ğŸ‘ï¸';
            }
        }

        // ì•Œë¦¼ ë©”ì‹œì§€ í‘œì‹œ
        function showAlert(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `alert alert-${type}`;
            element.classList.remove('hidden');
            
            if (type === 'success') {
                setTimeout(() => hideAlert(elementId), CONFIG.UI.TOAST_DURATION);
            }
        }

        // ì•Œë¦¼ ë©”ì‹œì§€ ìˆ¨ê¸°ê¸°
        function hideAlert(elementId) {
            document.getElementById(elementId).classList.add('hidden');
        }

        // ìš”ì†Œ í‘œì‹œ
        function showElement(elementId) {
            document.getElementById(elementId).classList.remove('hidden');
        }

        // ìš”ì†Œ ìˆ¨ê¸°ê¸°
        function hideElement(elementId) {
            document.getElementById(elementId).classList.add('hidden');
        }

        // ëª¨ë‹¬ ë‹«ê¸°
        function closeModal(modal) {
            if (typeof modal === 'string') {
                modal = document.getElementById(modal);
            }
            modal.classList.remove('show');
        }

        // ë¡œë”© í‘œì‹œ
        function showLoading(elementId) {
            showElement(elementId);
        }

        // ë¡œë”© ìˆ¨ê¸°ê¸°
        function hideLoading(elementId) {
            hideElement(elementId);
        }
    </script>
</body>
</html>
